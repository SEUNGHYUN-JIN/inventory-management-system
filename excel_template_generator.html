<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì…ê³ ìš”ì²­ì„œ ê´€ë¦¬ì‹œìŠ¤í…œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', 'Malgun Gothic', Arial, sans-serif;
            line-height: 1.4;
            background-color: #f8f9fa;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px 30px;
            border-bottom: 4px solid #3498db;
        }
        
        .header h1 {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .header p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .form-section {
            background-color: #ffffff;
            padding: 25px 30px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .form-section h3 {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
            padding-left: 12px;
        }
        
        .controls {
            background-color: #f8f9fa;
            padding: 15px 30px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .btn {
            background-color: #495057;
            color: white;
            border: none;
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 500;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn:hover {
            background-color: #343a40;
            transform: translateY(-1px);
        }
        
        .btn-primary {
            background-color: #2980b9;
        }
        
        .btn-primary:hover {
            background-color: #1e6091;
        }
        
        .btn-success {
            background-color: #27ae60;
        }
        
        .btn-success:hover {
            background-color: #1e8449;
        }
        
        .btn-info {
            background-color: #17a2b8;
        }
        
        .btn-info:hover {
            background-color: #117a8b;
        }
        
        .btn-warning {
            background-color: #f39c12;
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #d68910;
        }
        
        .btn-danger {
            background-color: #e74c3c;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #495057;
            font-size: 13px;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 3px;
            font-size: 13px;
            background-color: white;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
        }
        
        .row {
            display: flex;
            gap: 20px;
        }
        
        .col {
            flex: 1;
        }
        
        .sheet-tabs {
            background-color: #f8f9fa;
            display: flex;
            border-bottom: 1px solid #dee2e6;
            padding: 0 30px;
        }
        
        .sheet-tab {
            padding: 12px 20px;
            background-color: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 500;
            font-size: 13px;
            color: #495057;
            transition: all 0.2s ease;
        }
        
        .sheet-tab.active {
            color: #2980b9;
            border-bottom-color: #2980b9;
            background-color: white;
        }
        
        .sheet-tab:hover:not(.active) {
            color: #2980b9;
            background-color: #e9ecef;
        }
        
        .sheet-content {
            display: none;
            padding: 30px;
        }
        
        .sheet-content.active {
            display: block;
        }
        
        .summary-card {
            background-color: #f8f9fa;
            padding: 20px;
            border-left: 4px solid #3498db;
            margin-bottom: 25px;
            border-radius: 0 4px 4px 0;
        }
        
        .summary-card h4 {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        
        .summary-card p {
            font-size: 13px;
            color: #6c757d;
            margin-bottom: 5px;
        }
        
        .editable-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .editable-table th {
            background-color: #f1f3f4;
            color: #495057;
            font-weight: 600;
            padding: 12px 8px;
            text-align: center;
            border: 1px solid #dee2e6;
            font-size: 12px;
        }
        
        .editable-table td {
            padding: 10px 8px;
            border: 1px solid #dee2e6;
            text-align: center;
            vertical-align: middle;
        }
        
        .editable-table td:nth-child(2),
        .editable-table td:nth-child(3) {
            text-align: left;
            padding-left: 12px;
        }
        
        .editable-table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .editable-input {
            width: 100%;
            border: none;
            background: transparent;
            padding: 4px 6px;
            text-align: center;
            font-size: 12px;
            border-radius: 2px;
        }
        
        .editable-input:focus {
            background-color: #fff3cd;
            border: 1px solid #ffc107;
            outline: none;
        }
        
        .calculated-cell {
            background-color: #e8f4f8;
            font-weight: 500;
        }
        
        .negative-value {
            background-color: #fde8e8;
            color: #c53030;
            font-weight: 600;
        }
        
        .group-header {
            background-color: #e3f2fd !important;
            font-weight: 600 !important;
            color: #1565c0 !important;
        }
        
        .status {
            margin: 15px 30px;
            padding: 12px 16px;
            border-radius: 4px;
            display: none;
            font-size: 13px;
        }
        
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .history-filters {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        
        .history-filters label {
            font-weight: 500;
            color: #495057;
            font-size: 13px;
        }
        
        .history-filters input {
            padding: 6px 10px;
            border: 1px solid #ced4da;
            border-radius: 3px;
            font-size: 12px;
        }
        
        .print-header, .print-info, .print-footer {
            display: none;
        }
        
        @media print {
            body {
                background-color: white !important;
                padding: 0 !important;
                margin: 0 !important;
            }
            
            .container {
                box-shadow: none !important;
                padding: 10px !important;
                margin: 0 !important;
                max-width: none !important;
            }
            
            .header, .form-section, .controls, .sheet-tabs, .status, .summary-card, .history-filters {
                display: none !important;
            }
            
            .sheet-content {
                display: block !important;
                border: none !important;
                padding: 0 !important;
            }
            
            .sheet-content:not(.print-target) {
                display: none !important;
            }
            
            .print-header {
                display: block !important;
                text-align: center;
                margin-bottom: 20px;
                font-size: 18px;
                font-weight: bold;
                color: #000;
            }
            
            .print-info {
                display: block !important;
                margin-bottom: 15px;
                font-size: 12px;
                color: #000;
            }
            
            .print-footer {
                display: block !important;
                text-align: right;
                margin-top: 30px;
                font-size: 12px;
                color: #000;
            }
            
            .editable-table {
                font-size: 10px !important;
            }
            
            .editable-table th, .editable-table td {
                padding: 4px !important;
                border: 1px solid #000 !important;
            }
            
            .btn {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ì…ê³ ìš”ì²­ì„œ ê´€ë¦¬ì‹œìŠ¤í…œ</h1>
            <p>Inventory Request Management System v2.01</p>
            <p style="font-size: 12px; opacity: 0.8; margin-top: 5px;">ì‘ì„±ì¼: <span id="current-date"></span></p>
        </div>
        
        <div class="form-section">
            <h3>ê¸°ë³¸ ì •ë³´ ì„¤ì •</h3>
            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <label for="targetFacility">ëŒ€ìƒ ìƒì‚°ì‹œì„¤</label>
                        <select id="targetFacility" onchange="filterByFacility()">
                            <option value="">ì „ì²´ ì‹œì„¤</option>
                            <option value="ë™ì›ì§ì—…ì¬í™œì›">ë™ì›ì§ì—…ì¬í™œì›</option>
                            <option value="í•™ì‚°ë³´í˜¸ì‘ì—…ì¥">í•™ì‚°ë³´í˜¸ì‘ì—…ì¥</option>
                            <option value="ëˆ„ë¦¬ë´„">ëˆ„ë¦¬ë´„</option>
                        </select>
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label for="facilityName">ìš”ì²­ ê¸°ê´€ëª…</label>
                        <input type="text" id="facilityName" value="ê²½ìƒë‚¨ë„ ì¥ì• ì¸ìƒì‚°í’ˆíŒë§¤ì‹œì„¤">
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label for="requestDate">ì…ê³ ìš”ì²­ì¼</label>
                        <input type="date" id="requestDate">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <button class="btn btn-primary" onclick="addRequestHistory()">ì…ê³  ìš”ì²­ ë“±ë¡</button>
            <button class="btn btn-info" onclick="printCurrentSheet()">í˜„ì¬ ì‹œíŠ¸ ì¸ì‡„</button>
            <button class="btn btn-info" onclick="printRequestForm()">ì…ê³ ìš”ì²­ì„œ ì¸ì‡„</button>
            <button class="btn btn-info" onclick="previewPrint()">ì¸ì‡„ ë¯¸ë¦¬ë³´ê¸°</button>
            <button class="btn btn-success" onclick="exportToExcel()">ì—‘ì…€ë¡œ ë‚´ë³´ë‚´ê¸°</button>
            <button class="btn btn-warning" onclick="clearAllData()">ë°ì´í„° ì´ˆê¸°í™”</button>
            <button class="btn btn-danger" onclick="resetToDefault()">ê¸°ë³¸ê°’ ë¦¬ì…‹</button>
        </div>
        
        <div id="status" class="status"></div>
        
        <div class="sheet-tabs">
            <div class="sheet-tab active" onclick="showSheet('ë³´ê´€í’ˆ')">ë³´ê´€í’ˆ í˜„í™©</div>
            <div class="sheet-tab" onclick="showSheet('ì…ê³ ìš”ì²­ì„œ')">ì…ê³ ìš”ì²­ì„œ</div>
            <div class="sheet-tab" onclick="showSheet('ì…ê³ ì´ë ¥')">ì…ê³ ì´ë ¥</div>
        </div>
        
        <!-- ë³´ê´€í’ˆ ì‹œíŠ¸ -->
        <div id="sheet-ë³´ê´€í’ˆ" class="sheet-content active">
            <div class="print-header">ë³´ê´€í’ˆ í˜„í™©í‘œ</div>
            <div class="print-info">
                <div>ì‘ì„±ì¼: <span id="print-date-inventory"></span></div>
                <div>ì‘ì„±ê¸°ê´€: <span id="print-org-inventory"></span></div>
            </div>
            
            <div class="summary-card">
                <h4>ë³´ê´€í’ˆ í˜„í™©</h4>
                <p>í˜„ì¬ ë³´ê´€ ì¤‘ì¸ í’ˆëª©ë“¤ì˜ ê¸°ë³¸ ì •ë³´ì…ë‹ˆë‹¤.</p>
            </div>
            
            <table class="editable-table">
                <thead>
                    <tr>
                        <th style="width: 25%;">ìƒì‚°ì‹œì„¤</th>
                        <th style="width: 30%;">í’ˆëª©</th>
                        <th style="width: 25%;">ê·œê²©</th>
                        <th style="width: 10%;">ìˆ˜ëŸ‰</th>
                        <th style="width: 10%;">ë‹¨ìœ„</th>
                    </tr>
                </thead>
                <tbody id="inventory-tbody">
                </tbody>
            </table>
            
            <div class="print-footer">
                <div>ë‹´ë‹¹ì: _______________</div>
            </div>
        </div>
        
        <!-- ì…ê³ ìš”ì²­ì„œ ì‹œíŠ¸ -->
        <div id="sheet-ì…ê³ ìš”ì²­ì„œ" class="sheet-content">
            <div class="print-header">ì…ê³ ìš”ì²­ì„œ</div>
            <div class="print-info">
                <div>ìƒì‚°ì‹œì„¤: <span id="print-facility-request"></span></div>
                <div>ì…ê³ ìš”ì²­ì¼: <span id="print-date-request"></span></div>
                <div>ìš”ì²­ê¸°ê´€: <span id="print-org-request"></span></div>
            </div>
            
            <div class="summary-card">
                <h4>ì…ê³ ìš”ì²­ì„œ ì‘ì„±</h4>
                <p><strong>ì”ëŸ‰ = ì´ˆê¸°ìˆ˜ëŸ‰ - ì…ê³ ìˆ˜ëŸ‰</strong> | ì…ê³ ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ë©´ ì”ëŸ‰ì´ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤.</p>
                <p id="facilityFilter">í˜„ì¬ í‘œì‹œ: <strong>ì „ì²´ ìƒì‚°ì‹œì„¤</strong></p>
            </div>
            
            <table class="editable-table">
                <thead>
                    <tr>
                        <th style="width: 6%;">No</th>
                        <th style="width: 16%;">ìƒì‚°ì‹œì„¤</th>
                        <th style="width: 18%;">í’ˆëª©</th>
                        <th style="width: 16%;">ê·œê²©</th>
                        <th style="width: 10%;">ì´ˆê¸°ìˆ˜ëŸ‰</th>
                        <th style="width: 11%;">ì…ê³ ìˆ˜ëŸ‰</th>
                        <th style="width: 11%;">ì”ëŸ‰</th>
                        <th style="width: 12%;">ì‘ì„±ì¼ì‹œ</th>
                    </tr>
                </thead>
                <tbody id="request-tbody">
                </tbody>
            </table>
            
            <div class="print-footer">
                <div>ë‹´ë‹¹ì: _______________</div>
            </div>
        </div>
        
        <!-- ì…ê³ ì´ë ¥ ì‹œíŠ¸ -->
        <div id="sheet-ì…ê³ ì´ë ¥" class="sheet-content">
            <div class="print-header">ì…ê³ ì´ë ¥ ê´€ë¦¬ëŒ€ì¥</div>
            <div class="print-info">
                <div>ì¶œë ¥ì¼: <span id="print-date-history"></span></div>
                <div>ê´€ë¦¬ê¸°ê´€: <span id="print-org-history"></span></div>
            </div>
            
            <div class="summary-card">
                <h4>ì…ê³ ì´ë ¥ ê´€ë¦¬</h4>
                <p>ë“±ë¡ëœ ì…ê³  ìš”ì²­ë“¤ì˜ ì „ì²´ ì´ë ¥ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
            
            <div class="history-filters">
                <label>ê¸°ê°„ í•„í„°:</label>
                <input type="date" id="filterStartDate">
                <span>~</span>
                <input type="date" id="filterEndDate">
                <button class="btn" onclick="filterHistory()">í•„í„° ì ìš©</button>
                <button class="btn btn-warning" onclick="clearFilter()">í•„í„° í•´ì œ</button>
            </div>
            
            <table class="editable-table">
                <thead>
                    <tr>
                        <th style="width: 5%;">No</th>
                        <th style="width: 10%;">ì…ê³ ì¼</th>
                        <th style="width: 13%;">ìƒì‚°ì‹œì„¤</th>
                        <th style="width: 13%;">ìš”ì²­ê¸°ê´€</th>
                        <th style="width: 16%;">í’ˆëª©</th>
                        <th style="width: 8%;">ì…ê³ ìˆ˜ëŸ‰</th>
                        <th style="width: 8%;">ì´ˆê¸°ìˆ˜ëŸ‰</th>
                        <th style="width: 8%;">ì”ëŸ‰</th>
                        <th style="width: 11%;">ë“±ë¡ì¼ì‹œ</th>
                        <th style="width: 8%;">ì‘ì—…</th>
                    </tr>
                </thead>
                <tbody id="history-tbody">
                </tbody>
            </table>
            
            <div class="print-footer">
                <div>ë‹´ë‹¹ì: _______________</div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // ê¸°ë³¸ ë³´ê´€í’ˆ ë°ì´í„°
        let inventoryData = [
            {
                í’ˆëª©: "ì ë³´ë¡¤í™”ì¥ì§€/ì²œì—°í„í”„(ë™ì›)",
                ê·œê²©: "250M*2ê²¹*16ë¡¤",
                ìˆ˜ëŸ‰: 100,
                ë‹¨ìœ„: "ë°•ìŠ¤",
                ìƒì‚°ì‹œì„¤: "ë™ì›ì§ì—…ì¬í™œì›"
            },
            {
                í’ˆëª©: "ë¡¤í™”ì¥ì§€(ë™ì›)", 
                ê·œê²©: "3ê²¹/35m*30ë¡¤",
                ìˆ˜ëŸ‰: 300,
                ë‹¨ìœ„: "íŒ©",
                ìƒì‚°ì‹œì„¤: "ë™ì›ì§ì—…ì¬í™œì›"
            },
            {
                í’ˆëª©: "ì‚¬ê°í‹°ìŠˆ 250ë§¤(ë™ì›)",
                ê·œê²©: "1ë°•ìŠ¤(24ê°œì…)",
                ìˆ˜ëŸ‰: 300,
                ë‹¨ìœ„: "ë°•ìŠ¤",
                ìƒì‚°ì‹œì„¤: "ë™ì›ì§ì—…ì¬í™œì›"
            },
            {
                í’ˆëª©: "ìƒë¶„í•´ë¬¼í‹°ìŠˆ",
                ê·œê²©: "10ê°œì…/ìº¡í˜•",
                ìˆ˜ëŸ‰: 240,
                ë‹¨ìœ„: "ë°•ìŠ¤",
                ìƒì‚°ì‹œì„¤: "í•™ì‚°ë³´í˜¸ì‘ì—…ì¥"
            },
            {
                í’ˆëª©: "í”„ë¦¬ë¯¸ì—„",
                ê·œê²©: "10ê°œì…",
                ìˆ˜ëŸ‰: 600,
                ë‹¨ìœ„: "ë°•ìŠ¤",
                ìƒì‚°ì‹œì„¤: "í•™ì‚°ë³´í˜¸ì‘ì—…ì¥"
            },
            {
                í’ˆëª©: "ì¢…ì´ì»µ",
                ê·œê²©: "6.5ì˜¨ìŠ¤",
                ìˆ˜ëŸ‰: 320,
                ë‹¨ìœ„: "ë°•ìŠ¤",
                ìƒì‚°ì‹œì„¤: "ëˆ„ë¦¬ë´„"
            }
        ];

        // ì´ë ¥ ë°ì´í„° ë° ì„¤ì •
        let historyData = JSON.parse(localStorage.getItem('requestHistory') || '[]');
        let historyCounter = parseInt(localStorage.getItem('historyCounter') || '1');
        let currentFacilityFilter = '';
        
        // ì €ì¥ëœ ë³´ê´€í’ˆ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ë¶ˆëŸ¬ì˜¤ê¸°
        const savedInventoryData = localStorage.getItem('inventoryData');
        if (savedInventoryData) {
            inventoryData = JSON.parse(savedInventoryData);
        }

        // ì „ì—­ ë³€ìˆ˜ - ë§ˆì§€ë§‰ ë“±ë¡ëœ ìš”ì²­ì„œ ë°ì´í„° ì €ì¥
        let lastRegisteredRequest = null;

        // í˜„ì¬ ë‚ ì§œì‹œê°„ ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
        function getCurrentDateTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            
            return `${year}-${month}-${day} ${hours}:${minutes}`;
        }
        function getCurrentDateTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            
            return `${year}-${month}-${day} ${hours}:${minutes}`;
        }
        // í˜„ì¬ ë‚ ì§œ ì„¤ì •
        function setCurrentDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            
            // ì…ê³ ìš”ì²­ì¼ í•„ë“œ ì„¤ì •
            document.getElementById('requestDate').value = `${year}-${month}-${day}`;
            
            // í—¤ë”ì— í˜„ì¬ ë‚ ì§œ í‘œì‹œ
            const koreanDate = `${year}ë…„ ${month}ì›” ${day}ì¼`;
            document.getElementById('current-date').textContent = koreanDate;
        }

        // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        }

        // ì‹œíŠ¸ íƒ­ ì „í™˜
        function showSheet(sheetName) {
            document.querySelectorAll('.sheet-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.sheet-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`sheet-${sheetName}`).classList.add('active');
        }

        // ìƒì‚°ì‹œì„¤ë³„ í•„í„°ë§
        function filterByFacility() {
            currentFacilityFilter = document.getElementById('targetFacility').value;
            renderRequestTable();
            updateFacilityFilterDisplay();
        }

        // í•„í„° í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateFacilityFilterDisplay() {
            const filterDisplay = document.getElementById('facilityFilter');
            if (currentFacilityFilter) {
                filterDisplay.innerHTML = `í˜„ì¬ í‘œì‹œ: <strong>${currentFacilityFilter}</strong>`;
            } else {
                filterDisplay.innerHTML = `í˜„ì¬ í‘œì‹œ: <strong>ì „ì²´ ìƒì‚°ì‹œì„¤</strong>`;
            }
        }

        // ë³´ê´€í’ˆ í…Œì´ë¸” ë Œë”ë§
        function renderInventoryTable() {
            const tbody = document.getElementById('inventory-tbody');
            tbody.innerHTML = '';
            
            const groupedData = inventoryData.reduce((groups, item) => {
                const facility = item.ìƒì‚°ì‹œì„¤;
                if (!groups[facility]) {
                    groups[facility] = [];
                }
                groups[facility].push(item);
                return groups;
            }, {});

            Object.keys(groupedData).sort().forEach(facility => {
                const headerRow = document.createElement('tr');
                headerRow.classList.add('group-header');
                headerRow.innerHTML = `
                    <td colspan="5" style="text-align: center; padding: 10px;">${facility}</td>
                `;
                tbody.appendChild(headerRow);

                groupedData[facility].forEach((item, index) => {
                    const globalIndex = inventoryData.indexOf(item);
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.ìƒì‚°ì‹œì„¤}</td>
                        <td>${item.í’ˆëª©}</td>
                        <td>${item.ê·œê²©}</td>
                        <td>
                            <input type="number" class="editable-input" value="${item.ìˆ˜ëŸ‰}" 
                                   onchange="updateInventoryQuantity(${globalIndex}, this.value)" style="text-align: center;">
                        </td>
                        <td>${item.ë‹¨ìœ„}</td>
                    `;
                    tbody.appendChild(row);
                });
            });
        }

        // ì…ê³ ìš”ì²­ì„œ í…Œì´ë¸” ë Œë”ë§
        function renderRequestTable() {
            const tbody = document.getElementById('request-tbody');
            tbody.innerHTML = '';
            
            const filteredData = currentFacilityFilter 
                ? inventoryData.filter(item => item.ìƒì‚°ì‹œì„¤ === currentFacilityFilter)
                : inventoryData;

            if (filteredData.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="7" style="text-align: center; color: #666;">ì„ íƒëœ ìƒì‚°ì‹œì„¤ì— í’ˆëª©ì´ ì—†ìŠµë‹ˆë‹¤.</td>';
                tbody.appendChild(row);
                return;
            }

            if (!currentFacilityFilter) {
                const groupedData = filteredData.reduce((groups, item) => {
                    const facility = item.ìƒì‚°ì‹œì„¤;
                    if (!groups[facility]) {
                        groups[facility] = [];
                    }
                    groups[facility].push(item);
                    return groups;
                }, {});

                let rowCounter = 1;
                Object.keys(groupedData).sort().forEach(facility => {
                    const headerRow = document.createElement('tr');
                    headerRow.classList.add('group-header');
                    headerRow.innerHTML = `
                        <td colspan="7" style="text-align: center; padding: 8px;">${facility}</td>
                    `;
                    tbody.appendChild(headerRow);

                    groupedData[facility].forEach((item) => {
                        const globalIndex = inventoryData.indexOf(item);
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${rowCounter++}</td>
                            <td>${item.ìƒì‚°ì‹œì„¤}</td>
                            <td>${item.í’ˆëª©}</td>
                            <td>${item.ê·œê²©}</td>
                            <td class="calculated-cell">${item.ìˆ˜ëŸ‰.toLocaleString()}</td>
                            <td>
                                <input type="number" class="editable-input" placeholder="0" 
                                       id="request-${globalIndex}" onchange="calculateRemaining(${globalIndex})" style="text-align: center;">
                            </td>
                            <td id="remaining-${globalIndex}" class="calculated-cell">-</td>
                            <td style="font-size: 10px; color: #666;">${getCurrentDateTime()}</td>
                        `;
                        tbody.appendChild(row);
                    });
                });
            } else {
                filteredData.forEach((item, index) => {
                    const globalIndex = inventoryData.indexOf(item);
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${item.ìƒì‚°ì‹œì„¤}</td>
                        <td>${item.í’ˆëª©}</td>
                        <td>${item.ê·œê²©}</td>
                        <td class="calculated-cell">${item.ìˆ˜ëŸ‰.toLocaleString()}</td>
                        <td>
                            <input type="number" class="editable-input" placeholder="0" 
                                   id="request-${globalIndex}" onchange="calculateRemaining(${globalIndex})" style="text-align: center;">
                        </td>
                        <td id="remaining-${globalIndex}" class="calculated-cell">-</td>
                        <td style="font-size: 10px; color: #666;">${getCurrentDateTime()}</td>
                    `;
                    tbody.appendChild(row);
                });
            }
        }

        // ì…ê³ ì´ë ¥ í…Œì´ë¸” ë Œë”ë§
        function renderHistoryTable(dataToRender = null) {
            const tbody = document.getElementById('history-tbody');
            tbody.innerHTML = '';
            
            const data = dataToRender || historyData;
            
            data.forEach((item, index) => {
                const row = document.createElement('tr');
                const remainingClass = item.ì”ëŸ‰ < 0 ? 'negative-value' : '';
                
                row.innerHTML = `
                    <td>${item.No}</td>
                    <td>${item.ì…ê³ ì¼}</td>
                    <td>${item.ìƒì‚°ì‹œì„¤}</td>
                    <td>${item.ìš”ì²­ê¸°ê´€ || '-'}</td>
                    <td>${item.í’ˆëª©}</td>
                    <td>${item.ì…ê³ ìˆ˜ëŸ‰.toLocaleString()}</td>
                    <td>${item.ì´ˆê¸°ìˆ˜ëŸ‰.toLocaleString()}</td>
                    <td class="${remainingClass}">${item.ì”ëŸ‰.toLocaleString()}</td>
                    <td style="font-size: 10px; color: #666;">${item.ë“±ë¡ì¼ì‹œ || '-'}</td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteHistory(${item.No})" style="padding: 4px 8px; font-size: 10px;">ì‚­ì œ</button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            if (data.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="10" style="text-align: center; color: #666;">ë“±ë¡ëœ ì…ê³  ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</td>';
                tbody.appendChild(row);
            }
        }

        // ë³´ê´€í’ˆ ìˆ˜ëŸ‰ ì—…ë°ì´íŠ¸ (ìˆ˜ë™ ìˆ˜ì •)
        function updateInventoryQuantity(index, newValue) {
            const oldValue = inventoryData[index].ìˆ˜ëŸ‰;
            const newQuantity = parseInt(newValue) || 0;
            
            inventoryData[index].ìˆ˜ëŸ‰ = newQuantity;
            localStorage.setItem('inventoryData', JSON.stringify(inventoryData));
            
            // ì…ê³ ìš”ì²­ì„œì˜ ì´ˆê¸°ìˆ˜ëŸ‰ë„ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
            renderRequestTable();
            
            const item = inventoryData[index];
            showStatus(`âœ… "${item.í’ˆëª©}" ìˆ˜ëŸ‰ì´ ${oldValue} â†’ ${newQuantity}ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
            
            console.log(`ğŸ“Š ìˆ˜ëŸ‰ ì§ì ‘ ìˆ˜ì •: ${item.í’ˆëª©} (${oldValue} â†’ ${newQuantity})`);
        }

        // ì”ëŸ‰ ê³„ì‚° (ì‹¤ì‹œê°„ ê³„ì‚°)
        function calculateRemaining(index) {
            const requestInput = document.getElementById(`request-${index}`);
            const remainingCell = document.getElementById(`remaining-${index}`);
            
            if (!requestInput || !remainingCell) return;
            
            const requestQuantity = parseInt(requestInput.value) || 0;
            const currentInventoryQuantity = inventoryData[index].ìˆ˜ëŸ‰; // í˜„ì¬ ë³´ê´€í’ˆ ìˆ˜ëŸ‰ (ì´ë¯¸ ì—…ë°ì´íŠ¸ëœ ìˆ˜ëŸ‰)
            const remaining = currentInventoryQuantity - requestQuantity;
            
            remainingCell.textContent = remaining.toLocaleString();
            remainingCell.className = remaining < 0 ? 'calculated-cell negative-value' : 'calculated-cell';
            
            // ì‹¤ì‹œê°„ í”¼ë“œë°± (ìŒìˆ˜ì¼ ë•Œ ê²½ê³ )
            if (remaining < 0) {
                remainingCell.title = `âš ï¸ í˜„ì¬ ë³´ìœ ëŸ‰(${currentInventoryQuantity})ë³´ë‹¤ ${Math.abs(remaining)}ê°œ ë¶€ì¡±í•©ë‹ˆë‹¤.`;
            } else {
                remainingCell.title = `ì…ê³  í›„ ì˜ˆìƒ ì”ëŸ‰: ${remaining}`;
            }
        }

        // ì…ê³  ìš”ì²­ ë“±ë¡
        function addRequestHistory() {
            const facilityName = document.getElementById('facilityName').value;
            const requestDate = document.getElementById('requestDate').value;
            const targetFacility = document.getElementById('targetFacility').value;
            
            if (!facilityName || !requestDate) {
                showStatus('ìš”ì²­ ê¸°ê´€ëª…ê³¼ ì…ê³ ìš”ì²­ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            let hasRequests = false;
            let requestCount = 0;
            let updatedItems = [];
            let registeredItems = []; // ë“±ë¡ëœ í’ˆëª©ë“¤ ì €ì¥
            
            const dataToProcess = targetFacility 
                ? inventoryData.filter(item => item.ìƒì‚°ì‹œì„¤ === targetFacility)
                : inventoryData;

            dataToProcess.forEach((item) => {
                const globalIndex = inventoryData.indexOf(item);
                const requestInput = document.getElementById(`request-${globalIndex}`);
                const requestQuantity = parseInt(requestInput?.value) || 0;
                
                if (requestQuantity > 0) {
                    hasRequests = true;
                    requestCount++;
                    
                    const previousQuantity = item.ìˆ˜ëŸ‰; // ì…ê³  ì „ ìˆ˜ëŸ‰
                    const remaining = item.ìˆ˜ëŸ‰ - requestQuantity; // ì…ê³  í›„ ì”ëŸ‰
                    
                    const historyItem = {
                        No: historyCounter++,
                        ì…ê³ ì¼: requestDate,
                        ìƒì‚°ì‹œì„¤: item.ìƒì‚°ì‹œì„¤,
                        ìš”ì²­ê¸°ê´€: facilityName,
                        í’ˆëª©: item.í’ˆëª©,
                        ì…ê³ ìˆ˜ëŸ‰: requestQuantity,
                        ì´ˆê¸°ìˆ˜ëŸ‰: previousQuantity, // ì…ê³  ì „ ìˆ˜ëŸ‰ ì €ì¥
                        ì”ëŸ‰: remaining, // ì…ê³  í›„ ì”ëŸ‰
                        ë“±ë¡ì¼ì‹œ: getCurrentDateTime() // ì‹¤ì œ ë“±ë¡í•œ ë‚ ì§œì‹œê°„
                    };
                    
                    historyData.push(historyItem);
                    
                    // í•µì‹¬: ë³´ê´€í’ˆ í˜„í™©ì˜ ìˆ˜ëŸ‰ì„ ì”ëŸ‰ìœ¼ë¡œ ì—…ë°ì´íŠ¸
                    inventoryData[globalIndex].ìˆ˜ëŸ‰ = remaining;
                    
                    updatedItems.push({
                        í’ˆëª©: item.í’ˆëª©,
                        ìƒì‚°ì‹œì„¤: item.ìƒì‚°ì‹œì„¤,
                        ì…ê³ ì „ìˆ˜ëŸ‰: previousQuantity,
                        ì…ê³ ìˆ˜ëŸ‰: requestQuantity,
                        ì…ê³ í›„ìˆ˜ëŸ‰: remaining
                    });

                    // ë“±ë¡ëœ ìš”ì²­ì„œ ë°ì´í„° ì €ì¥ (ì¸ì‡„ìš©)
                    registeredItems.push({
                        No: registeredItems.length + 1,
                        ìƒì‚°ì‹œì„¤: item.ìƒì‚°ì‹œì„¤,
                        í’ˆëª©: item.í’ˆëª©,
                        ê·œê²©: item.ê·œê²©,
                        ì´ˆê¸°ìˆ˜ëŸ‰: previousQuantity,
                        ì…ê³ ìˆ˜ëŸ‰: requestQuantity,
                        ì”ëŸ‰: remaining,
                        ë“±ë¡ì¼ì‹œ: getCurrentDateTime()
                    });
                    
                    // UI ì´ˆê¸°í™”
                    if (requestInput) {
                        requestInput.value = '';
                    }
                    const remainingCell = document.getElementById(`remaining-${globalIndex}`);
                    if (remainingCell) {
                        remainingCell.textContent = '-';
                        remainingCell.className = 'calculated-cell';
                    }
                }
            });

            if (!hasRequests) {
                showStatus('ì…ê³ ìˆ˜ëŸ‰ì„ 1ê°œ ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            // ë§ˆì§€ë§‰ ë“±ë¡ëœ ìš”ì²­ì„œ ë°ì´í„° ì €ì¥
            lastRegisteredRequest = {
                facilityName: facilityName,
                requestDate: requestDate,
                targetFacility: targetFacility,
                items: registeredItems
            };

            // ëª¨ë“  ë°ì´í„°ë¥¼ localStorageì— ì €ì¥
            localStorage.setItem('requestHistory', JSON.stringify(historyData));
            localStorage.setItem('historyCounter', historyCounter.toString());
            localStorage.setItem('inventoryData', JSON.stringify(inventoryData));
            
            // ëª¨ë“  í…Œì´ë¸”ì„ ìƒˆë¡œìš´ ë°ì´í„°ë¡œ ë‹¤ì‹œ ë Œë”ë§
            renderInventoryTable(); // ë³´ê´€í’ˆ í˜„í™© ì—…ë°ì´íŠ¸ (ìƒˆë¡œìš´ ìˆ˜ëŸ‰ ë°˜ì˜)
            renderRequestTable();   // ì…ê³ ìš”ì²­ì„œ ì—…ë°ì´íŠ¸ (ìƒˆë¡œìš´ ì´ˆê¸°ìˆ˜ëŸ‰ ë°˜ì˜)
            renderHistoryTable();   // ì…ê³ ì´ë ¥ ì—…ë°ì´íŠ¸ (ìƒˆ ì´ë ¥ ì¶”ê°€)
            
            // ì„±ê³µ ë©”ì‹œì§€ì™€ ì—…ë°ì´íŠ¸ ë‚´ì—­
            const facilityMsg = targetFacility ? `${targetFacility}ì˜ ` : '';
            let updateSummary = `\n\nğŸ“Š ì—…ë°ì´íŠ¸ ë‚´ì—­:\n`;
            updatedItems.forEach(item => {
                updateSummary += `â€¢ ${item.í’ˆëª©}: ${item.ì…ê³ ì „ìˆ˜ëŸ‰} â†’ ${item.ì…ê³ í›„ìˆ˜ëŸ‰} (${item.ì…ê³ ìˆ˜ëŸ‰} ì°¨ê°)\n`;
            });
            
            showStatus(`${facilityMsg}ì…ê³  ìš”ì²­ ${requestCount}ê±´ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.${updateSummary}`, 'success');
            
            console.log('ğŸ“Š ì—…ë°ì´íŠ¸ëœ í’ˆëª©ë“¤:', updatedItems);
        }

        // ì´ë ¥ ì‚­ì œ (ìˆ˜ëŸ‰ ë˜ëŒë¦¬ê¸° í¬í•¨)
        function deleteHistory(no) {
            const historyItem = historyData.find(item => item.No === no);
            if (!historyItem) return;
            
            if (confirm(`ì´ ì´ë ¥ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nğŸ“‹ ì‚­ì œ ëŒ€ìƒ:\nâ€¢ í’ˆëª©: ${historyItem.í’ˆëª©}\nâ€¢ ìƒì‚°ì‹œì„¤: ${historyItem.ìƒì‚°ì‹œì„¤}\nâ€¢ ì…ê³ ìˆ˜ëŸ‰: ${historyItem.ì…ê³ ìˆ˜ëŸ‰}\n\nâš ï¸ ì‚­ì œ ì‹œ í•´ë‹¹ í’ˆëª©ì˜ ìˆ˜ëŸ‰ì´ ${historyItem.ì…ê³ ìˆ˜ëŸ‰}ë§Œí¼ ì¦ê°€í•©ë‹ˆë‹¤.`)) {
                
                // í•´ë‹¹ í’ˆëª©ì˜ ìˆ˜ëŸ‰ì„ ì›ë˜ëŒ€ë¡œ ë˜ëŒë¦¬ê¸°
                const inventoryItem = inventoryData.find(item => 
                    item.í’ˆëª© === historyItem.í’ˆëª© && item.ìƒì‚°ì‹œì„¤ === historyItem.ìƒì‚°ì‹œì„¤
                );
                
                let restoredQuantity = 0;
                if (inventoryItem) {
                    const beforeQuantity = inventoryItem.ìˆ˜ëŸ‰;
                    inventoryItem.ìˆ˜ëŸ‰ += historyItem.ì…ê³ ìˆ˜ëŸ‰; // ì…ê³ ìˆ˜ëŸ‰ë§Œí¼ ë‹¤ì‹œ ë”í•˜ê¸°
                    restoredQuantity = inventoryItem.ìˆ˜ëŸ‰;
                    
                    console.log(`ğŸ“Š ìˆ˜ëŸ‰ ë³µì›: ${historyItem.í’ˆëª©} (${beforeQuantity} â†’ ${restoredQuantity})`);
                }
                
                // ì´ë ¥ì—ì„œ ì œê±°
                historyData = historyData.filter(item => item.No !== no);
                
                // ëª¨ë“  ë³€ê²½ì‚¬í•­ì„ localStorageì— ì €ì¥
                localStorage.setItem('requestHistory', JSON.stringify(historyData));
                localStorage.setItem('inventoryData', JSON.stringify(inventoryData));
                
                // ëª¨ë“  í…Œì´ë¸” ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ì—°ë™ëœ ë°ì´í„° ë°˜ì˜
                renderInventoryTable(); // ë³´ê´€í’ˆ í˜„í™© ì—…ë°ì´íŠ¸ (ë³µì›ëœ ìˆ˜ëŸ‰ ë°˜ì˜)
                renderRequestTable();   // ì…ê³ ìš”ì²­ì„œ ì—…ë°ì´íŠ¸ (ë³µì›ëœ ì´ˆê¸°ìˆ˜ëŸ‰ ë°˜ì˜)
                renderHistoryTable();   // ì…ê³ ì´ë ¥ ì—…ë°ì´íŠ¸ (ì‚­ì œëœ ì´ë ¥ ì œê±°)
                
                showStatus(`âœ… ì´ë ¥ì´ ì‚­ì œë˜ê³  "${historyItem.í’ˆëª©}" ìˆ˜ëŸ‰ì´ ${restoredQuantity}ë¡œ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
            }
        }

        // ì´ë ¥ í•„í„°ë§
        function filterHistory() {
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            
            if (!startDate || !endDate) {
                showStatus('ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            const filteredData = historyData.filter(item => {
                const itemDate = item.ì…ê³ ì¼;
                return itemDate >= startDate && itemDate <= endDate;
            });

            renderHistoryTable(filteredData);
            showStatus(`${filteredData.length}ê±´ì˜ ì´ë ¥ì´ í•„í„°ë§ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        }

        // í•„í„° í•´ì œ
        function clearFilter() {
            document.getElementById('filterStartDate').value = '';
            document.getElementById('filterEndDate').value = '';
            renderHistoryTable();
            showStatus('í•„í„°ê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }

        // í˜„ì¬ ì‹œíŠ¸ ì¸ì‡„
        function printCurrentSheet() {
            const activeSheet = document.querySelector('.sheet-content.active');
            if (!activeSheet) {
                showStatus('ì¸ì‡„í•  ì‹œíŠ¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            updatePrintInfo();
            document.querySelectorAll('.sheet-content').forEach(sheet => {
                sheet.classList.remove('print-target');
            });
            activeSheet.classList.add('print-target');
            window.print();
            showStatus('ì¸ì‡„ ë‹¤ì´ì–¼ë¡œê·¸ê°€ ì—´ë ¸ìŠµë‹ˆë‹¤.', 'success');
        }

        // ì…ê³ ìš”ì²­ì„œ ì „ìš© ì¸ì‡„ (ë§ˆì§€ë§‰ ë“±ë¡ëœ ë‚´ìš© ê¸°ì¤€)
        function printRequestForm() {
            // ë§ˆì§€ë§‰ ë“±ë¡ëœ ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
            if (!lastRegisteredRequest || lastRegisteredRequest.items.length === 0) {
                showStatus('ë“±ë¡ëœ ì…ê³  ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì…ê³  ìš”ì²­ì„ ë“±ë¡í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            const requestSheet = document.getElementById('sheet-ì…ê³ ìš”ì²­ì„œ');
            const originalTable = requestSheet.querySelector('.editable-table tbody');
            const originalContent = originalTable.innerHTML;
            
            // ë§ˆì§€ë§‰ ë“±ë¡ëœ ìš”ì²­ì„œ ë°ì´í„°ë¡œ í…Œì´ë¸” ìƒì„±
            originalTable.innerHTML = '';
            lastRegisteredRequest.items.forEach(item => {
                const row = document.createElement('tr');
                const remainingClass = item.ì”ëŸ‰ < 0 ? 'negative-value' : '';
                row.innerHTML = `
                    <td>${item.No}</td>
                    <td>${item.ìƒì‚°ì‹œì„¤}</td>
                    <td>${item.í’ˆëª©}</td>
                    <td>${item.ê·œê²©}</td>
                    <td>${item.ì´ˆê¸°ìˆ˜ëŸ‰.toLocaleString()}</td>
                    <td>${item.ì…ê³ ìˆ˜ëŸ‰.toLocaleString()}</td>
                    <td class="${remainingClass}">${item.ì”ëŸ‰.toLocaleString()}</td>
                    <td style="font-size: 10px;">${item.ë“±ë¡ì¼ì‹œ}</td>
                `;
                originalTable.appendChild(row);
            });

            updatePrintInfo();
            document.querySelectorAll('.sheet-content').forEach(sheet => {
                sheet.classList.remove('print-target');
            });
            requestSheet.classList.add('print-target');
            window.print();

            setTimeout(() => {
                originalTable.innerHTML = originalContent;
                requestSheet.classList.remove('print-target');
            }, 100);

            showStatus(`ë§ˆì§€ë§‰ ë“±ë¡ëœ ì…ê³ ìš”ì²­ì„œ ì¸ì‡„ (${lastRegisteredRequest.items.length}ê°œ í’ˆëª©)`, 'success');
        }

        // ì¸ì‡„ ë¯¸ë¦¬ë³´ê¸°
        function previewPrint() {
            if (!lastRegisteredRequest || lastRegisteredRequest.items.length === 0) {
                showStatus('ë“±ë¡ëœ ì…ê³  ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì…ê³  ìš”ì²­ì„ ë“±ë¡í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            // ìƒˆ ì°½ì—ì„œ ë¯¸ë¦¬ë³´ê¸° ì—´ê¸°
            const previewWindow = window.open('', '_blank', 'width=800,height=600');
            
            let previewHtml = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>ì…ê³ ìš”ì²­ì„œ ë¯¸ë¦¬ë³´ê¸°</title>
                    <style>
                        body { font-family: 'Malgun Gothic', Arial, sans-serif; padding: 20px; }
                        .header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 10px; }
                        .info { margin-bottom: 15px; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { border: 1px solid #333; padding: 8px; text-align: center; font-size: 12px; }
                        th { background-color: #f1f3f4; font-weight: bold; }
                        .negative-value { background-color: #fde8e8; color: #c53030; }
                        .footer { text-align: right; margin-top: 30px; }
                        .btn { padding: 10px 20px; margin: 5px; cursor: pointer; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h2>ì…ê³ ìš”ì²­ì„œ</h2>
                    </div>
                    <div class="info">
                        <div>ìƒì‚°ì‹œì„¤: ${lastRegisteredRequest.targetFacility || 'ì „ì²´ ìƒì‚°ì‹œì„¤'}</div>
                        <div>ì…ê³ ìš”ì²­ì¼: ${lastRegisteredRequest.requestDate}</div>
                        <div>ìš”ì²­ê¸°ê´€: ${lastRegisteredRequest.facilityName}</div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>ìƒì‚°ì‹œì„¤</th>
                                <th>í’ˆëª©</th>
                                <th>ê·œê²©</th>
                                <th>ì´ˆê¸°ìˆ˜ëŸ‰</th>
                                <th>ì…ê³ ìˆ˜ëŸ‰</th>
                                <th>ì”ëŸ‰</th>
                                <th>ë“±ë¡ì¼ì‹œ</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            lastRegisteredRequest.items.forEach(item => {
                const remainingClass = item.ì”ëŸ‰ < 0 ? 'negative-value' : '';
                previewHtml += `
                    <tr>
                        <td>${item.No}</td>
                        <td>${item.ìƒì‚°ì‹œì„¤}</td>
                        <td>${item.í’ˆëª©}</td>
                        <td>${item.ê·œê²©}</td>
                        <td>${item.ì´ˆê¸°ìˆ˜ëŸ‰.toLocaleString()}</td>
                        <td>${item.ì…ê³ ìˆ˜ëŸ‰.toLocaleString()}</td>
                        <td class="${remainingClass}">${item.ì”ëŸ‰.toLocaleString()}</td>
                        <td>${item.ë“±ë¡ì¼ì‹œ}</td>
                    </tr>
                `;
            });

            previewHtml += `
                        </tbody>
                    </table>
                    <div class="footer">
                        <div>ë‹´ë‹¹ì: _______________</div>
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn" onclick="window.print()">ì¸ì‡„í•˜ê¸°</button>
                        <button class="btn" onclick="window.close()">ë‹«ê¸°</button>
                    </div>
                </body>
                </html>
            `;

            previewWindow.document.write(previewHtml);
            previewWindow.document.close();
            showStatus('ì¸ì‡„ ë¯¸ë¦¬ë³´ê¸° ì°½ì´ ì—´ë ¸ìŠµë‹ˆë‹¤.', 'success');
        }
        // ì¸ì‡„ìš© ì •ë³´ ì—…ë°ì´íŠ¸
        function updatePrintInfo() {
            const currentDate = new Date().toLocaleDateString('ko-KR');
            const facilityName = document.getElementById('facilityName').value;
            const requestDate = document.getElementById('requestDate').value;
            const targetFacility = document.getElementById('targetFacility').value;

            document.getElementById('print-date-inventory').textContent = currentDate;
            document.getElementById('print-org-inventory').textContent = facilityName;
            document.getElementById('print-facility-request').textContent = targetFacility || 'ì „ì²´ ìƒì‚°ì‹œì„¤';
            document.getElementById('print-date-request').textContent = requestDate || currentDate;
            document.getElementById('print-org-request').textContent = facilityName;
            document.getElementById('print-date-history').textContent = currentDate;
            document.getElementById('print-org-history').textContent = facilityName;
        }

        // ì—‘ì…€ ë‚´ë³´ë‚´ê¸°
        function exportToExcel() {
            try {
                const wb = XLSX.utils.book_new();
                
                const inventoryWS = XLSX.utils.json_to_sheet(inventoryData);
                XLSX.utils.book_append_sheet(wb, inventoryWS, 'ë³´ê´€í’ˆ');
                
                if (historyData.length > 0) {
                    const historyWS = XLSX.utils.json_to_sheet(historyData);
                    XLSX.utils.book_append_sheet(wb, historyWS, 'ì…ê³ ì´ë ¥');
                }
                
                const fileName = `ì…ê³ ê´€ë¦¬_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showStatus('ì—‘ì…€ íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                
            } catch (error) {
                console.error('ì—‘ì…€ ë‚´ë³´ë‚´ê¸° ì˜¤ë¥˜:', error);
                showStatus('ì—‘ì…€ ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”
        function clearAllData() {
            if (confirm('âš ï¸ ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”\n\në‹¤ìŒ ì‘ì—…ì´ ìˆ˜í–‰ë©ë‹ˆë‹¤:\nâ€¢ ëª¨ë“  ì…ê³  ì´ë ¥ ì‚­ì œ\nâ€¢ ë³´ê´€í’ˆ ìˆ˜ëŸ‰ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ë¦¬ì…‹\nâ€¢ ì €ì¥ëœ ëª¨ë“  ë°ì´í„° ì‚­ì œ\n\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                
                // ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”
                historyData = [];
                historyCounter = 1;
                
                // localStorage ì™„ì „ ì´ˆê¸°í™”
                localStorage.removeItem('requestHistory');
                localStorage.removeItem('historyCounter');
                localStorage.removeItem('inventoryData');
                
                // ë³´ê´€í’ˆ ë°ì´í„°ë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ë¦¬ì…‹ (í™•ì¸ ì—†ì´ ê°•ì œ ì‹¤í–‰)
                inventoryData = getDefaultInventoryData();
                localStorage.setItem('inventoryData', JSON.stringify(inventoryData));
                
                // ëª¨ë“  í…Œì´ë¸” ìƒˆë¡œê³ ì¹¨
                renderInventoryTable();
                renderRequestTable();
                renderHistoryTable();
                
                showStatus('âœ… ëª¨ë“  ë°ì´í„°ê°€ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                
                console.log('ğŸ”„ ì‹œìŠ¤í…œ ì™„ì „ ì´ˆê¸°í™” ì™„ë£Œ');
            }
        }

        // ê¸°ë³¸ ë³´ê´€í’ˆ ë°ì´í„° ë°˜í™˜ í•¨ìˆ˜
        function getDefaultInventoryData() {
            return [
                {
                    í’ˆëª©: "ì ë³´ë¡¤í™”ì¥ì§€/ì²œì—°í„í”„(ë™ì›)",
                    ê·œê²©: "250M*2ê²¹*16ë¡¤",
                    ìˆ˜ëŸ‰: 100,
                    ë‹¨ìœ„: "ë°•ìŠ¤",
                    ìƒì‚°ì‹œì„¤: "ë™ì›ì§ì—…ì¬í™œì›"
                },
                {
                    í’ˆëª©: "ë¡¤í™”ì¥ì§€(ë™ì›)", 
                    ê·œê²©: "3ê²¹/35m*30ë¡¤",
                    ìˆ˜ëŸ‰: 300,
                    ë‹¨ìœ„: "íŒ©",
                    ìƒì‚°ì‹œì„¤: "ë™ì›ì§ì—…ì¬í™œì›"
                },
                {
                    í’ˆëª©: "ì‚¬ê°í‹°ìŠˆ 250ë§¤(ë™ì›)",
                    ê·œê²©: "1ë°•ìŠ¤(24ê°œì…)",
                    ìˆ˜ëŸ‰: 300,
                    ë‹¨ìœ„: "ë°•ìŠ¤",
                    ìƒì‚°ì‹œì„¤: "ë™ì›ì§ì—…ì¬í™œì›"
                },
                {
                    í’ˆëª©: "ìƒë¶„í•´ë¬¼í‹°ìŠˆ",
                    ê·œê²©: "10ê°œì…/ìº¡í˜•",
                    ìˆ˜ëŸ‰: 240,
                    ë‹¨ìœ„: "ë°•ìŠ¤",
                    ìƒì‚°ì‹œì„¤: "í•™ì‚°ë³´í˜¸ì‘ì—…ì¥"
                },
                {
                    í’ˆëª©: "í”„ë¦¬ë¯¸ì—„",
                    ê·œê²©: "10ê°œì…",
                    ìˆ˜ëŸ‰: 600,
                    ë‹¨ìœ„: "ë°•ìŠ¤",
                    ìƒì‚°ì‹œì„¤: "í•™ì‚°ë³´í˜¸ì‘ì—…ì¥"
                },
                {
                    í’ˆëª©: "ì¢…ì´ì»µ",
                    ê·œê²©: "6.5ì˜¨ìŠ¤",
                    ìˆ˜ëŸ‰: 320,
                    ë‹¨ìœ„: "ë°•ìŠ¤",
                    ìƒì‚°ì‹œì„¤: "ëˆ„ë¦¬ë´„"
                }
            ];
        }

        // ê¸°ë³¸ê°’ìœ¼ë¡œ ë¦¬ì…‹ (ìˆ˜ì •ëœ ë²„ì „)
        function resetToDefault() {
            if (confirm('âš ï¸ ë³´ê´€í’ˆ ë°ì´í„° ë¦¬ì…‹\n\në³´ê´€í’ˆ ìˆ˜ëŸ‰ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ë˜ëŒë¦½ë‹ˆë‹¤.\n(ì…ê³ ì´ë ¥ì€ ìœ ì§€ë©ë‹ˆë‹¤)\n\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                
                // ê¸°ë³¸ ë°ì´í„°ë¡œ êµì²´
                inventoryData = getDefaultInventoryData();
                
                // localStorageì— ì €ì¥
                localStorage.setItem('inventoryData', JSON.stringify(inventoryData));
                
                // ë§ˆì§€ë§‰ ë“±ë¡ëœ ìš”ì²­ì„œ ë°ì´í„°ë„ ì´ˆê¸°í™”
                lastRegisteredRequest = null;
                
                // ëª¨ë“  í…Œì´ë¸” ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ì—°ë™ëœ ë°ì´í„° ë°˜ì˜
                renderInventoryTable(); // ë³´ê´€í’ˆ í˜„í™© ì—…ë°ì´íŠ¸ (ê¸°ë³¸ê°’ ë°˜ì˜)
                renderRequestTable();   // ì…ê³ ìš”ì²­ì„œ ì—…ë°ì´íŠ¸ (ê¸°ë³¸ ì´ˆê¸°ìˆ˜ëŸ‰ ë°˜ì˜)
                // ì…ê³ ì´ë ¥ì€ ê·¸ëŒ€ë¡œ ìœ ì§€
                
                showStatus('âœ… ë³´ê´€í’ˆ ë°ì´í„°ê°€ ê¸°ë³¸ê°’ìœ¼ë¡œ ë¦¬ì…‹ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                
                console.log('ğŸ”„ ë³´ê´€í’ˆ ë°ì´í„° ê¸°ë³¸ê°’ ë³µì› ì™„ë£Œ');
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            setCurrentDate();
            renderInventoryTable();
            renderRequestTable();
            renderHistoryTable();
        });
    </script>
</body>
</html>