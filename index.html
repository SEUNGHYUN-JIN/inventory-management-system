<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì…ê³ ìš”ì²­ì„œ ê´€ë¦¬ì‹œìŠ¤í…œ</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", "Malgun Gothic", Arial, sans-serif;
        line-height: 1.4;
        background-color: #f8f9fa;
        color: #333;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        background-color: white;
        min-height: 100vh;
      }

      .header {
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        color: white;
        padding: 20px 30px;
        border-bottom: 4px solid #3498db;
      }

      .header h1 {
        font-size: 22px;
        font-weight: 600;
        margin-bottom: 5px;
      }

      .header p {
        font-size: 14px;
        opacity: 0.9;
      }

      .firebase-status {
        background: #e8f5e8;
        padding: 15px 30px;
        border-bottom: 1px solid #d4edda;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .firebase-status.connecting {
        background: #fff3cd;
        border-color: #ffeaa7;
      }

      .firebase-status.error {
        background: #f8d7da;
        border-color: #f5c6cb;
      }

      .status-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #28a745;
        animation: pulse 2s infinite;
      }

      .status-dot.connecting {
        background: #ffc107;
      }

      .status-dot.error {
        background: #dc3545;
        animation: none;
      }

      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }

      .sync-info {
        font-size: 12px;
        color: #666;
      }

      .form-section {
        background-color: #ffffff;
        padding: 25px 30px;
        border-bottom: 1px solid #e9ecef;
      }

      .form-section h3 {
        font-size: 16px;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 20px;
        border-left: 4px solid #3498db;
        padding-left: 12px;
      }

      .controls {
        background-color: #f8f9fa;
        padding: 15px 30px;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .btn {
        background-color: #495057;
        color: white;
        border: none;
        padding: 8px 16px;
        font-size: 13px;
        font-weight: 500;
        border-radius: 3px;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .btn:hover {
        background-color: #343a40;
        transform: translateY(-1px);
      }

      .btn:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
        transform: none;
      }

      .btn-primary {
        background-color: #2980b9;
      }

      .btn-primary:hover {
        background-color: #1e6091;
      }

      .btn-success {
        background-color: #27ae60;
      }

      .btn-success:hover {
        background-color: #1e8449;
      }

      .btn-info {
        background-color: #17a2b8;
      }

      .btn-info:hover {
        background-color: #117a8b;
      }

      .btn-warning {
        background-color: #f39c12;
        color: white;
      }

      .btn-warning:hover {
        background-color: #d68910;
      }

      .btn-danger {
        background-color: #e74c3c;
      }

      .btn-danger:hover {
        background-color: #c0392b;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 6px;
        font-weight: 500;
        color: #495057;
        font-size: 13px;
      }

      .form-group input,
      .form-group select {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ced4da;
        border-radius: 3px;
        font-size: 13px;
        background-color: white;
      }

      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
      }

      .row {
        display: flex;
        gap: 20px;
      }

      .col {
        flex: 1;
      }

      .sheet-tabs {
        background-color: #f8f9fa;
        display: flex;
        border-bottom: 1px solid #dee2e6;
        padding: 0 30px;
      }

      .sheet-tab {
        padding: 12px 20px;
        background-color: transparent;
        border: none;
        border-bottom: 3px solid transparent;
        cursor: pointer;
        font-weight: 500;
        font-size: 13px;
        color: #495057;
        transition: all 0.2s ease;
      }

      .sheet-tab.active {
        color: #2980b9;
        border-bottom-color: #2980b9;
        background-color: white;
      }

      .sheet-tab:hover:not(.active) {
        color: #2980b9;
        background-color: #e9ecef;
      }

      .sheet-content {
        display: none;
        padding: 30px;
      }

      .sheet-content.active {
        display: block;
      }

      .summary-card {
        background-color: #f8f9fa;
        padding: 20px;
        border-left: 4px solid #3498db;
        margin-bottom: 25px;
        border-radius: 0 4px 4px 0;
      }

      .summary-card h4 {
        font-size: 16px;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 8px;
      }

      .summary-card p {
        font-size: 13px;
        color: #6c757d;
        margin-bottom: 5px;
      }

      .editable-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
        background-color: white;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .editable-table th {
        background-color: #f1f3f4;
        color: #495057;
        font-weight: 600;
        padding: 12px 8px;
        text-align: center;
        border: 1px solid #dee2e6;
        font-size: 12px;
      }

      .editable-table td {
        padding: 10px 8px;
        border: 1px solid #dee2e6;
        text-align: center;
        vertical-align: middle;
      }

      .editable-table td:nth-child(2),
      .editable-table td:nth-child(3) {
        text-align: left;
        padding-left: 12px;
      }

      .editable-table tbody tr:hover {
        background-color: #f8f9fa;
      }

      .editable-input {
        width: 100%;
        border: none;
        background: transparent;
        padding: 4px 6px;
        text-align: center;
        font-size: 12px;
        border-radius: 2px;
      }

      .editable-input:focus {
        background-color: #fff3cd;
        border: 1px solid #ffc107;
        outline: none;
      }

      .calculated-cell {
        background-color: #e8f4f8;
        font-weight: 500;
      }

      .negative-value {
        background-color: #fde8e8;
        color: #c53030;
        font-weight: 600;
      }

      .group-header {
        background-color: #e3f2fd !important;
        font-weight: 600 !important;
        color: #1565c0 !important;
      }

      .status {
        margin: 15px 30px;
        padding: 12px 16px;
        border-radius: 4px;
        display: none;
        font-size: 13px;
      }

      .status.success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .status.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .history-filters {
        margin-bottom: 20px;
        display: flex;
        gap: 10px;
        align-items: center;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 4px;
      }

      .history-filters label {
        font-weight: 500;
        color: #495057;
        font-size: 13px;
      }

      .history-filters input {
        padding: 6px 10px;
        border: 1px solid #ced4da;
        border-radius: 3px;
        font-size: 12px;
      }

      .filter-highlight {
        background-color: #e3f2fd;
        color: #1565c0;
        padding: 2px 6px;
        border-radius: 3px;
        font-weight: 600;
      }

      .loading {
        text-align: center;
        padding: 20px;
        color: #666;
        font-size: 14px;
      }

      .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #3498db;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
        margin: 10px auto;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .print-header,
      .print-info,
      .print-footer {
        display: none;
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }

      .modal-content {
        background-color: white;
        margin: 10% auto;
        padding: 20px;
        border-radius: 8px;
        width: 500px;
        max-width: 90%;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #e9ecef;
      }

      .modal-title {
        font-size: 18px;
        font-weight: 600;
        color: #2c3e50;
      }

      .close {
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
        color: #aaa;
      }

      .close:hover {
        color: #000;
      }

      .modal-body {
        margin-bottom: 20px;
      }

      .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        padding-top: 15px;
        border-top: 1px solid #e9ecef;
      }

      @media print {
        body {
          background-color: white !important;
          padding: 0 !important;
          margin: 0 !important;
        }

        .container {
          box-shadow: none !important;
          padding: 10px !important;
          margin: 0 !important;
          max-width: none !important;
        }

        .header,
        .form-section,
        .controls,
        .sheet-tabs,
        .status,
        .summary-card,
        .history-filters,
        .firebase-status,
        .modal {
          display: none !important;
        }

        .sheet-content {
          display: block !important;
          border: none !important;
          padding: 0 !important;
        }

        .sheet-content:not(.print-target) {
          display: none !important;
        }

        .print-header {
          display: block !important;
          text-align: center;
          margin-bottom: 20px;
          font-size: 18px;
          font-weight: bold;
          color: #000;
        }

        .print-info {
          display: block !important;
          margin-bottom: 15px;
          font-size: 12px;
          color: #000;
        }

        .print-footer {
          display: block !important;
          text-align: right;
          margin-top: 30px;
          font-size: 12px;
          color: #000;
        }

        .editable-table {
          font-size: 10px !important;
        }

        .editable-table th,
        .editable-table td {
          padding: 4px !important;
          border: 1px solid #000 !important;
        }

        .btn {
          display: none !important;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
          "
        >
          <div>
            <h1>ì…ê³ ìš”ì²­ì„œ ê´€ë¦¬ì‹œìŠ¤í…œ</h1>
            <p>Inventory Request Management System v4.1 - Firebase Edition</p>
            <p style="font-size: 12px; opacity: 0.8; margin-top: 5px">
              ì‘ì„±ì¼: <span id="current-date"></span>
            </p>
          </div>
          <div>
            <button
              class="btn btn-danger"
              onclick="showAdminLogin()"
              id="adminMenuBtn"
              style="
                background-color: rgba(255, 255, 255, 0.2);
                border: 2px solid rgba(255, 255, 255, 0.3);
              "
            >
              ğŸ” ê´€ë¦¬ì ëª¨ë“œ
            </button>
          </div>
        </div>
      </div>

      <!-- Firebase ì—°ê²° ìƒíƒœ -->
      <div id="firebase-status" class="firebase-status connecting">
        <div class="status-indicator">
          <div id="status-dot" class="status-dot connecting"></div>
          <span id="status-text">Firebase ì—°ê²° ì¤‘...</span>
        </div>
        <div class="sync-info">
          <span id="sync-info">ë§ˆì§€ë§‰ ë™ê¸°í™”: ì—°ê²° ì¤‘</span>
          <button type="button" id="firebase-retry-btn" class="btn btn-warning" style="display:none; margin-left:10px; padding:4px 12px;" onclick="retryFirebaseConnection()">ì¬ì‹œë„</button>
        </div>
      </div>

      <div class="form-section">
        <h3>ê¸°ë³¸ ì •ë³´ ì„¤ì •</h3>
        <div class="row">
          <div class="col">
            <div class="form-group">
              <label for="targetFacility">ëŒ€ìƒ ìƒì‚°ì‹œì„¤</label>
              <select id="targetFacility" onchange="filterByFacility()">
                <option value="">ì „ì²´ ì‹œì„¤</option>
                <option value="ë™ì›ì§ì—…ì¬í™œì›">ë™ì›ì§ì—…ì¬í™œì›</option>
                <option value="í•™ì‚°ë³´í˜¸ì‘ì—…ì¥">í•™ì‚°ë³´í˜¸ì‘ì—…ì¥</option>
                <option value="ëˆ„ë¦¬ë´„">ëˆ„ë¦¬ë´„</option>
              </select>
            </div>
          </div>
          <div class="col">
            <div class="form-group">
              <label for="facilityName">ìš”ì²­ ê¸°ê´€ëª…</label>
              <input
                type="text"
                id="facilityName"
                value="ê²½ìƒë‚¨ë„ ì¥ì• ì¸ìƒì‚°í’ˆíŒë§¤ì‹œì„¤"
              />
            </div>
          </div>
          <div class="col">
            <div class="form-group">
              <label for="requestDate">ì…ê³ ìš”ì²­ì¼</label>
              <input type="date" id="requestDate" />
            </div>
          </div>
        </div>
      </div>

      <div class="controls">
        <button class="btn btn-primary" onclick="addRequestHistory()">
          ì…ê³  ìš”ì²­ ë“±ë¡
        </button>
        <button class="btn btn-info" onclick="printCurrentSheet()">
          í˜„ì¬ ì‹œíŠ¸ ì¸ì‡„
        </button>
        <button class="btn btn-info" onclick="printRequestForm()">
          ì…ê³ ìš”ì²­ì„œ ì¸ì‡„
        </button>
        <button class="btn btn-info" onclick="previewPrint()">
          ì¸ì‡„ ë¯¸ë¦¬ë³´ê¸°
        </button>
        <button class="btn btn-success" onclick="exportToExcel()">
          ì—‘ì…€ë¡œ ë‚´ë³´ë‚´ê¸°
        </button>
        <button class="btn btn-warning" onclick="syncNow()">ìˆ˜ë™ ë™ê¸°í™”</button>
      </div>

      <!-- ê´€ë¦¬ì ë©”ë‰´ (ë¡œê·¸ì¸ í›„ì—ë§Œ í‘œì‹œ) -->
      <div
        id="admin-controls"
        class="controls"
        style="
          display: none;
          background-color: #f1f3f4;
          border-top: 2px solid #e74c3c;
        "
      >
        <span style="color: #e74c3c; font-weight: bold; margin-right: 10px"
          >ğŸ” ê´€ë¦¬ì ëª¨ë“œ í™œì„±í™”</span
        >
        <button class="btn btn-primary" onclick="showAddFacilityModal()">
          ìƒì‚°ì‹œì„¤ ì¶”ê°€
        </button>
        <button class="btn btn-primary" onclick="showAddItemModal()">
          í’ˆëª© ì¶”ê°€
        </button>
        <button class="btn btn-warning" onclick="showManageFacilitiesModal()">
          ìƒì‚°ì‹œì„¤ ê´€ë¦¬
        </button>
        <button class="btn btn-warning" onclick="showManageItemsModal()">
          í’ˆëª© ê´€ë¦¬
        </button>
        <button class="btn btn-warning" onclick="clearAllData()">
          ë°ì´í„° ì´ˆê¸°í™”
        </button>
        <button class="btn btn-danger" onclick="resetToDefault()">
          ê¸°ë³¸ê°’ ë¦¬ì…‹
        </button>
        <button class="btn btn-danger" onclick="adminLogout()">ë¡œê·¸ì•„ì›ƒ</button>
      </div>

      <div id="status" class="status"></div>

      <div class="sheet-tabs">
        <div class="sheet-tab active" onclick="showSheet('ë³´ê´€í’ˆ')">
          ë³´ê´€í’ˆ í˜„í™©
        </div>
        <div class="sheet-tab" onclick="showSheet('ì…ê³ ìš”ì²­ì„œ')">
          ì…ê³ ìš”ì²­ì„œ
        </div>
        <div class="sheet-tab" onclick="showSheet('ì…ê³ ì´ë ¥')">ì…ê³ ì´ë ¥</div>
      </div>

      <!-- ë³´ê´€í’ˆ ì‹œíŠ¸ -->
      <div id="sheet-ë³´ê´€í’ˆ" class="sheet-content active">
        <div class="print-header">ë³´ê´€í’ˆ í˜„í™©í‘œ</div>
        <div class="print-info">
          <div>ì‘ì„±ì¼: <span id="print-date-inventory"></span></div>
          <div>ì‘ì„±ê¸°ê´€: <span id="print-org-inventory"></span></div>
        </div>

        <div class="summary-card">
          <h4>ë³´ê´€í’ˆ í˜„í™©</h4>
          <p>
            ì‹¤ì‹œê°„ ë™ê¸°í™”ë˜ëŠ” ë³´ê´€í’ˆ ì •ë³´ì…ë‹ˆë‹¤. ìˆ˜ì •ì‚¬í•­ì´ ëª¨ë“  ê¸°ê¸°ì— ì¦‰ì‹œ
            ë°˜ì˜ë©ë‹ˆë‹¤.
          </p>
          <p id="inventoryFilter">í˜„ì¬ í‘œì‹œ: <strong>ì „ì²´ ìƒì‚°ì‹œì„¤</strong></p>
        </div>

        <div id="inventory-loading" class="loading" style="display: none">
          <div class="spinner"></div>
          <p>ë³´ê´€í’ˆ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>

        <table class="editable-table">
          <thead>
            <tr>
              <th style="width: 25%">ìƒì‚°ì‹œì„¤</th>
              <th style="width: 30%">í’ˆëª©</th>
              <th style="width: 25%">ê·œê²©</th>
              <th style="width: 10%">ìˆ˜ëŸ‰</th>
              <th style="width: 10%">ë‹¨ìœ„</th>
            </tr>
          </thead>
          <tbody id="inventory-tbody"></tbody>
        </table>

        <div class="print-footer">
          <div>ë‹´ë‹¹ì: _______________</div>
        </div>
      </div>

      <!-- ì…ê³ ìš”ì²­ì„œ ì‹œíŠ¸ -->
      <div id="sheet-ì…ê³ ìš”ì²­ì„œ" class="sheet-content">
        <div class="print-header">ì…ê³ ìš”ì²­ì„œ</div>
        <div class="print-info">
          <div>ìƒì‚°ì‹œì„¤: <span id="print-facility-request"></span></div>
          <div>ì…ê³ ìš”ì²­ì¼: <span id="print-date-request"></span></div>
          <div>ìš”ì²­ê¸°ê´€: <span id="print-org-request"></span></div>
        </div>

        <div class="summary-card">
          <h4>ì…ê³ ìš”ì²­ì„œ ì‘ì„±</h4>
          <p>
            <strong>ì”ëŸ‰ = ì´ˆê¸°ìˆ˜ëŸ‰ - ì…ê³ ìˆ˜ëŸ‰</strong> | ëª¨ë“  ë³€ê²½ì‚¬í•­ì´
            ì‹¤ì‹œê°„ìœ¼ë¡œ ë™ê¸°í™”ë©ë‹ˆë‹¤.
          </p>
          <p id="facilityFilter">í˜„ì¬ í‘œì‹œ: <strong>ì „ì²´ ìƒì‚°ì‹œì„¤</strong></p>
        </div>

        <table class="editable-table">
          <thead>
            <tr>
              <th style="width: 6%">No</th>
              <th style="width: 16%">ìƒì‚°ì‹œì„¤</th>
              <th style="width: 18%">í’ˆëª©</th>
              <th style="width: 16%">ê·œê²©</th>
              <th style="width: 10%">ì´ˆê¸°ìˆ˜ëŸ‰</th>
              <th style="width: 11%">ì…ê³ ìˆ˜ëŸ‰</th>
              <th style="width: 11%">ì”ëŸ‰</th>
              <th style="width: 12%">ì‘ì„±ì¼ì‹œ</th>
            </tr>
          </thead>
          <tbody id="request-tbody"></tbody>
        </table>

        <div class="print-footer">
          <div>ë‹´ë‹¹ì: _______________</div>
        </div>
      </div>

      <!-- ì…ê³ ì´ë ¥ ì‹œíŠ¸ -->
      <div id="sheet-ì…ê³ ì´ë ¥" class="sheet-content">
        <div class="print-header">ì…ê³ ì´ë ¥ ê´€ë¦¬ëŒ€ì¥</div>
        <div class="print-info">
          <div>ì¶œë ¥ì¼: <span id="print-date-history"></span></div>
          <div>ê´€ë¦¬ê¸°ê´€: <span id="print-org-history"></span></div>
        </div>

        <div class="summary-card">
          <h4>ì…ê³ ì´ë ¥ ê´€ë¦¬</h4>
          <p>ëª¨ë“  ê¸°ê¸°ì—ì„œ ì‹¤ì‹œê°„ìœ¼ë¡œ ê³µìœ ë˜ëŠ” ì…ê³  ì´ë ¥ì…ë‹ˆë‹¤.</p>
          <p id="historyFilter">í˜„ì¬ í‘œì‹œ: <strong>ì „ì²´ ìƒì‚°ì‹œì„¤</strong></p>
        </div>

        <div class="history-filters">
          <label>ê¸°ê°„ í•„í„°:</label>
          <input type="date" id="filterStartDate" />
          <span>~</span>
          <input type="date" id="filterEndDate" />
          <button class="btn" onclick="filterHistory()">í•„í„° ì ìš©</button>
          <button class="btn btn-warning" onclick="clearFilter()">
            í•„í„° í•´ì œ
          </button>
        </div>

        <table class="editable-table">
          <thead>
            <tr>
              <th style="width: 5%">No</th>
              <th style="width: 9%">ì…ê³ ì¼</th>
              <th style="width: 11%">ìƒì‚°ì‹œì„¤</th>
              <th style="width: 11%">ìš”ì²­ê¸°ê´€</th>
              <th style="width: 14%">í’ˆëª©</th>
              <th style="width: 12%">ê·œê²©</th>
              <th style="width: 7%">ì…ê³ ìˆ˜ëŸ‰</th>
              <th style="width: 7%">ì´ˆê¸°ìˆ˜ëŸ‰</th>
              <th style="width: 7%">ì”ëŸ‰</th>
              <th style="width: 10%">ë“±ë¡ì¼ì‹œ</th>
              <th style="width: 7%">ì‘ì—…</th>
            </tr>
          </thead>
          <tbody id="history-tbody"></tbody>
        </table>

        <div class="print-footer">
          <div>ë‹´ë‹¹ì: _______________</div>
        </div>
      </div>
    </div>

    <!-- ìƒì‚°ì‹œì„¤ ì¶”ê°€ ëª¨ë‹¬ -->
    <div id="addFacilityModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">ìƒì‚°ì‹œì„¤ ì¶”ê°€</h3>
          <span class="close" onclick="closeModal('addFacilityModal')"
            >&times;</span
          >
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="newFacilityName">ìƒì‚°ì‹œì„¤ëª…</label>
            <input
              type="text"
              id="newFacilityName"
              placeholder="ìƒˆë¡œìš´ ìƒì‚°ì‹œì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"
            />
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn" onclick="closeModal('addFacilityModal')">
            ì·¨ì†Œ
          </button>
          <button class="btn btn-primary" onclick="addFacility()">ì¶”ê°€</button>
        </div>
      </div>
    </div>

    <!-- í’ˆëª© ì¶”ê°€ ëª¨ë‹¬ -->
    <div id="addItemModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">í’ˆëª© ì¶”ê°€</h3>
          <span class="close" onclick="closeModal('addItemModal')"
            >&times;</span
          >
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="itemFacility">ìƒì‚°ì‹œì„¤</label>
            <select id="itemFacility">
              <option value="">ìƒì‚°ì‹œì„¤ ì„ íƒ</option>
            </select>
          </div>
          <div class="form-group">
            <label for="itemName">í’ˆëª©ëª…</label>
            <input
              type="text"
              id="itemName"
              placeholder="í’ˆëª©ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"
            />
          </div>
          <div class="form-group">
            <label for="itemSpec">ê·œê²©</label>
            <input type="text" id="itemSpec" placeholder="ê·œê²©ì„ ì…ë ¥í•˜ì„¸ìš”" />
          </div>
          <div class="row">
            <div class="col">
              <div class="form-group">
                <label for="itemQuantity">ìˆ˜ëŸ‰</label>
                <input type="number" id="itemQuantity" value="0" min="0" />
              </div>
            </div>
            <div class="col">
              <div class="form-group">
                <label for="itemUnit">ë‹¨ìœ„</label>
                <select id="itemUnit">
                  <option value="ë°•ìŠ¤">ë°•ìŠ¤</option>
                  <option value="íŒ©">íŒ©</option>
                  <option value="ê°œ">ê°œ</option>
                  <option value="kg">kg</option>
                  <option value="L">L</option>
                </select>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn" onclick="closeModal('addItemModal')">ì·¨ì†Œ</button>
          <button class="btn btn-primary" onclick="addItem()">ì¶”ê°€</button>
        </div>
      </div>
    </div>

    <!-- ê´€ë¦¬ì ë¡œê·¸ì¸ ëª¨ë‹¬ -->
    <div id="adminLoginModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">ê´€ë¦¬ì ë¡œê·¸ì¸</h3>
          <span class="close" onclick="closeModal('adminLoginModal')"
            >&times;</span
          >
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="adminId">ì•„ì´ë””</label>
            <input
              type="text"
              id="adminId"
              placeholder="ê´€ë¦¬ì ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
            />
          </div>
          <div class="form-group">
            <label for="adminPassword">íŒ¨ìŠ¤ì›Œë“œ</label>
            <input
              type="password"
              id="adminPassword"
              placeholder="ê´€ë¦¬ì íŒ¨ìŠ¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”"
            />
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn" onclick="closeModal('adminLoginModal')">
            ì·¨ì†Œ
          </button>
          <button class="btn btn-primary" onclick="adminLogin()">ë¡œê·¸ì¸</button>
        </div>
      </div>
    </div>

    <!-- ìƒì‚°ì‹œì„¤ ê´€ë¦¬ ëª¨ë‹¬ -->
    <div id="manageFacilitiesModal" class="modal">
      <div class="modal-content" style="width: 600px">
        <div class="modal-header">
          <h3 class="modal-title">ìƒì‚°ì‹œì„¤ ê´€ë¦¬</h3>
          <span class="close" onclick="closeModal('manageFacilitiesModal')"
            >&times;</span
          >
        </div>
        <div class="modal-body">
          <div style="margin-bottom: 20px">
            <h4 style="color: #2c3e50; margin-bottom: 10px">
              í˜„ì¬ ìƒì‚°ì‹œì„¤ ëª©ë¡
            </h4>
            <div
              id="facilitiesList"
              style="
                max-height: 300px;
                overflow-y: auto;
                border: 1px solid #e9ecef;
                border-radius: 4px;
                padding: 10px;
              "
            >
              <!-- ìƒì‚°ì‹œì„¤ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn" onclick="closeModal('manageFacilitiesModal')">
            ë‹«ê¸°
          </button>
        </div>
      </div>
    </div>

    <!-- í’ˆëª© ê´€ë¦¬ ëª¨ë‹¬ -->
    <div id="manageItemsModal" class="modal">
      <div class="modal-content" style="width: 800px; max-width: 95%">
        <div class="modal-header">
          <h3 class="modal-title">í’ˆëª© ê´€ë¦¬</h3>
          <span class="close" onclick="closeModal('manageItemsModal')"
            >&times;</span
          >
        </div>
        <div class="modal-body">
          <div style="margin-bottom: 15px">
            <label for="itemsFilterFacility">ìƒì‚°ì‹œì„¤ í•„í„°:</label>
            <select id="itemsFilterFacility" onchange="filterManageItems()">
              <option value="">ì „ì²´ ìƒì‚°ì‹œì„¤</option>
            </select>
          </div>
          <div style="max-height: 400px; overflow-y: auto">
            <table class="editable-table">
              <thead>
                <tr>
                  <th>ìƒì‚°ì‹œì„¤</th>
                  <th>í’ˆëª©ëª…</th>
                  <th>ê·œê²©</th>
                  <th>ìˆ˜ëŸ‰</th>
                  <th>ë‹¨ìœ„</th>
                  <th>ì‘ì—…</th>
                </tr>
              </thead>
              <tbody id="manageItemsTableBody">
                <!-- í’ˆëª© ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
              </tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn" onclick="closeModal('manageItemsModal')">
            ë‹«ê¸°
          </button>
        </div>
      </div>
    </div>

    <!-- í’ˆëª© ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="editItemModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">í’ˆëª© ìˆ˜ì •</h3>
          <span class="close" onclick="closeModal('editItemModal')"
            >&times;</span
          >
        </div>
        <div class="modal-body">
          <input type="hidden" id="editItemIndex" />
          <div class="form-group">
            <label for="editItemFacility">ìƒì‚°ì‹œì„¤</label>
            <select id="editItemFacility">
              <option value="">ìƒì‚°ì‹œì„¤ ì„ íƒ</option>
            </select>
          </div>
          <div class="form-group">
            <label for="editItemName">í’ˆëª©ëª…</label>
            <input
              type="text"
              id="editItemName"
              placeholder="í’ˆëª©ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"
            />
          </div>
          <div class="form-group">
            <label for="editItemSpec">ê·œê²©</label>
            <input
              type="text"
              id="editItemSpec"
              placeholder="ê·œê²©ì„ ì…ë ¥í•˜ì„¸ìš”"
            />
          </div>
          <div class="row">
            <div class="col">
              <div class="form-group">
                <label for="editItemQuantity">ìˆ˜ëŸ‰</label>
                <input type="number" id="editItemQuantity" min="0" />
              </div>
            </div>
            <div class="col">
              <div class="form-group">
                <label for="editItemUnit">ë‹¨ìœ„</label>
                <select id="editItemUnit">
                  <option value="ë°•ìŠ¤">ë°•ìŠ¤</option>
                  <option value="íŒ©">íŒ©</option>
                  <option value="ê°œ">ê°œ</option>
                  <option value="kg">kg</option>
                  <option value="L">L</option>
                </select>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn" onclick="closeModal('editItemModal')">
            ì·¨ì†Œ
          </button>
          <button class="btn btn-primary" onclick="updateItem()">ìˆ˜ì •</button>
        </div>
      </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- GitHub Pages: firebase-config.pages.js ì‚¬ìš©. ë¡œì»¬: firebase-config.jsê°€ ìˆìœ¼ë©´ ë®ì–´ì”€ (.gitignore ëŒ€ìƒ) -->
    <script src="firebase-config.pages.js"></script>
    <script src="firebase-config.js" onerror="void 0"></script>
    <script>
      // ========== Firebase ì„¤ì • ==========
      if (
        typeof firebaseConfig === "undefined" ||
        !firebaseConfig.apiKey ||
        firebaseConfig.apiKey.indexOf("YOUR_") === 0
      ) {
        window.firebaseConfig = { _placeholder: true };
      }
      const firebaseConfig = window.firebaseConfig || { _placeholder: true };

      // Firebase ì´ˆê¸°í™”
      let db;
      let isFirebaseConnected = false;

      try {
        if (firebaseConfig._placeholder) {
          setFirebaseStatus(
            "error",
            "firebase-config.jsë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”. (firebase-config.sample.js ì°¸ê³ )"
          );
          renderAllTables();
          return;
        } else {
          firebase.initializeApp(firebaseConfig);
          db = firebase.firestore();

          // Firestore ì—°ê²° í…ŒìŠ¤íŠ¸ (íƒ€ì„ì•„ì›ƒ 12ì´ˆ - ì—°ê²° ì¤‘ì—ì„œ ë©ˆì¶”ëŠ” ê²ƒ ë°©ì§€)
          const connectTimeout = 12000;
          const connectPromise = db.enableNetwork().then(() => true);
          const timeoutPromise = new Promise((_, reject) =>
            setTimeout(
              () => reject(new Error("ì—°ê²° ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ë˜ëŠ” API í‚¤ ì œí•œì„ í™•ì¸í•´ ì£¼ì„¸ìš”.")),
              connectTimeout
            )
          );
          Promise.race([connectPromise, timeoutPromise])
            .then(() => {
              setFirebaseStatus("connected", "Firebase ì—°ê²°ë¨ (ì‹¤ì‹œê°„ ë™ê¸°í™”)");
              isFirebaseConnected = true;
              loadDataFromFirebase();
            })
            .catch((error) => {
              setFirebaseStatus(
                "error",
                "Firebase ì—°ê²° ì‹¤íŒ¨: " + (error && error.message ? error.message : "ì•Œ ìˆ˜ ì—†ìŒ") + " [ì¬ì‹œë„ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì£¼ì„¸ìš”]"
              );
              renderAllTables();
            });
        }
      } catch (error) {
        console.error("Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:", error);
        setFirebaseStatus("error", "Firebase ì—°ê²° ì‹¤íŒ¨. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê±°ë‚˜ ì¬ì‹œë„í•´ ì£¼ì„¸ìš”.");
        renderAllTables();
      }

      // Firebase ìƒíƒœ ì—…ë°ì´íŠ¸
      function setFirebaseStatus(status, message) {
        const statusContainer = document.getElementById("firebase-status");
        const statusDot = document.getElementById("status-dot");
        const statusText = document.getElementById("status-text");
        const syncInfo = document.getElementById("sync-info");

        statusContainer.className = `firebase-status ${status}`;
        statusDot.className = `status-dot ${status}`;
        statusText.textContent = message;

        const retryBtn = document.getElementById("firebase-retry-btn");
        if (retryBtn) retryBtn.style.display = status === "error" ? "inline-block" : "none";
        if (status === "connected") {
          syncInfo.textContent = `ë§ˆì§€ë§‰ ë™ê¸°í™”: ${new Date().toLocaleTimeString()}`;
        } else {
          syncInfo.textContent = status === "error" ? "Firebase ì—°ê²° í›„ ë°ì´í„°ê°€ í‘œì‹œë©ë‹ˆë‹¤." : syncInfo.textContent;
        }
      }

      function retryFirebaseConnection() {
        if (typeof firebaseConfig === "undefined" || firebaseConfig._placeholder || !db) {
          setFirebaseStatus("error", "firebase-config.jsë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.");
          return;
        }
        setFirebaseStatus("connecting", "Firebase ì¬ì—°ê²° ì¤‘...");
        const connectTimeout = 12000;
        const connectPromise = db.enableNetwork().then(() => true);
        const timeoutPromise = new Promise((_, reject) =>
          setTimeout(() => reject(new Error("ì—°ê²° ì‹œê°„ ì´ˆê³¼")), connectTimeout)
        );
        Promise.race([connectPromise, timeoutPromise])
          .then(() => {
            isFirebaseConnected = true;
            loadDataFromFirebase();
          })
          .catch((err) => {
            isFirebaseConnected = false;
            setFirebaseStatus("error", "Firebase ì—°ê²° ì‹¤íŒ¨: " + (err && err.message ? err.message : "ì•Œ ìˆ˜ ì—†ìŒ") + " [ì¬ì‹œë„ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì£¼ì„¸ìš”]");
            renderAllTables();
          });
      }

      // ========== ë°ì´í„° ëª¨ë¸ ==========
      let inventoryData = [];
      let historyData = [];
      let historyCounter = 1;
      let currentFacilityFilter = "";
      let lastRegisteredRequest = null;
      let facilitiesData = [];
      let isAdminLoggedIn = false;

      // ========== Firebase ë°ì´í„° í•¨ìˆ˜ ==========

      // Firebaseì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
      async function loadDataFromFirebase() {
        if (!isFirebaseConnected) {
          renderAllTables();
          return;
        }

        try {
          showLoading(true);

          // ìƒì‚°ì‹œì„¤ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
          const facilitiesDoc = await db
            .collection("settings")
            .doc("facilities")
            .get();
          if (facilitiesDoc.exists) {
            facilitiesData =
              facilitiesDoc.data().list || getDefaultFacilities();
          } else {
            facilitiesData = getDefaultFacilities();
            await saveFacilitiesToFirebase();
          }

          // ë³´ê´€í’ˆ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
          const inventoryDoc = await db
            .collection("inventory")
            .doc("current")
            .get();
          if (inventoryDoc.exists) {
            inventoryData =
              inventoryDoc.data().items || getDefaultInventoryData();
          } else {
            inventoryData = getDefaultInventoryData();
            await saveInventoryToFirebase();
          }

          // ì…ê³ ì´ë ¥ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
          const historySnapshot = await db
            .collection("history")
            .orderBy("No")
            .get();
          historyData = [];
          historySnapshot.forEach((doc) => {
            historyData.push(doc.data());
          });

          // ì´ë ¥ ì¹´ìš´í„° ë¶ˆëŸ¬ì˜¤ê¸°
          const counterDoc = await db
            .collection("settings")
            .doc("counter")
            .get();
          if (counterDoc.exists) {
            historyCounter = counterDoc.data().value || 1;
          } else {
            await db.collection("settings").doc("counter").set({ value: 1 });
          }

          // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
          setupRealtimeListeners();

          showLoading(false);
          updateFacilityOptions();
          renderAllTables();
          setFirebaseStatus("connected", "Firebase ì—°ê²°ë¨ (ì‹¤ì‹œê°„ ë™ê¸°í™”)");
        } catch (error) {
          console.error("Firebase ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", error);
          setFirebaseStatus("error", "Firebase ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: " + (error && error.message ? error.message : "ì•Œ ìˆ˜ ì—†ìŒ"));
          renderAllTables();
        }
      }

      // Firebaseì— ìƒì‚°ì‹œì„¤ ë°ì´í„° ì €ì¥
      async function saveFacilitiesToFirebase() {
        if (!isFirebaseConnected) return;

        try {
          await db.collection("settings").doc("facilities").set({
            list: facilitiesData,
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
          });
        } catch (error) {
          console.error("Firebase ìƒì‚°ì‹œì„¤ ì €ì¥ ì‹¤íŒ¨:", error);
          showStatus("Firebase ìƒì‚°ì‹œì„¤ ì €ì¥ ì‹¤íŒ¨: " + error.message, "error");
        }
      }

      // Firebaseì— ë³´ê´€í’ˆ ë°ì´í„° ì €ì¥
      async function saveInventoryToFirebase() {
        if (!isFirebaseConnected) return;

        try {
          await db.collection("inventory").doc("current").set({
            items: inventoryData,
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
          });

          setFirebaseStatus("connected", "Firebase ì—°ê²°ë¨ (ì €ì¥ë¨)");
          setTimeout(() => {
            setFirebaseStatus("connected", "Firebase ì—°ê²°ë¨ (ì‹¤ì‹œê°„ ë™ê¸°í™”)");
          }, 2000);
        } catch (error) {
          console.error("Firebase ì €ì¥ ì‹¤íŒ¨:", error);
          showStatus("Firebase ì €ì¥ ì‹¤íŒ¨: " + error.message, "error");
        }
      }

      // Firebaseì— ì…ê³ ì´ë ¥ ì¶”ê°€
      async function addHistoryToFirebase(historyItem) {
        if (!isFirebaseConnected) return;

        try {
          await db
            .collection("history")
            .doc(historyItem.No.toString())
            .set(historyItem);
          await db
            .collection("settings")
            .doc("counter")
            .set({ value: historyCounter });
        } catch (error) {
          console.error("Firebase ì´ë ¥ ì €ì¥ ì‹¤íŒ¨:", error);
          showStatus("Firebase ì´ë ¥ ì €ì¥ ì‹¤íŒ¨: " + error.message, "error");
        }
      }

      // Firebaseì—ì„œ ì…ê³ ì´ë ¥ ì‚­ì œ
      async function deleteHistoryFromFirebase(no) {
        if (!isFirebaseConnected) return;

        try {
          await db.collection("history").doc(no.toString()).delete();
        } catch (error) {
          console.error("Firebase ì´ë ¥ ì‚­ì œ ì‹¤íŒ¨:", error);
          showStatus("Firebase ì´ë ¥ ì‚­ì œ ì‹¤íŒ¨: " + error.message, "error");
        }
      }

      // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
      function setupRealtimeListeners() {
        if (!isFirebaseConnected) return;

        // ìƒì‚°ì‹œì„¤ ë°ì´í„° ì‹¤ì‹œê°„ ê°ì§€
        db.collection("settings")
          .doc("facilities")
          .onSnapshot(
            (doc) => {
              if (doc.exists) {
                const newFacilities = doc.data().list || [];
                if (
                  JSON.stringify(newFacilities) !==
                  JSON.stringify(facilitiesData)
                ) {
                  facilitiesData = newFacilities;
                  updateFacilityOptions();
                  showStatus(
                    "ìƒì‚°ì‹œì„¤ ëª©ë¡ì´ ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.",
                    "success"
                  );
                }
              }
            },
            (error) => {
              console.error("ìƒì‚°ì‹œì„¤ ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì˜¤ë¥˜:", error);
            }
          );

        // ë³´ê´€í’ˆ ë°ì´í„° ì‹¤ì‹œê°„ ê°ì§€
        db.collection("inventory")
          .doc("current")
          .onSnapshot(
            (doc) => {
              if (doc.exists) {
                const newData = doc.data().items || [];
                if (JSON.stringify(newData) !== JSON.stringify(inventoryData)) {
                  inventoryData = newData;
                  renderInventoryTable();
                  renderRequestTable();
                  showStatus(
                    "ë³´ê´€í’ˆ ë°ì´í„°ê°€ ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.",
                    "success"
                  );
                }
              }
            },
            (error) => {
              console.error("ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì˜¤ë¥˜:", error);
            }
          );

        // ì…ê³ ì´ë ¥ ì‹¤ì‹œê°„ ê°ì§€
        db.collection("history").onSnapshot(
          (snapshot) => {
            const newHistoryData = [];
            snapshot.forEach((doc) => {
              newHistoryData.push(doc.data());
            });

            newHistoryData.sort((a, b) => a.No - b.No);

            if (
              JSON.stringify(newHistoryData) !== JSON.stringify(historyData)
            ) {
              historyData = newHistoryData;
              renderHistoryTable();
              showStatus(
                "ì…ê³ ì´ë ¥ì´ ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.",
                "success"
              );
            }
          },
          (error) => {
            console.error("ì´ë ¥ ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì˜¤ë¥˜:", error);
          }
        );
      }

      // localStorageì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (í´ë°±)
      function loadDataFromLocalStorage() {
        const savedFacilities = localStorage.getItem("facilitiesData");
        const savedInventory = localStorage.getItem("inventoryData");
        const savedHistory = localStorage.getItem("requestHistory");
        const savedCounter = localStorage.getItem("historyCounter");

        if (savedFacilities) {
          facilitiesData = JSON.parse(savedFacilities);
        } else {
          facilitiesData = getDefaultFacilities();
        }

        if (savedInventory) {
          inventoryData = JSON.parse(savedInventory);
        } else {
          inventoryData = getDefaultInventoryData();
        }

        if (savedHistory) {
          historyData = JSON.parse(savedHistory);
        }

        if (savedCounter) {
          historyCounter = parseInt(savedCounter);
        }

        showLoading(false);
        updateFacilityOptions();
        renderAllTables();
      }

      // ========== UI í•¨ìˆ˜ ==========

      function showLoading(show) {
        const loadingElements = document.querySelectorAll(".loading");
        const tables = document.querySelectorAll(".editable-table");

        loadingElements.forEach((el) => {
          el.style.display = show ? "block" : "none";
        });

        tables.forEach((table) => {
          table.style.display = show ? "none" : "table";
        });
      }

      function getCurrentDateTime() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, "0");
        const day = String(now.getDate()).padStart(2, "0");
        const hours = String(now.getHours()).padStart(2, "0");
        const minutes = String(now.getMinutes()).padStart(2, "0");

        return `${year}-${month}-${day} ${hours}:${minutes}`;
      }

      function setCurrentDate() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, "0");
        const day = String(today.getDate()).padStart(2, "0");

        document.getElementById(
          "requestDate"
        ).value = `${year}-${month}-${day}`;

        const koreanDate = `${year}ë…„ ${month}ì›” ${day}ì¼`;
        document.getElementById("current-date").textContent = koreanDate;
      }

      function showStatus(message, type) {
        const statusDiv = document.getElementById("status");
        statusDiv.textContent = message;
        statusDiv.className = `status ${type}`;
        statusDiv.style.display = "block";

        setTimeout(() => {
          statusDiv.style.display = "none";
        }, 3000);
      }

      function showSheet(sheetName) {
        document
          .querySelectorAll(".sheet-tab")
          .forEach((tab) => tab.classList.remove("active"));
        document
          .querySelectorAll(".sheet-content")
          .forEach((content) => content.classList.remove("active"));

        event.target.classList.add("active");
        document.getElementById(`sheet-${sheetName}`).classList.add("active");
      }

      function filterByFacility() {
        currentFacilityFilter = document.getElementById("targetFacility").value;
        renderInventoryTable();
        renderRequestTable();
        renderHistoryTable();
        updateFacilityFilterDisplay();
      }

      function updateFacilityFilterDisplay() {
        const filterText = currentFacilityFilter
          ? `<span class="filter-highlight">${currentFacilityFilter}</span>`
          : `<strong>ì „ì²´ ìƒì‚°ì‹œì„¤</strong>`;

        ["facilityFilter", "inventoryFilter", "historyFilter"].forEach((id) => {
          const element = document.getElementById(id);
          if (element) {
            element.innerHTML = `í˜„ì¬ í‘œì‹œ: ${filterText}`;
          }
        });
      }

      function renderAllTables() {
        renderInventoryTable();
        renderRequestTable();
        renderHistoryTable();
        updateFacilityFilterDisplay();
      }

      // ========== í…Œì´ë¸” ë Œë”ë§ í•¨ìˆ˜ë“¤ ==========

      function renderInventoryTable() {
        const tbody = document.getElementById("inventory-tbody");
        tbody.innerHTML = "";

        const filteredData = currentFacilityFilter
          ? inventoryData.filter(
              (item) => item.ìƒì‚°ì‹œì„¤ === currentFacilityFilter
            )
          : inventoryData;

        if (filteredData.length === 0) {
          const row = document.createElement("tr");
          row.innerHTML =
            '<td colspan="5" style="text-align: center; color: #666;">ì„ íƒëœ ìƒì‚°ì‹œì„¤ì— í’ˆëª©ì´ ì—†ìŠµë‹ˆë‹¤.</td>';
          tbody.appendChild(row);
          return;
        }

        if (!currentFacilityFilter) {
          const groupedData = filteredData.reduce((groups, item) => {
            const facility = item.ìƒì‚°ì‹œì„¤;
            if (!groups[facility]) {
              groups[facility] = [];
            }
            groups[facility].push(item);
            return groups;
          }, {});

          Object.keys(groupedData)
            .sort()
            .forEach((facility) => {
              const headerRow = document.createElement("tr");
              headerRow.classList.add("group-header");
              headerRow.innerHTML = `
                        <td colspan="5" style="text-align: center; padding: 10px;">${facility}</td>
                    `;
              tbody.appendChild(headerRow);

              groupedData[facility].forEach((item) => {
                const globalIndex = inventoryData.indexOf(item);
                const row = document.createElement("tr");
                row.innerHTML = `
                            <td>${item.ìƒì‚°ì‹œì„¤}</td>
                            <td>${item.í’ˆëª©}</td>
                            <td>${item.ê·œê²©}</td>
                            <td>
                                <input type="number" class="editable-input" value="${item.ìˆ˜ëŸ‰}" 
                                       onchange="updateInventoryQuantity(${globalIndex}, this.value)" style="text-align: center;">
                            </td>
                            <td>${item.ë‹¨ìœ„}</td>
                        `;
                tbody.appendChild(row);
              });
            });
        } else {
          filteredData.forEach((item) => {
            const globalIndex = inventoryData.indexOf(item);
            const row = document.createElement("tr");
            row.innerHTML = `
                        <td>${item.ìƒì‚°ì‹œì„¤}</td>
                        <td>${item.í’ˆëª©}</td>
                        <td>${item.ê·œê²©}</td>
                        <td>
                            <input type="number" class="editable-input" value="${item.ìˆ˜ëŸ‰}" 
                                   onchange="updateInventoryQuantity(${globalIndex}, this.value)" style="text-align: center;">
                        </td>
                        <td>${item.ë‹¨ìœ„}</td>
                    `;
            tbody.appendChild(row);
          });
        }
      }

      function renderRequestTable() {
        const tbody = document.getElementById("request-tbody");
        tbody.innerHTML = "";

        const filteredData = currentFacilityFilter
          ? inventoryData.filter(
              (item) => item.ìƒì‚°ì‹œì„¤ === currentFacilityFilter
            )
          : inventoryData;

        if (filteredData.length === 0) {
          const row = document.createElement("tr");
          row.innerHTML =
            '<td colspan="8" style="text-align: center; color: #666;">ì„ íƒëœ ìƒì‚°ì‹œì„¤ì— í’ˆëª©ì´ ì—†ìŠµë‹ˆë‹¤.</td>';
          tbody.appendChild(row);
          return;
        }

        if (!currentFacilityFilter) {
          const groupedData = filteredData.reduce((groups, item) => {
            const facility = item.ìƒì‚°ì‹œì„¤;
            if (!groups[facility]) {
              groups[facility] = [];
            }
            groups[facility].push(item);
            return groups;
          }, {});

          let rowCounter = 1;
          Object.keys(groupedData)
            .sort()
            .forEach((facility) => {
              const headerRow = document.createElement("tr");
              headerRow.classList.add("group-header");
              headerRow.innerHTML = `
                        <td colspan="8" style="text-align: center; padding: 8px;">${facility}</td>
                    `;
              tbody.appendChild(headerRow);

              groupedData[facility].forEach((item) => {
                const globalIndex = inventoryData.indexOf(item);
                const row = document.createElement("tr");
                row.innerHTML = `
                            <td>${rowCounter++}</td>
                            <td>${item.ìƒì‚°ì‹œì„¤}</td>
                            <td>${item.í’ˆëª©}</td>
                            <td>${item.ê·œê²©}</td>
                            <td class="calculated-cell">${item.ìˆ˜ëŸ‰.toLocaleString()}</td>
                            <td>
                                <input type="number" class="editable-input" placeholder="0" 
                                       id="request-${globalIndex}" onchange="calculateRemaining(${globalIndex})" style="text-align: center;">
                            </td>
                            <td id="remaining-${globalIndex}" class="calculated-cell">-</td>
                            <td style="font-size: 10px; color: #666;">${getCurrentDateTime()}</td>
                        `;
                tbody.appendChild(row);
              });
            });
        } else {
          filteredData.forEach((item, index) => {
            const globalIndex = inventoryData.indexOf(item);
            const row = document.createElement("tr");
            row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${item.ìƒì‚°ì‹œì„¤}</td>
                        <td>${item.í’ˆëª©}</td>
                        <td>${item.ê·œê²©}</td>
                        <td class="calculated-cell">${item.ìˆ˜ëŸ‰.toLocaleString()}</td>
                        <td>
                            <input type="number" class="editable-input" placeholder="0" 
                                   id="request-${globalIndex}" onchange="calculateRemaining(${globalIndex})" style="text-align: center;">
                        </td>
                        <td id="remaining-${globalIndex}" class="calculated-cell">-</td>
                        <td style="font-size: 10px; color: #666;">${getCurrentDateTime()}</td>
                    `;
            tbody.appendChild(row);
          });
        }
      }

      /** ì…ê³  ì´ë ¥ í•­ëª©ì˜ ê·œê²© ë°˜í™˜. ì´ë ¥ì— ì—†ìœ¼ë©´ ë™ì¼ ìƒì‚°ì‹œì„¤Â·í’ˆëª©ì˜ í˜„ì¬ ë³´ê´€í’ˆ ê·œê²©ìœ¼ë¡œ ì¶”ì  */
      function getHistoryItemSpec(historyItem) {
        if (historyItem.ê·œê²© != null && String(historyItem.ê·œê²©).trim() !== "")
          return historyItem.ê·œê²©;
        const inv = inventoryData.find(
          (i) =>
            i.ìƒì‚°ì‹œì„¤ === historyItem.ìƒì‚°ì‹œì„¤ && i.í’ˆëª© === historyItem.í’ˆëª©
        );
        return inv && inv.ê·œê²© != null ? inv.ê·œê²© : "-";
      }

      function renderHistoryTable(dataToRender = null) {
        const tbody = document.getElementById("history-tbody");
        tbody.innerHTML = "";

        let data = dataToRender || historyData;

        if (currentFacilityFilter) {
          data = data.filter((item) => item.ìƒì‚°ì‹œì„¤ === currentFacilityFilter);
        }

        data.forEach((item, index) => {
          const row = document.createElement("tr");
          const remainingClass = item.ì”ëŸ‰ < 0 ? "negative-value" : "";

          row.innerHTML = `
                    <td>${item.No}</td>
                    <td>${item.ì…ê³ ì¼}</td>
                    <td>${item.ìƒì‚°ì‹œì„¤}</td>
                    <td>${item.ìš”ì²­ê¸°ê´€ || "-"}</td>
                    <td>${item.í’ˆëª©}</td>
                    <td>${getHistoryItemSpec(item)}</td>
                    <td>${item.ì…ê³ ìˆ˜ëŸ‰.toLocaleString()}</td>
                    <td>${item.ì´ˆê¸°ìˆ˜ëŸ‰.toLocaleString()}</td>
                    <td class="${remainingClass}">${item.ì”ëŸ‰.toLocaleString()}</td>
                    <td style="font-size: 10px; color: #666;">${
                      item.ë“±ë¡ì¼ì‹œ || "-"
                    }</td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteHistory(${
                          item.No
                        })" style="padding: 4px 8px; font-size: 10px;">ì‚­ì œ</button>
                    </td>
                `;
          tbody.appendChild(row);
        });

        if (data.length === 0) {
          const emptyMessage = currentFacilityFilter
            ? `ì„ íƒëœ ìƒì‚°ì‹œì„¤(${currentFacilityFilter})ì˜ ì…ê³  ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.`
            : "ë“±ë¡ëœ ì…ê³  ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.";
          const row = document.createElement("tr");
          row.innerHTML = `<td colspan="11" style="text-align: center; color: #666;">${emptyMessage}</td>`;
          tbody.appendChild(row);
        }
      }

      // ========== ë°ì´í„° ì¡°ì‘ í•¨ìˆ˜ë“¤ ==========

      async function updateInventoryQuantity(index, newValue) {
        const oldValue = inventoryData[index].ìˆ˜ëŸ‰;
        const newQuantity = parseInt(newValue) || 0;

        inventoryData[index].ìˆ˜ëŸ‰ = newQuantity;

        // Firebaseì— ì €ì¥
        await saveInventoryToFirebase();

        // localStorageì—ë„ ë°±ì—… ì €ì¥
        localStorage.setItem("inventoryData", JSON.stringify(inventoryData));

        renderRequestTable();

        const item = inventoryData[index];
        showStatus(
          `âœ… "${item.í’ˆëª©}" ìˆ˜ëŸ‰ì´ ${oldValue} â†’ ${newQuantity}ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`,
          "success"
        );
      }

      function calculateRemaining(index) {
        const requestInput = document.getElementById(`request-${index}`);
        const remainingCell = document.getElementById(`remaining-${index}`);

        if (!requestInput || !remainingCell) return;

        const requestQuantity = parseInt(requestInput.value) || 0;
        const currentInventoryQuantity = inventoryData[index].ìˆ˜ëŸ‰;
        const remaining = currentInventoryQuantity - requestQuantity;

        remainingCell.textContent = remaining.toLocaleString();
        remainingCell.className =
          remaining < 0 ? "calculated-cell negative-value" : "calculated-cell";

        if (remaining < 0) {
          remainingCell.title = `âš ï¸ í˜„ì¬ ë³´ìœ ëŸ‰(${currentInventoryQuantity})ë³´ë‹¤ ${Math.abs(
            remaining
          )}ê°œ ë¶€ì¡±í•©ë‹ˆë‹¤.`;
        } else {
          remainingCell.title = `ì…ê³  í›„ ì˜ˆìƒ ì”ëŸ‰: ${remaining}`;
        }
      }

      async function addRequestHistory() {
        const facilityName = document.getElementById("facilityName").value;
        const requestDate = document.getElementById("requestDate").value;
        const targetFacility = document.getElementById("targetFacility").value;

        if (!facilityName || !requestDate) {
          showStatus("ìš”ì²­ ê¸°ê´€ëª…ê³¼ ì…ê³ ìš”ì²­ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", "error");
          return;
        }

        let hasRequests = false;
        let requestCount = 0;
        let updatedItems = [];
        let registeredItems = [];

        const dataToProcess = targetFacility
          ? inventoryData.filter((item) => item.ìƒì‚°ì‹œì„¤ === targetFacility)
          : inventoryData;

        // ë¨¼ì € ë¡œì»¬ì—ì„œ ì²˜ë¦¬
        dataToProcess.forEach((item) => {
          const globalIndex = inventoryData.indexOf(item);
          const requestInput = document.getElementById(
            `request-${globalIndex}`
          );
          const requestQuantity = parseInt(requestInput?.value) || 0;

          if (requestQuantity > 0) {
            hasRequests = true;
            requestCount++;

            const previousQuantity = item.ìˆ˜ëŸ‰;
            const remaining = item.ìˆ˜ëŸ‰ - requestQuantity;

            const historyItem = {
              No: historyCounter++,
              ì…ê³ ì¼: requestDate,
              ìƒì‚°ì‹œì„¤: item.ìƒì‚°ì‹œì„¤,
              ìš”ì²­ê¸°ê´€: facilityName,
              í’ˆëª©: item.í’ˆëª©,
              ê·œê²©: item.ê·œê²© ?? "",
              ì…ê³ ìˆ˜ëŸ‰: requestQuantity,
              ì´ˆê¸°ìˆ˜ëŸ‰: previousQuantity,
              ì”ëŸ‰: remaining,
              ë“±ë¡ì¼ì‹œ: getCurrentDateTime(),
            };

            historyData.push(historyItem);
            inventoryData[globalIndex].ìˆ˜ëŸ‰ = remaining;

            // Firebaseì— ì €ì¥
            addHistoryToFirebase(historyItem);

            updatedItems.push({
              í’ˆëª©: item.í’ˆëª©,
              ìƒì‚°ì‹œì„¤: item.ìƒì‚°ì‹œì„¤,
              ì…ê³ ì „ìˆ˜ëŸ‰: previousQuantity,
              ì…ê³ ìˆ˜ëŸ‰: requestQuantity,
              ì…ê³ í›„ìˆ˜ëŸ‰: remaining,
            });

            registeredItems.push({
              No: registeredItems.length + 1,
              ìƒì‚°ì‹œì„¤: item.ìƒì‚°ì‹œì„¤,
              í’ˆëª©: item.í’ˆëª©,
              ê·œê²©: item.ê·œê²©,
              ì´ˆê¸°ìˆ˜ëŸ‰: previousQuantity,
              ì…ê³ ìˆ˜ëŸ‰: requestQuantity,
              ì”ëŸ‰: remaining,
              ë“±ë¡ì¼ì‹œ: getCurrentDateTime(),
            });

            if (requestInput) {
              requestInput.value = "";
            }
            const remainingCell = document.getElementById(
              `remaining-${globalIndex}`
            );
            if (remainingCell) {
              remainingCell.textContent = "-";
              remainingCell.className = "calculated-cell";
            }
          }
        });

        if (!hasRequests) {
          showStatus("ì…ê³ ìˆ˜ëŸ‰ì„ 1ê°œ ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.", "error");
          return;
        }

        lastRegisteredRequest = {
          facilityName: facilityName,
          requestDate: requestDate,
          targetFacility: targetFacility,
          items: registeredItems,
        };

        // Firebaseì™€ localStorageì— ì €ì¥
        await saveInventoryToFirebase();
        localStorage.setItem("requestHistory", JSON.stringify(historyData));
        localStorage.setItem("historyCounter", historyCounter.toString());
        localStorage.setItem("inventoryData", JSON.stringify(inventoryData));

        renderAllTables();

        const facilityMsg = targetFacility ? `${targetFacility}ì˜ ` : "";
        showStatus(
          `${facilityMsg}ì…ê³  ìš”ì²­ ${requestCount}ê±´ì´ ë“±ë¡ë˜ê³  ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.`,
          "success"
        );
      }

      async function deleteHistory(no) {
        const historyItem = historyData.find((item) => item.No === no);
        if (!historyItem) return;

        if (
          confirm(
            `ì´ ì´ë ¥ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nğŸ“‹ ì‚­ì œ ëŒ€ìƒ:\nâ€¢ í’ˆëª©: ${
              historyItem.í’ˆëª©
            }\nâ€¢ ê·œê²©: ${getHistoryItemSpec(historyItem)}\nâ€¢ ìƒì‚°ì‹œì„¤: ${
              historyItem.ìƒì‚°ì‹œì„¤
            }\nâ€¢ ì…ê³ ìˆ˜ëŸ‰: ${
              historyItem.ì…ê³ ìˆ˜ëŸ‰
            }\n\nâš ï¸ ì‚­ì œ ì‹œ í•´ë‹¹ í’ˆëª©ì˜ ìˆ˜ëŸ‰ì´ ${
              historyItem.ì…ê³ ìˆ˜ëŸ‰
            }ë§Œí¼ ì¦ê°€í•©ë‹ˆë‹¤.`
          )
        ) {
          const inventoryItem = inventoryData.find(
            (item) =>
              item.í’ˆëª© === historyItem.í’ˆëª© &&
              item.ìƒì‚°ì‹œì„¤ === historyItem.ìƒì‚°ì‹œì„¤
          );

          let restoredQuantity = 0;
          if (inventoryItem) {
            inventoryItem.ìˆ˜ëŸ‰ += historyItem.ì…ê³ ìˆ˜ëŸ‰;
            restoredQuantity = inventoryItem.ìˆ˜ëŸ‰;
          }

          historyData = historyData.filter((item) => item.No !== no);

          // Firebaseì—ì„œ ì‚­ì œ
          await deleteHistoryFromFirebase(no);
          await saveInventoryToFirebase();

          // localStorage ì—…ë°ì´íŠ¸
          localStorage.setItem("requestHistory", JSON.stringify(historyData));
          localStorage.setItem("inventoryData", JSON.stringify(inventoryData));

          renderAllTables();

          showStatus(
            `âœ… ì´ë ¥ì´ ì‚­ì œë˜ê³  "${historyItem.í’ˆëª©}" ìˆ˜ëŸ‰ì´ ${restoredQuantity}ë¡œ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤.`,
            "success"
          );
        }
      }

      // ========== ê¸°íƒ€ í•¨ìˆ˜ë“¤ ==========

      function syncNow() {
        if (isFirebaseConnected) {
          loadDataFromFirebase();
          showStatus("ìˆ˜ë™ ë™ê¸°í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
        } else {
          showStatus("Firebase ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤.", "error");
        }
      }

      function getDefaultFacilities() {
        return ["ë™ì›ì§ì—…ì¬í™œì›", "í•™ì‚°ë³´í˜¸ì‘ì—…ì¥", "ëˆ„ë¦¬ë´„"];
      }

      function getDefaultInventoryData() {
        return [
          {
            í’ˆëª©: "ì ë³´ë¡¤í™”ì¥ì§€/ì²œì—°í„í”„(ë™ì›)",
            ê·œê²©: "250M*2ê²¹*16ë¡¤",
            ìˆ˜ëŸ‰: 100,
            ë‹¨ìœ„: "ë°•ìŠ¤",
            ìƒì‚°ì‹œì„¤: "ë™ì›ì§ì—…ì¬í™œì›",
          },
          {
            í’ˆëª©: "ë¡¤í™”ì¥ì§€(ë™ì›)",
            ê·œê²©: "3ê²¹/35m*30ë¡¤",
            ìˆ˜ëŸ‰: 300,
            ë‹¨ìœ„: "íŒ©",
            ìƒì‚°ì‹œì„¤: "ë™ì›ì§ì—…ì¬í™œì›",
          },
          {
            í’ˆëª©: "ì‚¬ê°í‹°ìŠˆ 250ë§¤(ë™ì›)",
            ê·œê²©: "1ë°•ìŠ¤(24ê°œì…)",
            ìˆ˜ëŸ‰: 300,
            ë‹¨ìœ„: "ë°•ìŠ¤",
            ìƒì‚°ì‹œì„¤: "ë™ì›ì§ì—…ì¬í™œì›",
          },
          {
            í’ˆëª©: "ìƒë¶„í•´ë¬¼í‹°ìŠˆ",
            ê·œê²©: "10ê°œì…/ìº¡í˜•",
            ìˆ˜ëŸ‰: 240,
            ë‹¨ìœ„: "ë°•ìŠ¤",
            ìƒì‚°ì‹œì„¤: "í•™ì‚°ë³´í˜¸ì‘ì—…ì¥",
          },
          {
            í’ˆëª©: "í”„ë¦¬ë¯¸ì—„",
            ê·œê²©: "10ê°œì…",
            ìˆ˜ëŸ‰: 600,
            ë‹¨ìœ„: "ë°•ìŠ¤",
            ìƒì‚°ì‹œì„¤: "í•™ì‚°ë³´í˜¸ì‘ì—…ì¥",
          },
          {
            í’ˆëª©: "ì¢…ì´ì»µ",
            ê·œê²©: "6.5ì˜¨ìŠ¤",
            ìˆ˜ëŸ‰: 320,
            ë‹¨ìœ„: "ë°•ìŠ¤",
            ìƒì‚°ì‹œì„¤: "ëˆ„ë¦¬ë´„",
          },
        ];
      }

      // ========== ëª¨ë‹¬ ê´€ë¦¬ í•¨ìˆ˜ ==========

      function showAddFacilityModal() {
        if (!isAdminLoggedIn) {
          showStatus("ìƒì‚°ì‹œì„¤ ì¶”ê°€ëŠ” ê´€ë¦¬ì ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.", "error");
          return;
        }
        document.getElementById("addFacilityModal").style.display = "block";
        document.getElementById("newFacilityName").focus();
      }

      function showAddItemModal() {
        if (!isAdminLoggedIn) {
          showStatus("í’ˆëª© ì¶”ê°€ëŠ” ê´€ë¦¬ì ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.", "error");
          return;
        }
        updateItemFacilityOptions();
        document.getElementById("addItemModal").style.display = "block";
      }

      function closeModal(modalId) {
        document.getElementById(modalId).style.display = "none";
        // ëª¨ë‹¬ í¼ ì´ˆê¸°í™”
        if (modalId === "addFacilityModal") {
          document.getElementById("newFacilityName").value = "";
        } else if (modalId === "addItemModal") {
          document.getElementById("itemFacility").value = "";
          document.getElementById("itemName").value = "";
          document.getElementById("itemSpec").value = "";
          document.getElementById("itemQuantity").value = "0";
          document.getElementById("itemUnit").value = "ë°•ìŠ¤";
        } else if (modalId === "adminLoginModal") {
          document.getElementById("adminId").value = "";
          document.getElementById("adminPassword").value = "";
        } else if (modalId === "editItemModal") {
          document.getElementById("editItemIndex").value = "";
          document.getElementById("editItemFacility").value = "";
          document.getElementById("editItemName").value = "";
          document.getElementById("editItemSpec").value = "";
          document.getElementById("editItemQuantity").value = "";
          document.getElementById("editItemUnit").value = "ë°•ìŠ¤";
        }
      }

      // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
      window.onclick = function (event) {
        const modals = document.querySelectorAll(".modal");
        modals.forEach((modal) => {
          if (event.target === modal) {
            modal.style.display = "none";
          }
        });
      };

      // ========== ê´€ë¦¬ì ë¡œê·¸ì¸ í•¨ìˆ˜ ==========

      function showAdminLogin() {
        if (isAdminLoggedIn) {
          showStatus("ì´ë¯¸ ê´€ë¦¬ìë¡œ ë¡œê·¸ì¸ë˜ì–´ ìˆìŠµë‹ˆë‹¤.", "success");
          return;
        }
        document.getElementById("adminLoginModal").style.display = "block";
        document.getElementById("adminId").focus();
      }

      function adminLogin() {
        const adminId = document.getElementById("adminId").value.trim();
        const adminPassword = document
          .getElementById("adminPassword")
          .value.trim();

        if (!adminId || !adminPassword) {
          showStatus("ì•„ì´ë””ì™€ íŒ¨ìŠ¤ì›Œë“œë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.", "error");
          return;
        }

        if (adminId === "admin" && adminPassword === "admin") {
          isAdminLoggedIn = true;
          document.getElementById("admin-controls").style.display = "flex";
          document.getElementById("adminMenuBtn").textContent =
            "ğŸ”“ ê´€ë¦¬ì ëª¨ë“œ í™œì„±í™”ë¨";
          document.getElementById("adminMenuBtn").disabled = true;
          document.getElementById("adminMenuBtn").style.backgroundColor =
            "rgba(40, 167, 69, 0.3)";
          document.getElementById("adminMenuBtn").style.borderColor =
            "rgba(40, 167, 69, 0.5)";
          closeModal("adminLoginModal");
          showStatus(
            "âœ… ê´€ë¦¬ìë¡œ ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ ê¸°ëŠ¥ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.",
            "success"
          );
        } else {
          showStatus("ì•„ì´ë”” ë˜ëŠ” íŒ¨ìŠ¤ì›Œë“œê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.", "error");
          document.getElementById("adminPassword").value = "";
        }
      }

      function adminLogout() {
        if (confirm("ê´€ë¦¬ì ëª¨ë“œì—ì„œ ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
          isAdminLoggedIn = false;
          document.getElementById("admin-controls").style.display = "none";
          document.getElementById("adminMenuBtn").textContent =
            "ğŸ” ê´€ë¦¬ì ëª¨ë“œ";
          document.getElementById("adminMenuBtn").disabled = false;
          document.getElementById("adminMenuBtn").style.backgroundColor =
            "rgba(255,255,255,0.2)";
          document.getElementById("adminMenuBtn").style.borderColor =
            "rgba(255,255,255,0.3)";
          showStatus("ê´€ë¦¬ì ëª¨ë“œì—ì„œ ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
        }
      }

      // ========== ê´€ë¦¬ì ìƒì‚°ì‹œì„¤ ê´€ë¦¬ í•¨ìˆ˜ ==========

      function showManageFacilitiesModal() {
        if (!isAdminLoggedIn) {
          showStatus("ê´€ë¦¬ì ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.", "error");
          return;
        }
        renderFacilitiesList();
        document.getElementById("manageFacilitiesModal").style.display =
          "block";
      }

      function renderFacilitiesList() {
        const facilitiesList = document.getElementById("facilitiesList");
        facilitiesList.innerHTML = "";

        if (facilitiesData.length === 0) {
          facilitiesList.innerHTML =
            '<p style="text-align: center; color: #666;">ë“±ë¡ëœ ìƒì‚°ì‹œì„¤ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }

        facilitiesData.forEach((facility, index) => {
          const facilityDiv = document.createElement("div");
          facilityDiv.style.cssText =
            "display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; border: 1px solid #e9ecef; border-radius: 4px; margin-bottom: 8px; background-color: #f8f9fa;";

          const itemCount = inventoryData.filter(
            (item) => item.ìƒì‚°ì‹œì„¤ === facility
          ).length;
          const canDelete = itemCount === 0;

          facilityDiv.innerHTML = `
                    <div>
                        <strong>${facility}</strong>
                        <small style="color: #666; margin-left: 10px;">(í’ˆëª© ${itemCount}ê°œ)</small>
                    </div>
                    <div>
                        <button class="btn btn-warning" onclick="editFacility(${index})" style="padding: 4px 8px; font-size: 11px; margin-right: 5px;">ìˆ˜ì •</button>
                        <button class="btn btn-danger" onclick="deleteFacility(${index})" 
                                ${
                                  canDelete
                                    ? ""
                                    : 'disabled title="í’ˆëª©ì´ ìˆëŠ” ìƒì‚°ì‹œì„¤ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."'
                                } 
                                style="padding: 4px 8px; font-size: 11px;">ì‚­ì œ</button>
                    </div>
                `;
          facilitiesList.appendChild(facilityDiv);
        });
      }

      async function editFacility(index) {
        const facility = facilitiesData[index];
        const newName = prompt(`ìƒì‚°ì‹œì„¤ëª…ì„ ìˆ˜ì •í•˜ì„¸ìš”:`, facility);

        if (newName === null) return;
        if (!newName.trim()) {
          showStatus("ìƒì‚°ì‹œì„¤ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", "error");
          return;
        }

        const trimmedName = newName.trim();
        if (trimmedName === facility) return;

        if (facilitiesData.includes(trimmedName)) {
          showStatus("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ìƒì‚°ì‹œì„¤ëª…ì…ë‹ˆë‹¤.", "error");
          return;
        }

        // ê¸°ì¡´ í’ˆëª©ë“¤ì˜ ìƒì‚°ì‹œì„¤ëª…ë„ í•¨ê»˜ ë³€ê²½
        inventoryData.forEach((item) => {
          if (item.ìƒì‚°ì‹œì„¤ === facility) {
            item.ìƒì‚°ì‹œì„¤ = trimmedName;
          }
        });

        // ì´ë ¥ ë°ì´í„°ì˜ ìƒì‚°ì‹œì„¤ëª…ë„ ë³€ê²½
        historyData.forEach((item) => {
          if (item.ìƒì‚°ì‹œì„¤ === facility) {
            item.ìƒì‚°ì‹œì„¤ = trimmedName;
          }
        });

        facilitiesData[index] = trimmedName;

        // Firebaseì— ì €ì¥
        await saveFacilitiesToFirebase();
        await saveInventoryToFirebase();

        // ëª¨ë“  ì´ë ¥ ë°ì´í„° ì—…ë°ì´íŠ¸
        if (isFirebaseConnected) {
          const batch = db.batch();
          historyData.forEach((item) => {
            const docRef = db.collection("history").doc(item.No.toString());
            batch.set(docRef, item);
          });
          await batch.commit();
        }

        // localStorageì—ë„ ì €ì¥
        localStorage.setItem("facilitiesData", JSON.stringify(facilitiesData));
        localStorage.setItem("inventoryData", JSON.stringify(inventoryData));
        localStorage.setItem("requestHistory", JSON.stringify(historyData));

        updateFacilityOptions();
        renderFacilitiesList();
        renderAllTables();

        showStatus(
          `âœ… ìƒì‚°ì‹œì„¤ "${facility}"ì´(ê°€) "${trimmedName}"(ìœ¼)ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`,
          "success"
        );
      }

      async function deleteFacility(index) {
        const facility = facilitiesData[index];
        const itemCount = inventoryData.filter(
          (item) => item.ìƒì‚°ì‹œì„¤ === facility
        ).length;

        if (itemCount > 0) {
          showStatus(
            `${facility}ì— ${itemCount}ê°œì˜ í’ˆëª©ì´ ìˆì–´ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ê´€ë ¨ í’ˆëª©ì„ ì‚­ì œí•´ì£¼ì„¸ìš”.`,
            "error"
          );
          return;
        }

        if (
          confirm(
            `ìƒì‚°ì‹œì„¤ "${facility}"ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`
          )
        ) {
          facilitiesData.splice(index, 1);

          // Firebaseì— ì €ì¥
          await saveFacilitiesToFirebase();

          // localStorageì—ë„ ì €ì¥
          localStorage.setItem(
            "facilitiesData",
            JSON.stringify(facilitiesData)
          );

          updateFacilityOptions();
          renderFacilitiesList();

          showStatus(
            `âœ… ìƒì‚°ì‹œì„¤ "${facility}"ì´(ê°€) ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`,
            "success"
          );
        }
      }

      // ========== ê´€ë¦¬ì í’ˆëª© ê´€ë¦¬ í•¨ìˆ˜ ==========

      function showManageItemsModal() {
        if (!isAdminLoggedIn) {
          showStatus("ê´€ë¦¬ì ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.", "error");
          return;
        }
        updateManageItemsFacilityOptions();
        renderManageItemsTable();
        document.getElementById("manageItemsModal").style.display = "block";
      }

      function updateManageItemsFacilityOptions() {
        const filterSelect = document.getElementById("itemsFilterFacility");
        filterSelect.innerHTML = '<option value="">ì „ì²´ ìƒì‚°ì‹œì„¤</option>';

        facilitiesData.forEach((facility) => {
          const option = document.createElement("option");
          option.value = facility;
          option.textContent = facility;
          filterSelect.appendChild(option);
        });
      }

      function filterManageItems() {
        renderManageItemsTable();
      }

      function renderManageItemsTable() {
        const tbody = document.getElementById("manageItemsTableBody");
        const filterFacility = document.getElementById(
          "itemsFilterFacility"
        ).value;
        tbody.innerHTML = "";

        let filteredData = inventoryData;
        if (filterFacility) {
          filteredData = inventoryData.filter(
            (item) => item.ìƒì‚°ì‹œì„¤ === filterFacility
          );
        }

        if (filteredData.length === 0) {
          const row = document.createElement("tr");
          row.innerHTML =
            '<td colspan="6" style="text-align: center; color: #666;">í’ˆëª©ì´ ì—†ìŠµë‹ˆë‹¤.</td>';
          tbody.appendChild(row);
          return;
        }

        filteredData.forEach((item, index) => {
          const globalIndex = inventoryData.indexOf(item);
          const row = document.createElement("tr");
          row.innerHTML = `
                    <td>${item.ìƒì‚°ì‹œì„¤}</td>
                    <td>${item.í’ˆëª©}</td>
                    <td>${item.ê·œê²©}</td>
                    <td>${item.ìˆ˜ëŸ‰}</td>
                    <td>${item.ë‹¨ìœ„}</td>
                    <td>
                        <button class="btn btn-warning" onclick="showEditItemModal(${globalIndex})" 
                                style="padding: 4px 8px; font-size: 10px; margin-right: 4px;">ìˆ˜ì •</button>
                        <button class="btn btn-danger" onclick="deleteItem(${globalIndex})" 
                                style="padding: 4px 8px; font-size: 10px;">ì‚­ì œ</button>
                    </td>
                `;
          tbody.appendChild(row);
        });
      }

      function showEditItemModal(index) {
        const item = inventoryData[index];
        document.getElementById("editItemIndex").value = index;

        // ìƒì‚°ì‹œì„¤ ì˜µì…˜ ì—…ë°ì´íŠ¸
        const facilitySelect = document.getElementById("editItemFacility");
        facilitySelect.innerHTML = '<option value="">ìƒì‚°ì‹œì„¤ ì„ íƒ</option>';
        facilitiesData.forEach((facility) => {
          const option = document.createElement("option");
          option.value = facility;
          option.textContent = facility;
          if (facility === item.ìƒì‚°ì‹œì„¤) option.selected = true;
          facilitySelect.appendChild(option);
        });

        document.getElementById("editItemName").value = item.í’ˆëª©;
        document.getElementById("editItemSpec").value = item.ê·œê²©;
        document.getElementById("editItemQuantity").value = item.ìˆ˜ëŸ‰;
        document.getElementById("editItemUnit").value = item.ë‹¨ìœ„;

        document.getElementById("editItemModal").style.display = "block";
      }

      async function updateItem() {
        const index = parseInt(document.getElementById("editItemIndex").value);
        const facility = document.getElementById("editItemFacility").value;
        const name = document.getElementById("editItemName").value.trim();
        const spec = document.getElementById("editItemSpec").value.trim();
        const quantity =
          parseInt(document.getElementById("editItemQuantity").value) || 0;
        const unit = document.getElementById("editItemUnit").value;

        if (!facility || !name || !spec) {
          showStatus("ëª¨ë“  í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", "error");
          return;
        }

        const originalItem = inventoryData[index];

        // ì¤‘ë³µ ê²€ì‚¬ (ìê¸° ìì‹  ì œì™¸)
        const duplicateItem = inventoryData.find(
          (item, i) =>
            i !== index &&
            item.ìƒì‚°ì‹œì„¤ === facility &&
            item.í’ˆëª© === name &&
            item.ê·œê²© === spec
        );

        if (duplicateItem) {
          showStatus(
            "ë™ì¼í•œ ìƒì‚°ì‹œì„¤ì— ê°™ì€ í’ˆëª©ê³¼ ê·œê²©ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.",
            "error"
          );
          return;
        }

        // í’ˆëª© ì •ë³´ ì—…ë°ì´íŠ¸
        inventoryData[index] = {
          í’ˆëª©: name,
          ê·œê²©: spec,
          ìˆ˜ëŸ‰: quantity,
          ë‹¨ìœ„: unit,
          ìƒì‚°ì‹œì„¤: facility,
        };

        // Firebaseì— ì €ì¥
        await saveInventoryToFirebase();
        localStorage.setItem("inventoryData", JSON.stringify(inventoryData));

        renderManageItemsTable();
        renderAllTables();
        closeModal("editItemModal");

        showStatus(
          `âœ… í’ˆëª© "${originalItem.í’ˆëª©}"ì´(ê°€) ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`,
          "success"
        );
      }

      async function deleteItem(index) {
        const item = inventoryData[index];

        if (
          confirm(
            `í’ˆëª© "${item.í’ˆëª©}"ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nìƒì‚°ì‹œì„¤: ${item.ìƒì‚°ì‹œì„¤}\nê·œê²©: ${item.ê·œê²©}\ní˜„ì¬ìˆ˜ëŸ‰: ${item.ìˆ˜ëŸ‰}${item.ë‹¨ìœ„}\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`
          )
        ) {
          inventoryData.splice(index, 1);

          // Firebaseì— ì €ì¥
          await saveInventoryToFirebase();
          localStorage.setItem("inventoryData", JSON.stringify(inventoryData));

          renderManageItemsTable();
          renderAllTables();

          showStatus(`âœ… í’ˆëª© "${item.í’ˆëª©}"ì´(ê°€) ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, "success");
        }
      }

      // ========== ìƒì‚°ì‹œì„¤ ê´€ë¦¬ í•¨ìˆ˜ ==========

      async function addFacility() {
        const facilityName = document
          .getElementById("newFacilityName")
          .value.trim();

        if (!facilityName) {
          showStatus("ìƒì‚°ì‹œì„¤ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", "error");
          return;
        }

        if (facilitiesData.includes(facilityName)) {
          showStatus("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ìƒì‚°ì‹œì„¤ì…ë‹ˆë‹¤.", "error");
          return;
        }

        facilitiesData.push(facilityName);

        // Firebaseì— ì €ì¥
        await saveFacilitiesToFirebase();

        // localStorageì—ë„ ì €ì¥
        localStorage.setItem("facilitiesData", JSON.stringify(facilitiesData));

        updateFacilityOptions();
        closeModal("addFacilityModal");

        showStatus(
          `âœ… ìƒì‚°ì‹œì„¤ "${facilityName}"ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`,
          "success"
        );
      }

      function updateFacilityOptions() {
        // ëŒ€ìƒ ìƒì‚°ì‹œì„¤ select ì˜µì…˜ ì—…ë°ì´íŠ¸
        const targetFacilitySelect = document.getElementById("targetFacility");
        const currentValue = targetFacilitySelect.value;

        // ê¸°ì¡´ ì˜µì…˜ ì¤‘ "ì „ì²´ ì‹œì„¤" ì œì™¸í•˜ê³  ëª¨ë‘ ì œê±°
        while (targetFacilitySelect.children.length > 1) {
          targetFacilitySelect.removeChild(targetFacilitySelect.lastChild);
        }

        facilitiesData.forEach((facility) => {
          const option = document.createElement("option");
          option.value = facility;
          option.textContent = facility;
          targetFacilitySelect.appendChild(option);
        });

        // ì´ì „ ì„ íƒê°’ ë³µì›
        if (currentValue && facilitiesData.includes(currentValue)) {
          targetFacilitySelect.value = currentValue;
        }
      }

      function updateItemFacilityOptions() {
        const itemFacilitySelect = document.getElementById("itemFacility");
        itemFacilitySelect.innerHTML =
          '<option value="">ìƒì‚°ì‹œì„¤ ì„ íƒ</option>';

        facilitiesData.forEach((facility) => {
          const option = document.createElement("option");
          option.value = facility;
          option.textContent = facility;
          itemFacilitySelect.appendChild(option);
        });
      }

      // ========== í’ˆëª© ê´€ë¦¬ í•¨ìˆ˜ ==========

      async function addItem() {
        const facility = document.getElementById("itemFacility").value;
        const name = document.getElementById("itemName").value.trim();
        const spec = document.getElementById("itemSpec").value.trim();
        const quantity =
          parseInt(document.getElementById("itemQuantity").value) || 0;
        const unit = document.getElementById("itemUnit").value;

        if (!facility) {
          showStatus("ìƒì‚°ì‹œì„¤ì„ ì„ íƒí•´ì£¼ì„¸ìš”.", "error");
          return;
        }

        if (!name) {
          showStatus("í’ˆëª©ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", "error");
          return;
        }

        if (!spec) {
          showStatus("ê·œê²©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", "error");
          return;
        }

        // ì¤‘ë³µ í’ˆëª© ê²€ì‚¬ (ê°™ì€ ìƒì‚°ì‹œì„¤, ê°™ì€ í’ˆëª©ëª…, ê°™ì€ ê·œê²©)
        const existingItem = inventoryData.find(
          (item) =>
            item.ìƒì‚°ì‹œì„¤ === facility &&
            item.í’ˆëª© === name &&
            item.ê·œê²© === spec
        );

        if (existingItem) {
          showStatus(
            "ë™ì¼í•œ ìƒì‚°ì‹œì„¤ì— ê°™ì€ í’ˆëª©ê³¼ ê·œê²©ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.",
            "error"
          );
          return;
        }

        const newItem = {
          í’ˆëª©: name,
          ê·œê²©: spec,
          ìˆ˜ëŸ‰: quantity,
          ë‹¨ìœ„: unit,
          ìƒì‚°ì‹œì„¤: facility,
        };

        inventoryData.push(newItem);

        // Firebaseì— ì €ì¥
        await saveInventoryToFirebase();

        // localStorageì—ë„ ì €ì¥
        localStorage.setItem("inventoryData", JSON.stringify(inventoryData));

        renderAllTables();
        closeModal("addItemModal");

        showStatus(
          `âœ… í’ˆëª© "${name}"ì´ ${facility}ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`,
          "success"
        );
      }

      async function resetToDefault() {
        if (!isAdminLoggedIn) {
          showStatus("ë°ì´í„° ë¦¬ì…‹ì€ ê´€ë¦¬ì ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.", "error");
          return;
        }
        if (
          confirm(
            "âš ï¸ ë³´ê´€í’ˆ ë°ì´í„° ë¦¬ì…‹\n\në³´ê´€í’ˆ ìˆ˜ëŸ‰ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ë˜ëŒë¦½ë‹ˆë‹¤.\n(ì…ê³ ì´ë ¥ê³¼ ìƒì‚°ì‹œì„¤ì€ ìœ ì§€ë©ë‹ˆë‹¤)\n\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"
          )
        ) {
          inventoryData = getDefaultInventoryData();

          // Firebaseì— ì €ì¥
          await saveInventoryToFirebase();
          localStorage.setItem("inventoryData", JSON.stringify(inventoryData));

          lastRegisteredRequest = null;

          renderInventoryTable();
          renderRequestTable();

          showStatus(
            "âœ… ë³´ê´€í’ˆ ë°ì´í„°ê°€ ê¸°ë³¸ê°’ìœ¼ë¡œ ë¦¬ì…‹ë˜ê³  ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.",
            "success"
          );
        }
      }

      async function clearAllData() {
        if (!isAdminLoggedIn) {
          showStatus("ë°ì´í„° ì´ˆê¸°í™”ëŠ” ê´€ë¦¬ì ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.", "error");
          return;
        }
        if (
          confirm(
            "âš ï¸ ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”\n\në‹¤ìŒ ì‘ì—…ì´ ìˆ˜í–‰ë©ë‹ˆë‹¤:\nâ€¢ ëª¨ë“  ì…ê³  ì´ë ¥ ì‚­ì œ\nâ€¢ ë³´ê´€í’ˆ ìˆ˜ëŸ‰ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ë¦¬ì…‹\nâ€¢ ìƒì‚°ì‹œì„¤ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ë¦¬ì…‹\nâ€¢ ì €ì¥ëœ ëª¨ë“  ë°ì´í„° ì‚­ì œ\n\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"
          )
        ) {
          historyData = [];
          historyCounter = 1;
          inventoryData = getDefaultInventoryData();
          facilitiesData = getDefaultFacilities();

          // Firebase ì´ˆê¸°í™”
          if (isFirebaseConnected) {
            try {
              // ëª¨ë“  ì´ë ¥ ë°ì´í„° ì‚­ì œ
              const historySnapshot = await db.collection("history").get();
              const batch = db.batch();
              historySnapshot.docs.forEach((doc) => {
                batch.delete(doc.ref);
              });
              await batch.commit();

              // ì¹´ìš´í„° ë¦¬ì…‹
              await db.collection("settings").doc("counter").set({ value: 1 });

              // ìƒì‚°ì‹œì„¤ ë¦¬ì…‹
              await saveFacilitiesToFirebase();

              // ë³´ê´€í’ˆ ë°ì´í„° ë¦¬ì…‹
              await saveInventoryToFirebase();
            } catch (error) {
              console.error("Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:", error);
            }
          }

          // localStorage ì´ˆê¸°í™”
          localStorage.removeItem("requestHistory");
          localStorage.removeItem("historyCounter");
          localStorage.setItem("inventoryData", JSON.stringify(inventoryData));
          localStorage.setItem(
            "facilitiesData",
            JSON.stringify(facilitiesData)
          );

          updateFacilityOptions();
          renderAllTables();

          showStatus(
            "âœ… ëª¨ë“  ë°ì´í„°ê°€ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ê³  ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.",
            "success"
          );
        }
      }

      function filterHistory() {
        const startDate = document.getElementById("filterStartDate").value;
        const endDate = document.getElementById("filterEndDate").value;

        if (!startDate || !endDate) {
          showStatus("ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.", "error");
          return;
        }

        let filteredData = historyData.filter((item) => {
          const itemDate = item.ì…ê³ ì¼;
          return itemDate >= startDate && itemDate <= endDate;
        });

        if (currentFacilityFilter) {
          filteredData = filteredData.filter(
            (item) => item.ìƒì‚°ì‹œì„¤ === currentFacilityFilter
          );
        }

        renderHistoryTable(filteredData);
        showStatus(
          `${filteredData.length}ê±´ì˜ ì´ë ¥ì´ í•„í„°ë§ë˜ì—ˆìŠµë‹ˆë‹¤.`,
          "success"
        );
      }

      function clearFilter() {
        document.getElementById("filterStartDate").value = "";
        document.getElementById("filterEndDate").value = "";
        renderHistoryTable();
        showStatus("í•„í„°ê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
      }

      function printCurrentSheet() {
        const activeSheet = document.querySelector(".sheet-content.active");
        if (!activeSheet) {
          showStatus("ì¸ì‡„í•  ì‹œíŠ¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.", "error");
          return;
        }

        updatePrintInfo();
        document.querySelectorAll(".sheet-content").forEach((sheet) => {
          sheet.classList.remove("print-target");
        });
        activeSheet.classList.add("print-target");
        window.print();
        showStatus("ì¸ì‡„ ë‹¤ì´ì–¼ë¡œê·¸ê°€ ì—´ë ¸ìŠµë‹ˆë‹¤.", "success");
      }

      function printRequestForm() {
        if (
          !lastRegisteredRequest ||
          lastRegisteredRequest.items.length === 0
        ) {
          showStatus(
            "ë“±ë¡ëœ ì…ê³  ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì…ê³  ìš”ì²­ì„ ë“±ë¡í•´ì£¼ì„¸ìš”.",
            "error"
          );
          return;
        }

        const requestSheet = document.getElementById("sheet-ì…ê³ ìš”ì²­ì„œ");
        const originalTable = requestSheet.querySelector(
          ".editable-table tbody"
        );
        const originalContent = originalTable.innerHTML;

        originalTable.innerHTML = "";
        lastRegisteredRequest.items.forEach((item) => {
          const row = document.createElement("tr");
          const remainingClass = item.ì”ëŸ‰ < 0 ? "negative-value" : "";
          row.innerHTML = `
                    <td>${item.No}</td>
                    <td>${item.ìƒì‚°ì‹œì„¤}</td>
                    <td>${item.í’ˆëª©}</td>
                    <td>${item.ê·œê²©}</td>
                    <td>${item.ì´ˆê¸°ìˆ˜ëŸ‰.toLocaleString()}</td>
                    <td>${item.ì…ê³ ìˆ˜ëŸ‰.toLocaleString()}</td>
                    <td class="${remainingClass}">${item.ì”ëŸ‰.toLocaleString()}</td>
                    <td style="font-size: 10px;">${item.ë“±ë¡ì¼ì‹œ}</td>
                `;
          originalTable.appendChild(row);
        });

        updatePrintInfo();
        document.querySelectorAll(".sheet-content").forEach((sheet) => {
          sheet.classList.remove("print-target");
        });
        requestSheet.classList.add("print-target");
        window.print();

        setTimeout(() => {
          originalTable.innerHTML = originalContent;
          requestSheet.classList.remove("print-target");
        }, 100);

        showStatus(
          `ë§ˆì§€ë§‰ ë“±ë¡ëœ ì…ê³ ìš”ì²­ì„œ ì¸ì‡„ (${lastRegisteredRequest.items.length}ê°œ í’ˆëª©)`,
          "success"
        );
      }

      function previewPrint() {
        if (
          !lastRegisteredRequest ||
          lastRegisteredRequest.items.length === 0
        ) {
          showStatus(
            "ë“±ë¡ëœ ì…ê³  ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì…ê³  ìš”ì²­ì„ ë“±ë¡í•´ì£¼ì„¸ìš”.",
            "error"
          );
          return;
        }

        const previewWindow = window.open("", "_blank", "width=800,height=600");

        let previewHtml = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>ì…ê³ ìš”ì²­ì„œ ë¯¸ë¦¬ë³´ê¸°</title>
                    <style>
                        body { font-family: 'Malgun Gothic', Arial, sans-serif; padding: 20px; }
                        .header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 10px; }
                        .info { margin-bottom: 15px; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { border: 1px solid #333; padding: 8px; text-align: center; font-size: 12px; }
                        th { background-color: #f1f3f4; font-weight: bold; }
                        .negative-value { background-color: #fde8e8; color: #c53030; }
                        .footer { text-align: right; margin-top: 30px; }
                        .btn { padding: 10px 20px; margin: 5px; cursor: pointer; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h2>ì…ê³ ìš”ì²­ì„œ</h2>
                    </div>
                    <div class="info">
                        <div>ìƒì‚°ì‹œì„¤: ${
                          lastRegisteredRequest.targetFacility ||
                          "ì „ì²´ ìƒì‚°ì‹œì„¤"
                        }</div>
                        <div>ì…ê³ ìš”ì²­ì¼: ${
                          lastRegisteredRequest.requestDate
                        }</div>
                        <div>ìš”ì²­ê¸°ê´€: ${
                          lastRegisteredRequest.facilityName
                        }</div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>ìƒì‚°ì‹œì„¤</th>
                                <th>í’ˆëª©</th>
                                <th>ê·œê²©</th>
                                <th>ì´ˆê¸°ìˆ˜ëŸ‰</th>
                                <th>ì…ê³ ìˆ˜ëŸ‰</th>
                                <th>ì”ëŸ‰</th>
                                <th>ë“±ë¡ì¼ì‹œ</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

        lastRegisteredRequest.items.forEach((item) => {
          const remainingClass = item.ì”ëŸ‰ < 0 ? "negative-value" : "";
          previewHtml += `
                    <tr>
                        <td>${item.No}</td>
                        <td>${item.ìƒì‚°ì‹œì„¤}</td>
                        <td>${item.í’ˆëª©}</td>
                        <td>${item.ê·œê²©}</td>
                        <td>${item.ì´ˆê¸°ìˆ˜ëŸ‰.toLocaleString()}</td>
                        <td>${item.ì…ê³ ìˆ˜ëŸ‰.toLocaleString()}</td>
                        <td class="${remainingClass}">${item.ì”ëŸ‰.toLocaleString()}</td>
                        <td>${item.ë“±ë¡ì¼ì‹œ}</td>
                    </tr>
                `;
        });

        previewHtml += `
                        </tbody>
                    </table>
                    <div class="footer">
                        <div>ë‹´ë‹¹ì: _______________</div>
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn" onclick="window.print()">ì¸ì‡„í•˜ê¸°</button>
                        <button class="btn" onclick="window.close()">ë‹«ê¸°</button>
                    </div>
                </body>
                </html>
            `;

        previewWindow.document.write(previewHtml);
        previewWindow.document.close();
        showStatus("ì¸ì‡„ ë¯¸ë¦¬ë³´ê¸° ì°½ì´ ì—´ë ¸ìŠµë‹ˆë‹¤.", "success");
      }

      function updatePrintInfo() {
        const currentDate = new Date().toLocaleDateString("ko-KR");
        const facilityName = document.getElementById("facilityName").value;
        const requestDate = document.getElementById("requestDate").value;
        const targetFacility = document.getElementById("targetFacility").value;

        document.getElementById("print-date-inventory").textContent =
          currentDate;
        document.getElementById("print-org-inventory").textContent =
          facilityName;
        document.getElementById("print-facility-request").textContent =
          targetFacility || "ì „ì²´ ìƒì‚°ì‹œì„¤";
        document.getElementById("print-date-request").textContent =
          requestDate || currentDate;
        document.getElementById("print-org-request").textContent = facilityName;
        document.getElementById("print-date-history").textContent = currentDate;
        document.getElementById("print-org-history").textContent = facilityName;
      }

      function exportToExcel() {
        try {
          const wb = XLSX.utils.book_new();

          const inventoryWS = XLSX.utils.json_to_sheet(inventoryData);
          XLSX.utils.book_append_sheet(wb, inventoryWS, "ë³´ê´€í’ˆ");

          if (historyData.length > 0) {
            const historyForExport = historyData.map((item) => ({
              ...item,
              ê·œê²©: getHistoryItemSpec(item),
            }));
            const historyWS = XLSX.utils.json_to_sheet(historyForExport);
            XLSX.utils.book_append_sheet(wb, historyWS, "ì…ê³ ì´ë ¥");
          }

          const fileName = `ì…ê³ ê´€ë¦¬_Firebase_${
            new Date().toISOString().split("T")[0]
          }.xlsx`;
          XLSX.writeFile(wb, fileName);

          showStatus("ì—‘ì…€ íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!", "success");
        } catch (error) {
          console.error("ì—‘ì…€ ë‚´ë³´ë‚´ê¸° ì˜¤ë¥˜:", error);
          showStatus("ì—‘ì…€ ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "error");
        }
      }

      // ========== ì´ˆê¸°í™” ==========

      document.addEventListener("DOMContentLoaded", function () {
        setCurrentDate();
        updateFacilityFilterDisplay();
      });
    </script>
  </body>
</html>
