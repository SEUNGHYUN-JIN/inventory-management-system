<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>입고요청서 관리시스템</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', 'Malgun Gothic', Arial, sans-serif;
            line-height: 1.4;
            background-color: #f8f9fa;
            color: #333;
        }
        
        /* 로그인 화면 스타일 */
        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .login-card {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
            max-width: 400px;
        }
        
        .login-card h2 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .login-card p {
            color: #666;
            margin-bottom: 30px;
        }
        
        .google-login-btn {
            background: #4285f4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
            margin-bottom: 20px;
            transition: background-color 0.2s;
        }
        
        .google-login-btn:hover {
            background: #357abd;
        }
        
        /* 메인 컨테이너 */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            min-height: 100vh;
            display: none; /* 초기에는 숨김 */
        }
        
        .container.authenticated {
            display: block; /* 로그인 후 표시 */
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px 30px;
            border-bottom: 4px solid #3498db;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-left h1 {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .header-left p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.1);
            padding: 8px 15px;
            border-radius: 20px;
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.3);
        }
        
        .user-details {
            display: flex;
            flex-direction: column;
        }
        
        .user-name {
            font-size: 14px;
            font-weight: 500;
        }
        
        .user-role {
            font-size: 11px;
            opacity: 0.8;
        }
        
        .btn-logout {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .readonly-notice {
            background: #fff3cd;
            color: #856404;
            padding: 10px 15px;
            border-radius: 4px;
            font-size: 13px;
            margin: 15px 30px;
            display: none;
        }
        
        .firebase-status {
            background: #e8f5e8;
            padding: 15px 30px;
            border-bottom: 1px solid #d4edda;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .firebase-status.connecting {
            background: #fff3cd;
            border-color: #ffeaa7;
        }
        
        .firebase-status.error {
            background: #f8d7da;
            border-color: #f5c6cb;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #28a745;
            animation: pulse 2s infinite;
        }
        
        .status-dot.connecting {
            background: #ffc107;
        }
        
        .status-dot.error {
            background: #dc3545;
            animation: none;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .sync-info {
            font-size: 12px;
            color: #666;
        }
        
        .form-section {
            background-color: #ffffff;
            padding: 25px 30px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .form-section h3 {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
            padding-left: 12px;
        }
        
        .controls {
            background-color: #f8f9fa;
            padding: 15px 30px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .btn {
            background-color: #495057;
            color: white;
            border: none;
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 500;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn:hover {
            background-color: #343a40;
            transform: translateY(-1px);
        }
        
        .btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-primary {
            background-color: #2980b9;
        }
        
        .btn-primary:hover {
            background-color: #1e6091;
        }
        
        .btn-success {
            background-color: #27ae60;
        }
        
        .btn-success:hover {
            background-color: #1e8449;
        }
        
        .btn-info {
            background-color: #17a2b8;
        }
        
        .btn-info:hover {
            background-color: #117a8b;
        }
        
        .btn-warning {
            background-color: #f39c12;
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #d68910;
        }
        
        .btn-danger {
            background-color: #e74c3c;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #495057;
            font-size: 13px;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 3px;
            font-size: 13px;
            background-color: white;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
        }
        
        .row {
            display: flex;
            gap: 20px;
        }
        
        .col {
            flex: 1;
        }
        
        .sheet-tabs {
            background-color: #f8f9fa;
            display: flex;
            border-bottom: 1px solid #dee2e6;
            padding: 0 30px;
        }
        
        .sheet-tab {
            padding: 12px 20px;
            background-color: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 500;
            font-size: 13px;
            color: #495057;
            transition: all 0.2s ease;
        }
        
        .sheet-tab.active {
            color: #2980b9;
            border-bottom-color: #2980b9;
            background-color: white;
        }
        
        .sheet-tab:hover:not(.active) {
            color: #2980b9;
            background-color: #e9ecef;
        }
        
        .sheet-content {
            display: none;
            padding: 30px;
        }
        
        .sheet-content.active {
            display: block;
        }
        
        .summary-card {
            background-color: #f8f9fa;
            padding: 20px;
            border-left: 4px solid #3498db;
            margin-bottom: 25px;
            border-radius: 0 4px 4px 0;
        }
        
        .summary-card h4 {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        
        .summary-card p {
            font-size: 13px;
            color: #6c757d;
            margin-bottom: 5px;
        }
        
        .editable-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .editable-table th {
            background-color: #f1f3f4;
            color: #495057;
            font-weight: 600;
            padding: 12px 8px;
            text-align: center;
            border: 1px solid #dee2e6;
            font-size: 12px;
        }
        
        .editable-table td {
            padding: 10px 8px;
            border: 1px solid #dee2e6;
            text-align: center;
            vertical-align: middle;
        }
        
        .editable-table td:nth-child(2),
        .editable-table td:nth-child(3) {
            text-align: left;
            padding-left: 12px;
        }
        
        .editable-table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .editable-input {
            width: 100%;
            border: none;
            background: transparent;
            padding: 4px 6px;
            text-align: center;
            font-size: 12px;
            border-radius: 2px;
        }
        
        .editable-input:focus {
            background-color: #fff3cd;
            border: 1px solid #ffc107;
            outline: none;
        }
        
        .calculated-cell {
            background-color: #e8f4f8;
            font-weight: 500;
        }
        
        .negative-value {
            background-color: #fde8e8;
            color: #c53030;
            font-weight: 600;
        }
        
        .group-header {
            background-color: #e3f2fd !important;
            font-weight: 600 !important;
            color: #1565c0 !important;
        }
        
        .status {
            margin: 15px 30px;
            padding: 12px 16px;
            border-radius: 4px;
            display: none;
            font-size: 13px;
        }
        
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .history-filters {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        
        .history-filters label {
            font-weight: 500;
            color: #495057;
            font-size: 13px;
        }
        
        .history-filters input {
            padding: 6px 10px;
            border: 1px solid #ced4da;
            border-radius: 3px;
            font-size: 12px;
        }
        
        .filter-highlight {
            background-color: #e3f2fd;
            color: #1565c0;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 600;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 14px;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .print-header, .print-info, .print-footer {
            display: none;
        }
        
        /* 읽기 전용 모드 스타일 */
        .readonly .editable-input {
            background-color: #f8f9fa !important;
            cursor: not-allowed !important;
        }
        
        .readonly .btn-primary,
        .readonly .btn-warning,
        .readonly .btn-danger {
            display: none !important;
        }
        
        @media print {
            body {
                background-color: white !important;
                padding: 0 !important;
                margin: 0 !important;
            }
            
            .container {
                box-shadow: none !important;
                padding: 10px !important;
                margin: 0 !important;
                max-width: none !important;
            }
            
            .header, .form-section, .controls, .sheet-tabs, .status, .summary-card, .history-filters, .firebase-status {
                display: none !important;
            }
            
            .sheet-content {
                display: block !important;
                border: none !important;
                padding: 0 !important;
            }
            
            .sheet-content:not(.print-target) {
                display: none !important;
            }
            
            .print-header {
                display: block !important;
                text-align: center;
                margin-bottom: 20px;
                font-size: 18px;
                font-weight: bold;
                color: #000;
            }
            
            .print-info {
                display: block !important;
                margin-bottom: 15px;
                font-size: 12px;
                color: #000;
            }
            
            .print-footer {
                display: block !important;
                text-align: right;
                margin-top: 30px;
                font-size: 12px;
                color: #000;
            }
            
            .editable-table {
                font-size: 10px !important;
            }
            
            .editable-table th, .editable-table td {
                padding: 4px !important;
                border: 1px solid #000 !important;
            }
            
            .btn {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <!-- 로그인 화면 -->
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <h2>🔐 입고요청서 관리시스템</h2>
            <p>시스템에 접근하려면 Google 계정으로 로그인하세요</p>
            <button class="google-login-btn" onclick="signInWithGoogle()">
                <svg width="20" height="20" viewBox="0 0 24 24">
                    <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Google로 로그인
            </button>
            <div style="font-size: 12px; color: #666;">
                🔒 로그인 후 시스템을 사용할 수 있습니다<br>
                📋 소유자는 편집 가능, 다른 사용자는 열람만 가능
            </div>
        </div>
    </div>

    <!-- 메인 컨테이너 -->
    <div class="container" id="mainContainer">
        <div class="header">
            <div class="header-left">
                <h1>입고요청서 관리시스템</h1>
                <p>Inventory Request Management System v4.0 - Auth Edition</p>
                <p style="font-size: 12px; opacity: 0.8; margin-top: 5px;">작성일: <span id="current-date"></span></p>
            </div>
            <div class="header-right">
                <div id="userInfo" class="user-info">
                    <img id="userAvatar" class="user-avatar" src="" alt="User">
                    <div class="user-details">
                        <div id="userName" class="user-name"></div>
                        <div id="userRole" class="user-role"></div>
                    </div>
                </div>
                <button class="btn-logout" onclick="signOut()">로그아웃</button>
            </div>
        </div>
        
        <!-- Firebase 연결 상태 -->
        <div id="firebase-status" class="firebase-status connecting">
            <div class="status-indicator">
                <div id="status-dot" class="status-dot connecting"></div>
                <span id="status-text">Firebase 연결 중...</span>
            </div>
            <div class="sync-info">
                <span id="sync-info">마지막 동기화: 연결 중</span>
            </div>
        </div>
        
        <!-- 읽기 전용 알림 -->
        <div id="readonlyNotice" class="readonly-notice">
            🔒 현재 열람 모드입니다. 데이터를 수정할 수 없습니다.
        </div>
        
        <div class="form-section">
            <h3>기본 정보 설정</h3>
            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <label for="targetFacility">대상 생산시설</label>
                        <select id="targetFacility" onchange="filterByFacility()">
                            <option value="">전체 시설</option>
                            <option value="동원직업재활원">동원직업재활원</option>
                            <option value="학산보호작업장">학산보호작업장</option>
                            <option value="누리봄">누리봄</option>
                        </select>
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label for="facilityName">요청 기관명</label>
                        <input type="text" id="facilityName" value="경상남도 장애인생산품판매시설">
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label for="requestDate">입고요청일</label>
                        <input type="date" id="requestDate">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <button class="btn btn-primary" onclick="addRequestHistory()">입고 요청 등록</button>
            <button class="btn btn-info" onclick="printCurrentSheet()">현재 시트 인쇄</button>
            <button class="btn btn-info" onclick="printRequestForm()">입고요청서 인쇄</button>
            <button class="btn btn-info" onclick="previewPrint()">인쇄 미리보기</button>
            <button class="btn btn-success" onclick="exportToExcel()">엑셀로 내보내기</button>
            <button class="btn btn-warning" onclick="syncNow()">수동 동기화</button>
            <button class="btn btn-warning" onclick="clearAllData()">데이터 초기화</button>
            <button class="btn btn-danger" onclick="resetToDefault()">기본값 리셋</button>
        </div>
        
        <div id="status" class="status"></div>
        
        <div class="sheet-tabs">
            <div class="sheet-tab active" onclick="showSheet('보관품')">보관품 현황</div>
            <div class="sheet-tab" onclick="showSheet('입고요청서')">입고요청서</div>
            <div class="sheet-tab" onclick="showSheet('입고이력')">입고이력</div>
        </div>
        
        <!-- 보관품 시트 -->
        <div id="sheet-보관품" class="sheet-content active">
            <div class="print-header">보관품 현황표</div>
            <div class="print-info">
                <div>작성일: <span id="print-date-inventory"></span></div>
                <div>작성기관: <span id="print-org-inventory"></span></div>
            </div>
            
            <div class="summary-card">
                <h4>보관품 현황</h4>
                <p>실시간 동기화되는 보관품 정보입니다. 수정사항이 모든 기기에 즉시 반영됩니다.</p>
                <p id="inventoryFilter">현재 표시: <strong>전체 생산시설</strong></p>
            </div>
            
            <div id="inventory-loading" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p>보관품 데이터를 불러오는 중...</p>
            </div>
            
            <table class="editable-table">
                <thead>
                    <tr>
                        <th style="width: 25%;">생산시설</th>
                        <th style="width: 30%;">품목</th>
                        <th style="width: 25%;">규격</th>
                        <th style="width: 10%;">수량</th>
                        <th style="width: 10%;">단위</th>
                    </tr>
                </thead>
                <tbody id="inventory-tbody">
                </tbody>
            </table>
            
            <div class="print-footer">
                <div>담당자: _______________</div>
            </div>
        </div>
        
        <!-- 입고요청서 시트 -->
        <div id="sheet-입고요청서" class="sheet-content">
            <div class="print-header">입고요청서</div>
            <div class="print-info">
                <div>생산시설: <span id="print-facility-request"></span></div>
                <div>입고요청일: <span id="print-date-request"></span></div>
                <div>요청기관: <span id="print-org-request"></span></div>
            </div>
            
            <div class="summary-card">
                <h4>입고요청서 작성</h4>
                <p><strong>잔량 = 초기수량 - 입고수량</strong> | 모든 변경사항이 실시간으로 동기화됩니다.</p>
                <p id="facilityFilter">현재 표시: <strong>전체 생산시설</strong></p>
            </div>
            
            <table class="editable-table">
                <thead>
                    <tr>
                        <th style="width: 6%;">No</th>
                        <th style="width: 16%;">생산시설</th>
                        <th style="width: 18%;">품목</th>
                        <th style="width: 16%;">규격</th>
                        <th style="width: 10%;">초기수량</th>
                        <th style="width: 11%;">입고수량</th>
                        <th style="width: 11%;">잔량</th>
                        <th style="width: 12%;">작성일시</th>
                    </tr>
                </thead>
                <tbody id="request-tbody">
                </tbody>
            </table>
            
            <div class="print-footer">
                <div>담당자: _______________</div>
            </div>
        </div>
        
        <!-- 입고이력 시트 -->
        <div id="sheet-입고이력" class="sheet-content">
            <div class="print-header">입고이력 관리대장</div>
            <div class="print-info">
                <div>출력일: <span id="print-date-history"></span></div>
                <div>관리기관: <span id="print-org-history"></span></div>
            </div>
            
            <div class="summary-card">
                <h4>입고이력 관리</h4>
                <p>모든 기기에서 실시간으로 공유되는 입고 이력입니다.</p>
                <p id="historyFilter">현재 표시: <strong>전체 생산시설</strong></p>
            </div>
            
            <div class="history-filters">
                <label>기간 필터:</label>
                <input type="date" id="filterStartDate">
                <span>~</span>
                <input type="date" id="filterEndDate">
                <button class="btn" onclick="filterHistory()">필터 적용</button>
                <button class="btn btn-warning" onclick="clearFilter()">필터 해제</button>
            </div>
            
            <table class="editable-table">
                <thead>
                    <tr>
                        <th style="width: 5%;">No</th>
                        <th style="width: 10%;">입고일</th>
                        <th style="width: 13%;">생산시설</th>
                        <th style="width: 13%;">요청기관</th>
                        <th style="width: 16%;">품목</th>
                        <th style="width: 8%;">입고수량</th>
                        <th style="width: 8%;">초기수량</th>
                        <th style="width: 8%;">잔량</th>
                        <th style="width: 11%;">등록일시</th>
                        <th style="width: 8%;">작업</th>
                    </tr>
                </thead>
                <tbody id="history-tbody">
                </tbody>
            </table>
            
            <div class="print-footer">
                <div>담당자: _______________</div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        // ========== Firebase 설정 ==========
        const firebaseConfig = {
            apiKey: "AIzaSyDYxnj8yec_fyxggZ4TJ1H2MtcBrrZVYMQ",
            authDomain: "inventory-management-212d7.firebaseapp.com",
            projectId: "inventory-management-212d7",
            storageBucket: "inventory-management-212d7.firebasestorage.app",
            messagingSenderId: "808033831667",
            appId: "1:808033831667:web:e5633736dcb054703c4586"
        };
        
        // Firebase 초기화
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        let db;
        let isFirebaseConnected = false;
        
        // 전역 변수
        let currentUser = null;
        let isOwner = false;
        
        // 소유자 이메일 (🔥 본인 Gmail 주소로 변경하세요!)
        const OWNER_EMAIL = 'jinsha85@gmail.com';
        
        // 인증 상태 변화 감지
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                isOwner = user.email === OWNER_EMAIL;
                showMainContent();
                updateUserInfo();
                initializeFirestore();
            } else {
                currentUser = null;
                isOwner = false;
                showLoginScreen();
            }
        });
        
        // 로그인 화면 표시
        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainContainer').classList.remove('authenticated');
        }
        
        // 메인 컨텐츠 표시
        function showMainContent() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainContainer').classList.add('authenticated');
            
            // 읽기 전용 모드 설정
            if (!isOwner) {
                document.body.classList.add('readonly');
                document.getElementById('readonlyNotice').style.display = 'block';
            } else {
                document.body.classList.remove('readonly');
                document.getElementById('readonlyNotice').style.display = 'none';
            }
        }
        
        // 사용자 정보 업데이트
        function updateUserInfo() {
            if (currentUser) {
                document.getElementById('userName').textContent = currentUser.displayName || currentUser.email;
                document.getElementById('userRole').textContent = isOwner ? '관리자' : '열람자';
                document.getElementById('userAvatar').src = currentUser.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.displayName || currentUser.email)}`;
            }
        }
        
        // Google 로그인
        async function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                await auth.signInWithPopup(provider);
            } catch (error) {
                console.error('로그인 실패:', error);
                alert('로그인에 실패했습니다: ' + error.message);
            }
        }
        
        // 로그아웃
        async function signOut() {
            try {
                await auth.signOut();
            } catch (error) {
                console.error('로그아웃 실패:', error);
            }
        }
        
        // Firestore 초기화
        function initializeFirestore() {
            try {
                db = firebase.firestore();
                
                // Firestore 연결 테스트
                db.enableNetwork().then(() => {
                    setFirebaseStatus('connected', 'Firebase 연결됨 (실시간 동기화)');
                    isFirebaseConnected = true;
                    loadDataFromFirebase();
                }).catch((error) => {
                    setFirebaseStatus('error', 'Firebase 연결 실패: ' + error.message);
                    loadDataFromLocalStorage();
                });
                
            } catch (error) {
                console.error('Firebase 초기화 실패:', error);
                setFirebaseStatus('error', 'Firebase 연결 실패 (localStorage 모드)');
                loadDataFromLocalStorage();
            }
        }
        
        // ========== 데이터 모델 ==========
        let inventoryData = [];
        let historyData = [];
        let historyCounter = 1;
        let currentFacilityFilter = '';
        let lastRegisteredRequest = null;
        
        // ========== Firebase 데이터 함수 ==========
        
        // Firebase에서 데이터 불러오기
        async function loadDataFromFirebase() {
            if (!isFirebaseConnected) {
                loadDataFromLocalStorage();
                return;
            }
            
            try {
                showLoading(true);
                
                // 보관품 데이터 불러오기
                const inventoryDoc = await db.collection('inventory').doc('current').get();
                if (inventoryDoc.exists) {
                    inventoryData = inventoryDoc.data().items || getDefaultInventoryData();
                } else {
                    inventoryData = getDefaultInventoryData();
                    if (isOwner) await saveInventoryToFirebase();
                }
                
                // 입고이력 데이터 불러오기
                const historySnapshot = await db.collection('history').orderBy('No').get();
                historyData = [];
                historySnapshot.forEach(doc => {
                    historyData.push(doc.data());
                });
                
                // 이력 카운터 불러오기
                const counterDoc = await db.collection('settings').doc('counter').get();
                if (counterDoc.exists) {
                    historyCounter = counterDoc.data().value || 1;
                } else if (isOwner) {
                    await db.collection('settings').doc('counter').set({ value: 1 });
                }
                
                // 실시간 리스너 설정
                setupRealtimeListeners();
                
                showLoading(false);
                renderAllTables();
            
            const facilityMsg = targetFacility ? `${targetFacility}의 ` : '';
            showStatus(`${facilityMsg}입고 요청 ${requestCount}건이 등록되고 동기화되었습니다.`, 'success');
        }
        
        async function deleteHistory(no) {
            if (!requireOwnerPermission()) return;
            
            const historyItem = historyData.find(item => item.No === no);
            if (!historyItem) return;
            
            if (confirm(`이 이력을 삭제하시겠습니까?\n\n📋 삭제 대상:\n• 품목: ${historyItem.품목}\n• 생산시설: ${historyItem.생산시설}\n• 입고수량: ${historyItem.입고수량}\n\n⚠️ 삭제 시 해당 품목의 수량이 ${historyItem.입고수량}만큼 증가합니다.`)) {
                
                const inventoryItem = inventoryData.find(item => 
                    item.품목 === historyItem.품목 && item.생산시설 === historyItem.생산시설
                );
                
                let restoredQuantity = 0;
                if (inventoryItem) {
                    inventoryItem.수량 += historyItem.입고수량;
                    restoredQuantity = inventoryItem.수량;
                }
                
                historyData = historyData.filter(item => item.No !== no);
                
                // Firebase에서 삭제
                await deleteHistoryFromFirebase(no);
                await saveInventoryToFirebase();
                
                // localStorage 업데이트
                localStorage.setItem('requestHistory', JSON.stringify(historyData));
                localStorage.setItem('inventoryData', JSON.stringify(inventoryData));
                
                renderAllTables();
                
                showStatus(`✅ 이력이 삭제되고 "${historyItem.품목}" 수량이 ${restoredQuantity}로 복원되었습니다.`, 'success');
            }
        }
        
        // ========== 기타 함수들 ==========
        
        function syncNow() {
            if (isFirebaseConnected) {
                loadDataFromFirebase();
                showStatus('수동 동기화가 완료되었습니다.', 'success');
            } else {
                showStatus('Firebase 연결이 필요합니다.', 'error');
            }
        }
        
        function getDefaultInventoryData() {
            return [
                {
                    품목: "점보롤화장지/천연펄프(동원)",
                    규격: "250M*2겹*16롤",
                    수량: 100,
                    단위: "박스",
                    생산시설: "동원직업재활원"
                },
                {
                    품목: "롤화장지(동원)", 
                    규격: "3겹/35m*30롤",
                    수량: 300,
                    단위: "팩",
                    생산시설: "동원직업재활원"
                },
                {
                    품목: "사각티슈 250매(동원)",
                    규격: "1박스(24개입)",
                    수량: 300,
                    단위: "박스",
                    생산시설: "동원직업재활원"
                },
                {
                    품목: "생분해물티슈",
                    규격: "10개입/캡형",
                    수량: 240,
                    단위: "박스",
                    생산시설: "학산보호작업장"
                },
                {
                    품목: "프리미엄",
                    규격: "10개입",
                    수량: 600,
                    단위: "박스",
                    생산시설: "학산보호작업장"
                },
                {
                    품목: "종이컵",
                    규격: "6.5온스",
                    수량: 320,
                    단위: "박스",
                    생산시설: "누리봄"
                }
            ];
        }
        
        async function resetToDefault() {
            if (!requireOwnerPermission()) return;
            
            if (confirm('⚠️ 보관품 데이터 리셋\n\n보관품 수량을 기본값으로 되돌립니다.\n(입고이력은 유지됩니다)\n\n계속하시겠습니까?')) {
                
                inventoryData = getDefaultInventoryData();
                
                // Firebase에 저장
                await saveInventoryToFirebase();
                localStorage.setItem('inventoryData', JSON.stringify(inventoryData));
                
                lastRegisteredRequest = null;
                
                renderInventoryTable();
                renderRequestTable();
                
                showStatus('✅ 보관품 데이터가 기본값으로 리셋되고 동기화되었습니다.', 'success');
            }
        }
        
        async function clearAllData() {
            if (!requireOwnerPermission()) return;
            
            if (confirm('⚠️ 모든 데이터 초기화\n\n다음 작업이 수행됩니다:\n• 모든 입고 이력 삭제\n• 보관품 수량을 기본값으로 리셋\n• 저장된 모든 데이터 삭제\n\n계속하시겠습니까?')) {
                
                historyData = [];
                historyCounter = 1;
                inventoryData = getDefaultInventoryData();
                
                // Firebase 초기화
                if (isFirebaseConnected) {
                    try {
                        // 모든 이력 데이터 삭제
                        const historySnapshot = await db.collection('history').get();
                        const batch = db.batch();
                        historySnapshot.docs.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                        await batch.commit();
                        
                        // 카운터 리셋
                        await db.collection('settings').doc('counter').set({ value: 1 });
                        
                        // 보관품 데이터 리셋
                        await saveInventoryToFirebase();
                    } catch (error) {
                        console.error('Firebase 초기화 실패:', error);
                    }
                }
                
                // localStorage 초기화
                localStorage.removeItem('requestHistory');
                localStorage.removeItem('historyCounter');
                localStorage.setItem('inventoryData', JSON.stringify(inventoryData));
                
                renderAllTables();
                
                showStatus('✅ 모든 데이터가 기본값으로 초기화되고 동기화되었습니다.', 'success');
            }
        }
        
        function filterHistory() {
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            
            if (!startDate || !endDate) {
                showStatus('시작일과 종료일을 모두 입력해주세요.', 'error');
                return;
            }

            let filteredData = historyData.filter(item => {
                const itemDate = item.입고일;
                return itemDate >= startDate && itemDate <= endDate;
            });

            if (currentFacilityFilter) {
                filteredData = filteredData.filter(item => item.생산시설 === currentFacilityFilter);
            }

            renderHistoryTable(filteredData);
            showStatus(`${filteredData.length}건의 이력이 필터링되었습니다.`, 'success');
        }
        
        function clearFilter() {
            document.getElementById('filterStartDate').value = '';
            document.getElementById('filterEndDate').value = '';
            renderHistoryTable();
            showStatus('필터가 해제되었습니다.', 'success');
        }
        
        function printCurrentSheet() {
            const activeSheet = document.querySelector('.sheet-content.active');
            if (!activeSheet) {
                showStatus('인쇄할 시트를 선택해주세요.', 'error');
                return;
            }
            
            updatePrintInfo();
            document.querySelectorAll('.sheet-content').forEach(sheet => {
                sheet.classList.remove('print-target');
            });
            activeSheet.classList.add('print-target');
            window.print();
            showStatus('인쇄 다이얼로그가 열렸습니다.', 'success');
        }
        
        function printRequestForm() {
            if (!lastRegisteredRequest || lastRegisteredRequest.items.length === 0) {
                showStatus('등록된 입고 요청이 없습니다. 먼저 입고 요청을 등록해주세요.', 'error');
                return;
            }

            const requestSheet = document.getElementById('sheet-입고요청서');
            const originalTable = requestSheet.querySelector('.editable-table tbody');
            const originalContent = originalTable.innerHTML;
            
            originalTable.innerHTML = '';
            lastRegisteredRequest.items.forEach(item => {
                const row = document.createElement('tr');
                const remainingClass = item.잔량 < 0 ? 'negative-value' : '';
                row.innerHTML = `
                    <td>${item.No}</td>
                    <td>${item.생산시설}</td>
                    <td>${item.품목}</td>
                    <td>${item.규격}</td>
                    <td>${item.초기수량.toLocaleString()}</td>
                    <td>${item.입고수량.toLocaleString()}</td>
                    <td class="${remainingClass}">${item.잔량.toLocaleString()}</td>
                    <td style="font-size: 10px;">${item.등록일시}</td>
                `;
                originalTable.appendChild(row);
            });

            updatePrintInfo();
            document.querySelectorAll('.sheet-content').forEach(sheet => {
                sheet.classList.remove('print-target');
            });
            requestSheet.classList.add('print-target');
            window.print();

            setTimeout(() => {
                originalTable.innerHTML = originalContent;
                requestSheet.classList.remove('print-target');
            }, 100);

            showStatus(`마지막 등록된 입고요청서 인쇄 (${lastRegisteredRequest.items.length}개 품목)`, 'success');
        }
        
        function previewPrint() {
            if (!lastRegisteredRequest || lastRegisteredRequest.items.length === 0) {
                showStatus('등록된 입고 요청이 없습니다. 먼저 입고 요청을 등록해주세요.', 'error');
                return;
            }

            const previewWindow = window.open('', '_blank', 'width=800,height=600');
            
            let previewHtml = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>입고요청서 미리보기</title>
                    <style>
                        body { font-family: 'Malgun Gothic', Arial, sans-serif; padding: 20px; }
                        .header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 10px; }
                        .info { margin-bottom: 15px; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { border: 1px solid #333; padding: 8px; text-align: center; font-size: 12px; }
                        th { background-color: #f1f3f4; font-weight: bold; }
                        .negative-value { background-color: #fde8e8; color: #c53030; }
                        .footer { text-align: right; margin-top: 30px; }
                        .btn { padding: 10px 20px; margin: 5px; cursor: pointer; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h2>입고요청서</h2>
                    </div>
                    <div class="info">
                        <div>생산시설: ${lastRegisteredRequest.targetFacility || '전체 생산시설'}</div>
                        <div>입고요청일: ${lastRegisteredRequest.requestDate}</div>
                        <div>요청기관: ${lastRegisteredRequest.facilityName}</div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>생산시설</th>
                                <th>품목</th>
                                <th>규격</th>
                                <th>초기수량</th>
                                <th>입고수량</th>
                                <th>잔량</th>
                                <th>등록일시</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            lastRegisteredRequest.items.forEach(item => {
                const remainingClass = item.잔량 < 0 ? 'negative-value' : '';
                previewHtml += `
                    <tr>
                        <td>${item.No}</td>
                        <td>${item.생산시설}</td>
                        <td>${item.품목}</td>
                        <td>${item.규격}</td>
                        <td>${item.초기수량.toLocaleString()}</td>
                        <td>${item.입고수량.toLocaleString()}</td>
                        <td class="${remainingClass}">${item.잔량.toLocaleString()}</td>
                        <td>${item.등록일시}</td>
                    </tr>
                `;
            });

            previewHtml += `
                        </tbody>
                    </table>
                    <div class="footer">
                        <div>담당자: _______________</div>
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn" onclick="window.print()">인쇄하기</button>
                        <button class="btn" onclick="window.close()">닫기</button>
                    </div>
                </body>
                </html>
            `;

            previewWindow.document.write(previewHtml);
            previewWindow.document.close();
            showStatus('인쇄 미리보기 창이 열렸습니다.', 'success');
        }
        
        function updatePrintInfo() {
            const currentDate = new Date().toLocaleDateString('ko-KR');
            const facilityName = document.getElementById('facilityName').value;
            const requestDate = document.getElementById('requestDate').value;
            const targetFacility = document.getElementById('targetFacility').value;

            document.getElementById('print-date-inventory').textContent = currentDate;
            document.getElementById('print-org-inventory').textContent = facilityName;
            document.getElementById('print-facility-request').textContent = targetFacility || '전체 생산시설';
            document.getElementById('print-date-request').textContent = requestDate || currentDate;
            document.getElementById('print-org-request').textContent = facilityName;
            document.getElementById('print-date-history').textContent = currentDate;
            document.getElementById('print-org-history').textContent = facilityName;
        }
        
        function exportToExcel() {
            try {
                const wb = XLSX.utils.book_new();
                
                const inventoryWS = XLSX.utils.json_to_sheet(inventoryData);
                XLSX.utils.book_append_sheet(wb, inventoryWS, '보관품');
                
                if (historyData.length > 0) {
                    const historyWS = XLSX.utils.json_to_sheet(historyData);
                    XLSX.utils.book_append_sheet(wb, historyWS, '입고이력');
                }
                
                const fileName = `입고관리_Auth_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showStatus('엑셀 파일이 다운로드되었습니다!', 'success');
                
            } catch (error) {
                console.error('엑셀 내보내기 오류:', error);
                showStatus('엑셀 내보내기 중 오류가 발생했습니다.', 'error');
            }
        }
        
        // ========== 초기화 ==========
        
        document.addEventListener('DOMContentLoaded', function() {
            setCurrentDate();
            updateFacilityFilterDisplay();
            
            // Firebase 연결이 안 된 경우 로컬 데이터 로드
            setTimeout(() => {
                if (!isFirebaseConnected && currentUser) {
                    loadDataFromLocalStorage();
                }
            }, 5000);
        });
        
    </script>
</body>
</html>();
                setFirebaseStatus('connected', 'Firebase 연결됨 (실시간 동기화)');
                
            } catch (error) {
                console.error('Firebase 데이터 로드 실패:', error);
                setFirebaseStatus('error', 'Firebase 데이터 로드 실패');
                loadDataFromLocalStorage();
            }
        }
        
        // Firebase에 보관품 데이터 저장
        async function saveInventoryToFirebase() {
            if (!isFirebaseConnected || !isOwner) return;
            
            try {
                await db.collection('inventory').doc('current').set({
                    items: inventoryData,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                setFirebaseStatus('connected', 'Firebase 연결됨 (저장됨)');
                setTimeout(() => {
                    setFirebaseStatus('connected', 'Firebase 연결됨 (실시간 동기화)');
                }, 2000);
                
            } catch (error) {
                console.error('Firebase 저장 실패:', error);
                showStatus('Firebase 저장 실패: ' + error.message, 'error');
            }
        }
        
        // Firebase에 입고이력 추가
        async function addHistoryToFirebase(historyItem) {
            if (!isFirebaseConnected || !isOwner) return;
            
            try {
                await db.collection('history').doc(historyItem.No.toString()).set(historyItem);
                await db.collection('settings').doc('counter').set({ value: historyCounter });
                
            } catch (error) {
                console.error('Firebase 이력 저장 실패:', error);
                showStatus('Firebase 이력 저장 실패: ' + error.message, 'error');
            }
        }
        
        // Firebase에서 입고이력 삭제
        async function deleteHistoryFromFirebase(no) {
            if (!isFirebaseConnected || !isOwner) return;
            
            try {
                await db.collection('history').doc(no.toString()).delete();
                
            } catch (error) {
                console.error('Firebase 이력 삭제 실패:', error);
                showStatus('Firebase 이력 삭제 실패: ' + error.message, 'error');
            }
        }
        
        // 실시간 리스너 설정
        function setupRealtimeListeners() {
            if (!isFirebaseConnected) return;
            
            // 보관품 데이터 실시간 감지
            db.collection('inventory').doc('current').onSnapshot((doc) => {
                if (doc.exists) {
                    const newData = doc.data().items || [];
                    if (JSON.stringify(newData) !== JSON.stringify(inventoryData)) {
                        inventoryData = newData;
                        renderInventoryTable();
                        renderRequestTable();
                        showStatus('보관품 데이터가 다른 기기에서 업데이트되었습니다.', 'success');
                    }
                }
            }, (error) => {
                console.error('실시간 리스너 오류:', error);
            });
            
            // 입고이력 실시간 감지
            db.collection('history').onSnapshot((snapshot) => {
                const newHistoryData = [];
                snapshot.forEach(doc => {
                    newHistoryData.push(doc.data());
                });
                
                newHistoryData.sort((a, b) => a.No - b.No);
                
                if (JSON.stringify(newHistoryData) !== JSON.stringify(historyData)) {
                    historyData = newHistoryData;
                    renderHistoryTable();
                    showStatus('입고이력이 다른 기기에서 업데이트되었습니다.', 'success');
                }
            }, (error) => {
                console.error('이력 실시간 리스너 오류:', error);
            });
        }
        
        // localStorage에서 데이터 불러오기 (폴백)
        function loadDataFromLocalStorage() {
            const savedInventory = localStorage.getItem('inventoryData');
            const savedHistory = localStorage.getItem('requestHistory');
            const savedCounter = localStorage.getItem('historyCounter');
            
            if (savedInventory) {
                inventoryData = JSON.parse(savedInventory);
            } else {
                inventoryData = getDefaultInventoryData();
            }
            
            if (savedHistory) {
                historyData = JSON.parse(savedHistory);
            }
            
            if (savedCounter) {
                historyCounter = parseInt(savedCounter);
            }
            
            showLoading(false);
            renderAllTables();
        }
        
        // ========== UI 함수 ==========
        
        function showLoading(show) {
            const loadingElements = document.querySelectorAll('.loading');
            const tables = document.querySelectorAll('.editable-table');
            
            loadingElements.forEach(el => {
                el.style.display = show ? 'block' : 'none';
            });
            
            tables.forEach(table => {
                table.style.display = show ? 'none' : 'table';
            });
        }
        
        function getCurrentDateTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            
            return `${year}-${month}-${day} ${hours}:${minutes}`;
        }
        
        function setCurrentDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            
            document.getElementById('requestDate').value = `${year}-${month}-${day}`;
            
            const koreanDate = `${year}년 ${month}월 ${day}일`;
            document.getElementById('current-date').textContent = koreanDate;
        }
        
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        }
        
        // Firebase 상태 업데이트
        function setFirebaseStatus(status, message) {
            const statusContainer = document.getElementById('firebase-status');
            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');
            const syncInfo = document.getElementById('sync-info');
            
            statusContainer.className = `firebase-status ${status}`;
            statusDot.className = `status-dot ${status}`;
            statusText.textContent = message;
            
            if (status === 'connected') {
                syncInfo.textContent = `마지막 동기화: ${new Date().toLocaleTimeString()}`;
            } else {
                syncInfo.textContent = '동기화 불가 (로컬 모드)';
            }
        }
        
        function showSheet(sheetName) {
            document.querySelectorAll('.sheet-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.sheet-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`sheet-${sheetName}`).classList.add('active');
        }
        
        function filterByFacility() {
            currentFacilityFilter = document.getElementById('targetFacility').value;
            renderInventoryTable();
            renderRequestTable();
            renderHistoryTable();
            updateFacilityFilterDisplay();
        }
        
        function updateFacilityFilterDisplay() {
            const filterText = currentFacilityFilter 
                ? `<span class="filter-highlight">${currentFacilityFilter}</span>`
                : `<strong>전체 생산시설</strong>`;
            
            ['facilityFilter', 'inventoryFilter', 'historyFilter'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.innerHTML = `현재 표시: ${filterText}`;
                }
            });
        }
        
        function renderAllTables() {
            renderInventoryTable();
            renderRequestTable();
            renderHistoryTable();
            updateFacilityFilterDisplay();
        }
        
        // ========== 테이블 렌더링 함수들 ==========
        
        function renderInventoryTable() {
            const tbody = document.getElementById('inventory-tbody');
            tbody.innerHTML = '';
            
            const filteredData = currentFacilityFilter 
                ? inventoryData.filter(item => item.생산시설 === currentFacilityFilter)
                : inventoryData;
            
            if (filteredData.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="5" style="text-align: center; color: #666;">선택된 생산시설에 품목이 없습니다.</td>';
                tbody.appendChild(row);
                return;
            }
            
            if (!currentFacilityFilter) {
                const groupedData = filteredData.reduce((groups, item) => {
                    const facility = item.생산시설;
                    if (!groups[facility]) {
                        groups[facility] = [];
                    }
                    groups[facility].push(item);
                    return groups;
                }, {});

                Object.keys(groupedData).sort().forEach(facility => {
                    const headerRow = document.createElement('tr');
                    headerRow.classList.add('group-header');
                    headerRow.innerHTML = `
                        <td colspan="5" style="text-align: center; padding: 10px;">${facility}</td>
                    `;
                    tbody.appendChild(headerRow);

                    groupedData[facility].forEach((item) => {
                        const globalIndex = inventoryData.indexOf(item);
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${item.생산시설}</td>
                            <td>${item.품목}</td>
                            <td>${item.규격}</td>
                            <td>
                                <input type="number" class="editable-input" value="${item.수량}" 
                                       onchange="updateInventoryQuantity(${globalIndex}, this.value)" style="text-align: center;"
                                       ${!isOwner ? 'disabled' : ''}>
                            </td>
                            <td>${item.단위}</td>
                        `;
                        tbody.appendChild(row);
                    });
                });
            } else {
                filteredData.forEach((item) => {
                    const globalIndex = inventoryData.indexOf(item);
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.생산시설}</td>
                        <td>${item.품목}</td>
                        <td>${item.규격}</td>
                        <td>
                            <input type="number" class="editable-input" value="${item.수량}" 
                                   onchange="updateInventoryQuantity(${globalIndex}, this.value)" style="text-align: center;"
                                   ${!isOwner ? 'disabled' : ''}>
                        </td>
                        <td>${item.단위}</td>
                    `;
                    tbody.appendChild(row);
                });
            }
        }
        
        function renderRequestTable() {
            const tbody = document.getElementById('request-tbody');
            tbody.innerHTML = '';
            
            const filteredData = currentFacilityFilter 
                ? inventoryData.filter(item => item.생산시설 === currentFacilityFilter)
                : inventoryData;

            if (filteredData.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="8" style="text-align: center; color: #666;">선택된 생산시설에 품목이 없습니다.</td>';
                tbody.appendChild(row);
                return;
            }

            if (!currentFacilityFilter) {
                const groupedData = filteredData.reduce((groups, item) => {
                    const facility = item.생산시설;
                    if (!groups[facility]) {
                        groups[facility] = [];
                    }
                    groups[facility].push(item);
                    return groups;
                }, {});

                let rowCounter = 1;
                Object.keys(groupedData).sort().forEach(facility => {
                    const headerRow = document.createElement('tr');
                    headerRow.classList.add('group-header');
                    headerRow.innerHTML = `
                        <td colspan="8" style="text-align: center; padding: 8px;">${facility}</td>
                    `;
                    tbody.appendChild(headerRow);

                    groupedData[facility].forEach((item) => {
                        const globalIndex = inventoryData.indexOf(item);
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${rowCounter++}</td>
                            <td>${item.생산시설}</td>
                            <td>${item.품목}</td>
                            <td>${item.규격}</td>
                            <td class="calculated-cell">${item.수량.toLocaleString()}</td>
                            <td>
                                <input type="number" class="editable-input" placeholder="0" 
                                       id="request-${globalIndex}" onchange="calculateRemaining(${globalIndex})" style="text-align: center;"
                                       ${!isOwner ? 'disabled' : ''}>
                            </td>
                            <td id="remaining-${globalIndex}" class="calculated-cell">-</td>
                            <td style="font-size: 10px; color: #666;">${getCurrentDateTime()}</td>
                        `;
                        tbody.appendChild(row);
                    });
                });
            } else {
                filteredData.forEach((item, index) => {
                    const globalIndex = inventoryData.indexOf(item);
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${item.생산시설}</td>
                        <td>${item.품목}</td>
                        <td>${item.규격}</td>
                        <td class="calculated-cell">${item.수량.toLocaleString()}</td>
                        <td>
                            <input type="number" class="editable-input" placeholder="0" 
                                   id="request-${globalIndex}" onchange="calculateRemaining(${globalIndex})" style="text-align: center;"
                                   ${!isOwner ? 'disabled' : ''}>
                        </td>
                        <td id="remaining-${globalIndex}" class="calculated-cell">-</td>
                        <td style="font-size: 10px; color: #666;">${getCurrentDateTime()}</td>
                    `;
                    tbody.appendChild(row);
                });
            }
        }
        
        function renderHistoryTable(dataToRender = null) {
            const tbody = document.getElementById('history-tbody');
            tbody.innerHTML = '';
            
            let data = dataToRender || historyData;
            
            if (currentFacilityFilter) {
                data = data.filter(item => item.생산시설 === currentFacilityFilter);
            }
            
            data.forEach((item, index) => {
                const row = document.createElement('tr');
                const remainingClass = item.잔량 < 0 ? 'negative-value' : '';
                
                row.innerHTML = `
                    <td>${item.No}</td>
                    <td>${item.입고일}</td>
                    <td>${item.생산시설}</td>
                    <td>${item.요청기관 || '-'}</td>
                    <td>${item.품목}</td>
                    <td>${item.입고수량.toLocaleString()}</td>
                    <td>${item.초기수량.toLocaleString()}</td>
                    <td class="${remainingClass}">${item.잔량.toLocaleString()}</td>
                    <td style="font-size: 10px; color: #666;">${item.등록일시 || '-'}</td>
                    <td>
                        ${isOwner ? `<button class="btn btn-danger" onclick="deleteHistory(${item.No})" style="padding: 4px 8px; font-size: 10px;">삭제</button>` : '-'}
                    </td>
                `;
                tbody.appendChild(row);
            });

            if (data.length === 0) {
                const emptyMessage = currentFacilityFilter 
                    ? `선택된 생산시설(${currentFacilityFilter})의 입고 이력이 없습니다.`
                    : '등록된 입고 이력이 없습니다.';
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="10" style="text-align: center; color: #666;">${emptyMessage}</td>`;
                tbody.appendChild(row);
            }
        }
        
        // ========== 권한 확인 함수 ==========
        
        function requireOwnerPermission() {
            if (!isOwner) {
                showStatus('⚠️ 관리자만 이 작업을 수행할 수 있습니다.', 'error');
                return false;
            }
            return true;
        }
        
        // ========== 데이터 조작 함수들 ==========
        
        async function updateInventoryQuantity(index, newValue) {
            if (!requireOwnerPermission()) return;
            
            const oldValue = inventoryData[index].수량;
            const newQuantity = parseInt(newValue) || 0;
            
            inventoryData[index].수량 = newQuantity;
            
            // Firebase에 저장
            await saveInventoryToFirebase();
            
            // localStorage에도 백업 저장
            localStorage.setItem('inventoryData', JSON.stringify(inventoryData));
            
            renderRequestTable();
            
            const item = inventoryData[index];
            showStatus(`✅ "${item.품목}" 수량이 ${oldValue} → ${newQuantity}로 업데이트되었습니다.`, 'success');
        }
        
        function calculateRemaining(index) {
            const requestInput = document.getElementById(`request-${index}`);
            const remainingCell = document.getElementById(`remaining-${index}`);
            
            if (!requestInput || !remainingCell) return;
            
            const requestQuantity = parseInt(requestInput.value) || 0;
            const currentInventoryQuantity = inventoryData[index].수량;
            const remaining = currentInventoryQuantity - requestQuantity;
            
            remainingCell.textContent = remaining.toLocaleString();
            remainingCell.className = remaining < 0 ? 'calculated-cell negative-value' : 'calculated-cell';
            
            if (remaining < 0) {
                remainingCell.title = `⚠️ 현재 보유량(${currentInventoryQuantity})보다 ${Math.abs(remaining)}개 부족합니다.`;
            } else {
                remainingCell.title = `입고 후 예상 잔량: ${remaining}`;
            }
        }
        
        async function addRequestHistory() {
            if (!requireOwnerPermission()) return;
            
            const facilityName = document.getElementById('facilityName').value;
            const requestDate = document.getElementById('requestDate').value;
            const targetFacility = document.getElementById('targetFacility').value;
            
            if (!facilityName || !requestDate) {
                showStatus('요청 기관명과 입고요청일을 입력해주세요.', 'error');
                return;
            }

            let hasRequests = false;
            let requestCount = 0;
            let updatedItems = [];
            let registeredItems = [];
            
            const dataToProcess = targetFacility 
                ? inventoryData.filter(item => item.생산시설 === targetFacility)
                : inventoryData;

            // 먼저 로컬에서 처리
            dataToProcess.forEach((item) => {
                const globalIndex = inventoryData.indexOf(item);
                const requestInput = document.getElementById(`request-${globalIndex}`);
                const requestQuantity = parseInt(requestInput?.value) || 0;
                
                if (requestQuantity > 0) {
                    hasRequests = true;
                    requestCount++;
                    
                    const previousQuantity = item.수량;
                    const remaining = item.수량 - requestQuantity;
                    
                    const historyItem = {
                        No: historyCounter++,
                        입고일: requestDate,
                        생산시설: item.생산시설,
                        요청기관: facilityName,
                        품목: item.품목,
                        입고수량: requestQuantity,
                        초기수량: previousQuantity,
                        잔량: remaining,
                        등록일시: getCurrentDateTime()
                    };
                    
                    historyData.push(historyItem);
                    inventoryData[globalIndex].수량 = remaining;
                    
                    // Firebase에 저장
                    addHistoryToFirebase(historyItem);
                    
                    updatedItems.push({
                        품목: item.품목,
                        생산시설: item.생산시설,
                        입고전수량: previousQuantity,
                        입고수량: requestQuantity,
                        입고후수량: remaining
                    });

                    registeredItems.push({
                        No: registeredItems.length + 1,
                        생산시설: item.생산시설,
                        품목: item.품목,
                        규격: item.규격,
                        초기수량: previousQuantity,
                        입고수량: requestQuantity,
                        잔량: remaining,
                        등록일시: getCurrentDateTime()
                    });
                    
                    if (requestInput) {
                        requestInput.value = '';
                    }
                    const remainingCell = document.getElementById(`remaining-${globalIndex}`);
                    if (remainingCell) {
                        remainingCell.textContent = '-';
                        remainingCell.className = 'calculated-cell';
                    }
                }
            });

            if (!hasRequests) {
                showStatus('입고수량을 1개 이상 입력해주세요.', 'error');
                return;
            }

            lastRegisteredRequest = {
                facilityName: facilityName,
                requestDate: requestDate,
                targetFacility: targetFacility,
                items: registeredItems
            };

            // Firebase와 localStorage에 저장
            await saveInventoryToFirebase();
            localStorage.setItem('requestHistory', JSON.stringify(historyData));
            localStorage.setItem('historyCounter', historyCounter.toString());
            localStorage.setItem('inventoryData', JSON.stringify(inventoryData));
            
            renderAllTables