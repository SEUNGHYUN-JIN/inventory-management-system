<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì…ê³ ìš”ì²­ì„œ ê´€ë¦¬ì‹œìŠ¤í…œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', 'Malgun Gothic', Arial, sans-serif;
            line-height: 1.4;
            background-color: #f8f9fa;
            color: #333;
        }
        
        /* ë¡œê·¸ì¸ í™”ë©´ ìŠ¤íƒ€ì¼ */
        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .login-card {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
            max-width: 400px;
        }
        
        .login-card h2 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .login-card p {
            color: #666;
            margin-bottom: 30px;
        }
        
        .google-login-btn {
            background: #4285f4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
            margin-bottom: 20px;
            transition: background-color 0.2s;
        }
        
        .google-login-btn:hover {
            background: #357abd;
        }
        
        /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            min-height: 100vh;
            display: none; /* ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€ */
        }
        
        .container.authenticated {
            display: block; /* ë¡œê·¸ì¸ í›„ í‘œì‹œ */
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px 30px;
            border-bottom: 4px solid #3498db;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-left h1 {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .header-left p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.1);
            padding: 8px 15px;
            border-radius: 20px;
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.3);
        }
        
        .user-details {
            display: flex;
            flex-direction: column;
        }
        
        .user-name {
            font-size: 14px;
            font-weight: 500;
        }
        
        .user-role {
            font-size: 11px;
            opacity: 0.8;
        }
        
        .btn-logout {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .readonly-notice {
            background: #fff3cd;
            color: #856404;
            padding: 10px 15px;
            border-radius: 4px;
            font-size: 13px;
            margin: 15px 30px;
            display: none;
        }
        
        .firebase-status {
            background: #e8f5e8;
            padding: 15px 30px;
            border-bottom: 1px solid #d4edda;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .firebase-status.connecting {
            background: #fff3cd;
            border-color: #ffeaa7;
        }
        
        .firebase-status.error {
            background: #f8d7da;
            border-color: #f5c6cb;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #28a745;
            animation: pulse 2s infinite;
        }
        
        .status-dot.connecting {
            background: #ffc107;
        }
        
        .status-dot.error {
            background: #dc3545;
            animation: none;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .sync-info {
            font-size: 12px;
            color: #666;
        }
        
        .form-section {
            background-color: #ffffff;
            padding: 25px 30px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .form-section h3 {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
            padding-left: 12px;
        }
        
        .controls {
            background-color: #f8f9fa;
            padding: 15px 30px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .btn {
            background-color: #495057;
            color: white;
            border: none;
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 500;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn:hover {
            background-color: #343a40;
            transform: translateY(-1px);
        }
        
        .btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-primary {
            background-color: #2980b9;
        }
        
        .btn-primary:hover {
            background-color: #1e6091;
        }
        
        .btn-success {
            background-color: #27ae60;
        }
        
        .btn-success:hover {
            background-color: #1e8449;
        }
        
        .btn-info {
            background-color: #17a2b8;
        }
        
        .btn-info:hover {
            background-color: #117a8b;
        }
        
        .btn-warning {
            background-color: #f39c12;
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #d68910;
        }
        
        .btn-danger {
            background-color: #e74c3c;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #495057;
            font-size: 13px;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 3px;
            font-size: 13px;
            background-color: white;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
        }
        
        .row {
            display: flex;
            gap: 20px;
        }
        
        .col {
            flex: 1;
        }
        
        .sheet-tabs {
            background-color: #f8f9fa;
            display: flex;
            border-bottom: 1px solid #dee2e6;
            padding: 0 30px;
        }
        
        .sheet-tab {
            padding: 12px 20px;
            background-color: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 500;
            font-size: 13px;
            color: #495057;
            transition: all 0.2s ease;
        }
        
        .sheet-tab.active {
            color: #2980b9;
            border-bottom-color: #2980b9;
            background-color: white;
        }
        
        .sheet-tab:hover:not(.active) {
            color: #2980b9;
            background-color: #e9ecef;
        }
        
        .sheet-content {
            display: none;
            padding: 30px;
        }
        
        .sheet-content.active {
            display: block;
        }
        
        .summary-card {
            background-color: #f8f9fa;
            padding: 20px;
            border-left: 4px solid #3498db;
            margin-bottom: 25px;
            border-radius: 0 4px 4px 0;
        }
        
        .summary-card h4 {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        
        .summary-card p {
            font-size: 13px;
            color: #6c757d;
            margin-bottom: 5px;
        }
        
        .editable-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .editable-table th {
            background-color: #f1f3f4;
            color: #495057;
            font-weight: 600;
            padding: 12px 8px;
            text-align: center;
            border: 1px solid #dee2e6;
            font-size: 12px;
        }
        
        .editable-table td {
            padding: 10px 8px;
            border: 1px solid #dee2e6;
            text-align: center;
            vertical-align: middle;
        }
        
        .editable-table td:nth-child(2),
        .editable-table td:nth-child(3) {
            text-align: left;
            padding-left: 12px;
        }
        
        .editable-table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .editable-input {
            width: 100%;
            border: none;
            background: transparent;
            padding: 4px 6px;
            text-align: center;
            font-size: 12px;
            border-radius: 2px;
        }
        
        .editable-input:focus {
            background-color: #fff3cd;
            border: 1px solid #ffc107;
            outline: none;
        }
        
        .calculated-cell {
            background-color: #e8f4f8;
            font-weight: 500;
        }
        
        .negative-value {
            background-color: #fde8e8;
            color: #c53030;
            font-weight: 600;
        }
        
        .group-header {
            background-color: #e3f2fd !important;
            font-weight: 600 !important;
            color: #1565c0 !important;
        }
        
        .status {
            margin: 15px 30px;
            padding: 12px 16px;
            border-radius: 4px;
            display: none;
            font-size: 13px;
        }
        
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .history-filters {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        
        .history-filters label {
            font-weight: 500;
            color: #495057;
            font-size: 13px;
        }
        
        .history-filters input {
            padding: 6px 10px;
            border: 1px solid #ced4da;
            border-radius: 3px;
            font-size: 12px;
        }
        
        .filter-highlight {
            background-color: #e3f2fd;
            color: #1565c0;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 600;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 14px;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .print-header, .print-info, .print-footer {
            display: none;
        }
        
        /* ì½ê¸° ì „ìš© ëª¨ë“œ ìŠ¤íƒ€ì¼ */
        .readonly .editable-input {
            background-color: #f8f9fa !important;
            cursor: not-allowed !important;
        }
        
        .readonly .btn-primary,
        .readonly .btn-warning,
        .readonly .btn-danger {
            display: none !important;
        }
        
        @media print {
            body {
                background-color: white !important;
                padding: 0 !important;
                margin: 0 !important;
            }
            
            .container {
                box-shadow: none !important;
                padding: 10px !important;
                margin: 0 !important;
                max-width: none !important;
            }
            
            .header, .form-section, .controls, .sheet-tabs, .status, .summary-card, .history-filters, .firebase-status {
                display: none !important;
            }
            
            .sheet-content {
                display: block !important;
                border: none !important;
                padding: 0 !important;
            }
            
            .sheet-content:not(.print-target) {
                display: none !important;
            }
            
            .print-header {
                display: block !important;
                text-align: center;
                margin-bottom: 20px;
                font-size: 18px;
                font-weight: bold;
                color: #000;
            }
            
            .print-info {
                display: block !important;
                margin-bottom: 15px;
                font-size: 12px;
                color: #000;
            }
            
            .print-footer {
                display: block !important;
                text-align: right;
                margin-top: 30px;
                font-size: 12px;
                color: #000;
            }
            
            .editable-table {
                font-size: 10px !important;
            }
            
            .editable-table th, .editable-table td {
                padding: 4px !important;
                border: 1px solid #000 !important;
            }
            
            .btn {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <!-- ë¡œê·¸ì¸ í™”ë©´ -->
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <h2>ğŸ” ì…ê³ ìš”ì²­ì„œ ê´€ë¦¬ì‹œìŠ¤í…œ</h2>
            <p>ì‹œìŠ¤í…œì— ì ‘ê·¼í•˜ë ¤ë©´ Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”</p>
            <button class="google-login-btn" onclick="signInWithGoogle()">
                <svg width="20" height="20" viewBox="0 0 24 24">
                    <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Googleë¡œ ë¡œê·¸ì¸
            </button>
            <div style="font-size: 12px; color: #666;">
                ğŸ”’ ë¡œê·¸ì¸ í›„ ì‹œìŠ¤í…œì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤<br>
                ğŸ“‹ ì†Œìœ ìëŠ” í¸ì§‘ ê°€ëŠ¥, ë‹¤ë¥¸ ì‚¬ìš©ìëŠ” ì—´ëŒë§Œ ê°€ëŠ¥
            </div>
        </div>
    </div>

    <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
    <div class="container" id="mainContainer">
        <div class="header">
            <div class="header-left">
                <h1>ì…ê³ ìš”ì²­ì„œ ê´€ë¦¬ì‹œìŠ¤í…œ</h1>
                <p>Inventory Request Management System v4.0 - Auth Edition</p>
                <p style="font-size: 12px; opacity: 0.8; margin-top: 5px;">ì‘ì„±ì¼: <span id="current-date"></span></p>
            </div>
            <div class="header-right">
                <div id="userInfo" class="user-info">
                    <img id="userAvatar" class="user-avatar" src="" alt="User">
                    <div class="user-details">
                        <div id="userName" class="user-name"></div>
                        <div id="userRole" class="user-role"></div>
                    </div>
                </div>
                <button class="btn-logout" onclick="signOut()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
        
        <!-- Firebase ì—°ê²° ìƒíƒœ -->
        <div id="firebase-status" class="firebase-status connecting">
            <div class="status-indicator">
                <div id="status-dot" class="status-dot connecting"></div>
                <span id="status-text">Firebase ì—°ê²° ì¤‘...</span>
            </div>
            <div class="sync-info">
                <span id="sync-info">ë§ˆì§€ë§‰ ë™ê¸°í™”: ì—°ê²° ì¤‘</span>
            </div>
        </div>
        
        <!-- ì½ê¸° ì „ìš© ì•Œë¦¼ -->
        <div id="readonlyNotice" class="readonly-notice">
            ğŸ”’ í˜„ì¬ ì—´ëŒ ëª¨ë“œì…ë‹ˆë‹¤. ë°ì´í„°ë¥¼ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
        </div>
        
        <div class="form-section">
            <h3>ê¸°ë³¸ ì •ë³´ ì„¤ì •</h3>
            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <label for="targetFacility">ëŒ€ìƒ ìƒì‚°ì‹œì„¤</label>
                        <select id="targetFacility" onchange="filterByFacility()">
                            <option value="">ì „ì²´ ì‹œì„¤</option>
                            <option value="ë™ì›ì§ì—…ì¬í™œì›">ë™ì›ì§ì—…ì¬í™œì›</option>
                            <option value="í•™ì‚°ë³´í˜¸ì‘ì—…ì¥">í•™ì‚°ë³´í˜¸ì‘ì—…ì¥</option>
                            <option value="ëˆ„ë¦¬ë´„">ëˆ„ë¦¬ë´„</option>
                        </select>
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label for="facilityName">ìš”ì²­ ê¸°ê´€ëª…</label>
                        <input type="text" id="facilityName" value="ê²½ìƒë‚¨ë„ ì¥ì• ì¸ìƒì‚°í’ˆíŒë§¤ì‹œì„¤">
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label for="requestDate">ì…ê³ ìš”ì²­ì¼</label>
                        <input type="date" id="requestDate">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <button class="btn btn-primary" onclick="addRequestHistory()">ì…ê³  ìš”ì²­ ë“±ë¡</button>
            <button class="btn btn-info" onclick="printCurrentSheet()">í˜„ì¬ ì‹œíŠ¸ ì¸ì‡„</button>
            <button class="btn btn-info" onclick="printRequestForm()">ì…ê³ ìš”ì²­ì„œ ì¸ì‡„</button>
            <button class="btn btn-info" onclick="previewPrint()">ì¸ì‡„ ë¯¸ë¦¬ë³´ê¸°</button>
            <button class="btn btn-success" onclick="exportToExcel()">ì—‘ì…€ë¡œ ë‚´ë³´ë‚´ê¸°</button>
            <button class="btn btn-warning" onclick="syncNow()">ìˆ˜ë™ ë™ê¸°í™”</button>
            <button class="btn btn-warning" onclick="clearAllData()">ë°ì´í„° ì´ˆê¸°í™”</button>
            <button class="btn btn-danger" onclick="resetToDefault()">ê¸°ë³¸ê°’ ë¦¬ì…‹</button>
        </div>
        
        <div id="status" class="status"></div>
        
        <div class="sheet-tabs">
            <div class="sheet-tab active" onclick="showSheet('ë³´ê´€í’ˆ')">ë³´ê´€í’ˆ í˜„í™©</div>
            <div class="sheet-tab" onclick="showSheet('ì…ê³ ìš”ì²­ì„œ')">ì…ê³ ìš”ì²­ì„œ</div>
            <div class="sheet-tab" onclick="showSheet('ì…ê³ ì´ë ¥')">ì…ê³ ì´ë ¥</div>
        </div>
        
        <!-- ë³´ê´€í’ˆ ì‹œíŠ¸ -->
        <div id="sheet-ë³´ê´€í’ˆ" class="sheet-content active">
            <div class="print-header">ë³´ê´€í’ˆ í˜„í™©í‘œ</div>
            <div class="print-info">
                <div>ì‘ì„±ì¼: <span id="print-date-inventory"></span></div>
                <div>ì‘ì„±ê¸°ê´€: <span id="print-org-inventory"></span></div>
            </div>
            
            <div class="summary-card">
                <h4>ë³´ê´€í’ˆ í˜„í™©</h4>
                <p>ì‹¤ì‹œê°„ ë™ê¸°í™”ë˜ëŠ” ë³´ê´€í’ˆ ì •ë³´ì…ë‹ˆë‹¤. ìˆ˜ì •ì‚¬í•­ì´ ëª¨ë“  ê¸°ê¸°ì— ì¦‰ì‹œ ë°˜ì˜ë©ë‹ˆë‹¤.</p>
                <p id="inventoryFilter">í˜„ì¬ í‘œì‹œ: <strong>ì „ì²´ ìƒì‚°ì‹œì„¤</strong></p>
            </div>
            
            <div id="inventory-loading" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p>ë³´ê´€í’ˆ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
            
            <table class="editable-table">
                <thead>
                    <tr>
                        <th style="width: 25%;">ìƒì‚°ì‹œì„¤</th>
                        <th style="width: 30%;">í’ˆëª©</th>
                        <th style="width: 25%;">ê·œê²©</th>
                        <th style="width: 10%;">ìˆ˜ëŸ‰</th>
                        <th style="width: 10%;">ë‹¨ìœ„</th>
                    </tr>
                </thead>
                <tbody id="inventory-tbody">
                </tbody>
            </table>
            
            <div class="print-footer">
                <div>ë‹´ë‹¹ì: _______________</div>
            </div>
        </div>
        
        <!-- ì…ê³ ìš”ì²­ì„œ ì‹œíŠ¸ -->
        <div id="sheet-ì…ê³ ìš”ì²­ì„œ" class="sheet-content">
            <div class="print-header">ì…ê³ ìš”ì²­ì„œ</div>
            <div class="print-info">
                <div>ìƒì‚°ì‹œì„¤: <span id="print-facility-request"></span></div>
                <div>ì…ê³ ìš”ì²­ì¼: <span id="print-date-request"></span></div>
                <div>ìš”ì²­ê¸°ê´€: <span id="print-org-request"></span></div>
            </div>
            
            <div class="summary-card">
                <h4>ì…ê³ ìš”ì²­ì„œ ì‘ì„±</h4>
                <p><strong>ì”ëŸ‰ = ì´ˆê¸°ìˆ˜ëŸ‰ - ì…ê³ ìˆ˜ëŸ‰</strong> | ëª¨ë“  ë³€ê²½ì‚¬í•­ì´ ì‹¤ì‹œê°„ìœ¼ë¡œ ë™ê¸°í™”ë©ë‹ˆë‹¤.</p>
                <p id="facilityFilter">í˜„ì¬ í‘œì‹œ: <strong>ì „ì²´ ìƒì‚°ì‹œì„¤</strong></p>
            </div>
            
            <table class="editable-table">
                <thead>
                    <tr>
                        <th style="width: 6%;">No</th>
                        <th style="width: 16%;">ìƒì‚°ì‹œì„¤</th>
                        <th style="width: 18%;">í’ˆëª©</th>
                        <th style="width: 16%;">ê·œê²©</th>
                        <th style="width: 10%;">ì´ˆê¸°ìˆ˜ëŸ‰</th>
                        <th style="width: 11%;">ì…ê³ ìˆ˜ëŸ‰</th>
                        <th style="width: 11%;">ì”ëŸ‰</th>
                        <th style="width: 12%;">ì‘ì„±ì¼ì‹œ</th>
                    </tr>
                </thead>
                <tbody id="request-tbody">
                </tbody>
            </table>
            
            <div class="print-footer">
                <div>ë‹´ë‹¹ì: _______________</div>
            </div>
        </div>
        
        <!-- ì…ê³ ì´ë ¥ ì‹œíŠ¸ -->
        <div id="sheet-ì…ê³ ì´ë ¥" class="sheet-content">
            <div class="print-header">ì…ê³ ì´ë ¥ ê´€ë¦¬ëŒ€ì¥</div>
            <div class="print-info">
                <div>ì¶œë ¥ì¼: <span id="print-date-history"></span></div>
                <div>ê´€ë¦¬ê¸°ê´€: <span id="print-org-history"></span></div>
            </div>
            
            <div class="summary-card">
                <h4>ì…ê³ ì´ë ¥ ê´€ë¦¬</h4>
                <p>ëª¨ë“  ê¸°ê¸°ì—ì„œ ì‹¤ì‹œê°„ìœ¼ë¡œ ê³µìœ ë˜ëŠ” ì…ê³  ì´ë ¥ì…ë‹ˆë‹¤.</p>
                <p id="historyFilter">í˜„ì¬ í‘œì‹œ: <strong>ì „ì²´ ìƒì‚°ì‹œì„¤</strong></p>
            </div>
            
            <div class="history-filters">
                <label>ê¸°ê°„ í•„í„°:</label>
                <input type="date" id="filterStartDate">
                <span>~</span>
                <input type="date" id="filterEndDate">
                <button class="btn" onclick="filterHistory()">í•„í„° ì ìš©</button>
                <button class="btn btn-warning" onclick="clearFilter()">í•„í„° í•´ì œ</button>
            </div>
            
            <table class="editable-table">
                <thead>
                    <tr>
                        <th style="width: 5%;">No</th>
                        <th style="width: 10%;">ì…ê³ ì¼</th>
                        <th style="width: 13%;">ìƒì‚°ì‹œì„¤</th>
                        <th style="width: 13%;">ìš”ì²­ê¸°ê´€</th>
                        <th style="width: 16%;">í’ˆëª©</th>
                        <th style="width: 8%;">ì…ê³ ìˆ˜ëŸ‰</th>
                        <th style="width: 8%;">ì´ˆê¸°ìˆ˜ëŸ‰</th>
                        <th style="width: 8%;">ì”ëŸ‰</th>
                        <th style="width: 11%;">ë“±ë¡ì¼ì‹œ</th>
                        <th style="width: 8%;">ì‘ì—…</th>
                    </tr>
                </thead>
                <tbody id="history-tbody">
                </tbody>
            </table>
            
            <div class="print-footer">
                <div>ë‹´ë‹¹ì: _______________</div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        // ========== Firebase ì„¤ì • ==========
        const firebaseConfig = {
            apiKey: "AIzaSyDYxnj8yec_fyxggZ4TJ1H2MtcBrrZVYMQ",
            authDomain: "inventory-management-212d7.firebaseapp.com",
            projectId: "inventory-management-212d7",
            storageBucket: "inventory-management-212d7.firebasestorage.app",
            messagingSenderId: "808033831667",
            appId: "1:808033831667:web:e5633736dcb054703c4586"
        };
        
        // Firebase ì´ˆê¸°í™”
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        let db;
        let isFirebaseConnected = false;
        
        // ì „ì—­ ë³€ìˆ˜
        let currentUser = null;
        let isOwner = false;
        
        // ì†Œìœ ì ì´ë©”ì¼ (ğŸ”¥ ë³¸ì¸ Gmail ì£¼ì†Œë¡œ ë³€ê²½í•˜ì„¸ìš”!)
        const OWNER_EMAIL = 'jinsha85@gmail.com';
        
        // ì¸ì¦ ìƒíƒœ ë³€í™” ê°ì§€
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                isOwner = user.email === OWNER_EMAIL;
                showMainContent();
                updateUserInfo();
                initializeFirestore();
            } else {
                currentUser = null;
                isOwner = false;
                showLoginScreen();
            }
        });
        
        // ë¡œê·¸ì¸ í™”ë©´ í‘œì‹œ
        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainContainer').classList.remove('authenticated');
        }
        
        // ë©”ì¸ ì»¨í…ì¸  í‘œì‹œ
        function showMainContent() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainContainer').classList.add('authenticated');
            
            // ì½ê¸° ì „ìš© ëª¨ë“œ ì„¤ì •
            if (!isOwner) {
                document.body.classList.add('readonly');
                document.getElementById('readonlyNotice').style.display = 'block';
            } else {
                document.body.classList.remove('readonly');
                document.getElementById('readonlyNotice').style.display = 'none';
            }
        }
        
        // ì‚¬ìš©ì ì •ë³´ ì—…ë°ì´íŠ¸
        function updateUserInfo() {
            if (currentUser) {
                document.getElementById('userName').textContent = currentUser.displayName || currentUser.email;
                document.getElementById('userRole').textContent = isOwner ? 'ê´€ë¦¬ì' : 'ì—´ëŒì';
                document.getElementById('userAvatar').src = currentUser.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.displayName || currentUser.email)}`;
            }
        }
        
        // Google ë¡œê·¸ì¸
        async function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                await auth.signInWithPopup(provider);
            } catch (error) {
                console.error('ë¡œê·¸ì¸ ì‹¤íŒ¨:', error);
                alert('ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }
        
        // ë¡œê·¸ì•„ì›ƒ
        async function signOut() {
            try {
                await auth.signOut();
            } catch (error) {
                console.error('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:', error);
            }
        }
        
        // Firestore ì´ˆê¸°í™”
        function initializeFirestore() {
            try {
                db = firebase.firestore();
                
                // Firestore ì—°ê²° í…ŒìŠ¤íŠ¸
                db.enableNetwork().then(() => {
                    setFirebaseStatus('connected', 'Firebase ì—°ê²°ë¨ (ì‹¤ì‹œê°„ ë™ê¸°í™”)');
                    isFirebaseConnected = true;
                    loadDataFromFirebase();
                }).catch((error) => {
                    setFirebaseStatus('error', 'Firebase ì—°ê²° ì‹¤íŒ¨: ' + error.message);
                    loadDataFromLocalStorage();
                });
                
            } catch (error) {
                console.error('Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                setFirebaseStatus('error', 'Firebase ì—°ê²° ì‹¤íŒ¨ (localStorage ëª¨ë“œ)');
                loadDataFromLocalStorage();
            }
        }
        
        // ========== ë°ì´í„° ëª¨ë¸ ==========
        let inventoryData = [];
        let historyData = [];
        let historyCounter = 1;
        let currentFacilityFilter = '';
        let lastRegisteredRequest = null;
        
        // ========== Firebase ë°ì´í„° í•¨ìˆ˜ ==========
        
        // Firebaseì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadDataFromFirebase() {
            if (!isFirebaseConnected) {
                loadDataFromLocalStorage();
                return;
            }
            
            try {
                showLoading(true);
                
                // ë³´ê´€í’ˆ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
                const inventoryDoc = await db.collection('inventory').doc('current').get();
                if (inventoryDoc.exists) {
                    inventoryData = inventoryDoc.data().items || getDefaultInventoryData();
                } else {
                    inventoryData = getDefaultInventoryData();
                    if (isOwner) await saveInventoryToFirebase();
                }
                
                // ì…ê³ ì´ë ¥ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
                const historySnapshot = await db.collection('history').orderBy('No').get();
                historyData = [];
                historySnapshot.forEach(doc => {
                    historyData.push(doc.data());
                });
                
                // ì´ë ¥ ì¹´ìš´í„° ë¶ˆëŸ¬ì˜¤ê¸°
                const counterDoc = await db.collection('settings').doc('counter').get();
                if (counterDoc.exists) {
                    historyCounter = counterDoc.data().value || 1;
                } else if (isOwner) {
                    await db.collection('settings').doc('counter').set({ value: 1 });
                }
                
                // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
                setupRealtimeListeners();
                
                showLoading(false);
                renderAllTables();
            
            const facilityMsg = targetFacility ? `${targetFacility}ì˜ ` : '';
            showStatus(`${facilityMsg}ì…ê³  ìš”ì²­ ${requestCount}ê±´ì´ ë“±ë¡ë˜ê³  ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        }
        
        async function deleteHistory(no) {
            if (!requireOwnerPermission()) return;
            
            const historyItem = historyData.find(item => item.No === no);
            if (!historyItem) return;
            
            if (confirm(`ì´ ì´ë ¥ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nğŸ“‹ ì‚­ì œ ëŒ€ìƒ:\nâ€¢ í’ˆëª©: ${historyItem.í’ˆëª©}\nâ€¢ ìƒì‚°ì‹œì„¤: ${historyItem.ìƒì‚°ì‹œì„¤}\nâ€¢ ì…ê³ ìˆ˜ëŸ‰: ${historyItem.ì…ê³ ìˆ˜ëŸ‰}\n\nâš ï¸ ì‚­ì œ ì‹œ í•´ë‹¹ í’ˆëª©ì˜ ìˆ˜ëŸ‰ì´ ${historyItem.ì…ê³ ìˆ˜ëŸ‰}ë§Œí¼ ì¦ê°€í•©ë‹ˆë‹¤.`)) {
                
                const inventoryItem = inventoryData.find(item => 
                    item.í’ˆëª© === historyItem.í’ˆëª© && item.ìƒì‚°ì‹œì„¤ === historyItem.ìƒì‚°ì‹œì„¤
                );
                
                let restoredQuantity = 0;
                if (inventoryItem) {
                    inventoryItem.ìˆ˜ëŸ‰ += historyItem.ì…ê³ ìˆ˜ëŸ‰;
                    restoredQuantity = inventoryItem.ìˆ˜ëŸ‰;
                }
                
                historyData = historyData.filter(item => item.No !== no);
                
                // Firebaseì—ì„œ ì‚­ì œ
                await deleteHistoryFromFirebase(no);
                await saveInventoryToFirebase();
                
                // localStorage ì—…ë°ì´íŠ¸
                localStorage.setItem('requestHistory', JSON.stringify(historyData));
                localStorage.setItem('inventoryData', JSON.stringify(inventoryData));
                
                renderAllTables();
                
                showStatus(`âœ… ì´ë ¥ì´ ì‚­ì œë˜ê³  "${historyItem.í’ˆëª©}" ìˆ˜ëŸ‰ì´ ${restoredQuantity}ë¡œ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
            }
        }
        
        // ========== ê¸°íƒ€ í•¨ìˆ˜ë“¤ ==========
        
        function syncNow() {
            if (isFirebaseConnected) {
                loadDataFromFirebase();
                showStatus('ìˆ˜ë™ ë™ê¸°í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            } else {
                showStatus('Firebase ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
            }
        }
        
        function getDefaultInventoryData() {
            return [
                {
                    í’ˆëª©: "ì ë³´ë¡¤í™”ì¥ì§€/ì²œì—°í„í”„(ë™ì›)",
                    ê·œê²©: "250M*2ê²¹*16ë¡¤",
                    ìˆ˜ëŸ‰: 100,
                    ë‹¨ìœ„: "ë°•ìŠ¤",
                    ìƒì‚°ì‹œì„¤: "ë™ì›ì§ì—…ì¬í™œì›"
                },
                {
                    í’ˆëª©: "ë¡¤í™”ì¥ì§€(ë™ì›)", 
                    ê·œê²©: "3ê²¹/35m*30ë¡¤",
                    ìˆ˜ëŸ‰: 300,
                    ë‹¨ìœ„: "íŒ©",
                    ìƒì‚°ì‹œì„¤: "ë™ì›ì§ì—…ì¬í™œì›"
                },
                {
                    í’ˆëª©: "ì‚¬ê°í‹°ìŠˆ 250ë§¤(ë™ì›)",
                    ê·œê²©: "1ë°•ìŠ¤(24ê°œì…)",
                    ìˆ˜ëŸ‰: 300,
                    ë‹¨ìœ„: "ë°•ìŠ¤",
                    ìƒì‚°ì‹œì„¤: "ë™ì›ì§ì—…ì¬í™œì›"
                },
                {
                    í’ˆëª©: "ìƒë¶„í•´ë¬¼í‹°ìŠˆ",
                    ê·œê²©: "10ê°œì…/ìº¡í˜•",
                    ìˆ˜ëŸ‰: 240,
                    ë‹¨ìœ„: "ë°•ìŠ¤",
                    ìƒì‚°ì‹œì„¤: "í•™ì‚°ë³´í˜¸ì‘ì—…ì¥"
                },
                {
                    í’ˆëª©: "í”„ë¦¬ë¯¸ì—„",
                    ê·œê²©: "10ê°œì…",
                    ìˆ˜ëŸ‰: 600,
                    ë‹¨ìœ„: "ë°•ìŠ¤",
                    ìƒì‚°ì‹œì„¤: "í•™ì‚°ë³´í˜¸ì‘ì—…ì¥"
                },
                {
                    í’ˆëª©: "ì¢…ì´ì»µ",
                    ê·œê²©: "6.5ì˜¨ìŠ¤",
                    ìˆ˜ëŸ‰: 320,
                    ë‹¨ìœ„: "ë°•ìŠ¤",
                    ìƒì‚°ì‹œì„¤: "ëˆ„ë¦¬ë´„"
                }
            ];
        }
        
        async function resetToDefault() {
            if (!requireOwnerPermission()) return;
            
            if (confirm('âš ï¸ ë³´ê´€í’ˆ ë°ì´í„° ë¦¬ì…‹\n\në³´ê´€í’ˆ ìˆ˜ëŸ‰ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ë˜ëŒë¦½ë‹ˆë‹¤.\n(ì…ê³ ì´ë ¥ì€ ìœ ì§€ë©ë‹ˆë‹¤)\n\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                
                inventoryData = getDefaultInventoryData();
                
                // Firebaseì— ì €ì¥
                await saveInventoryToFirebase();
                localStorage.setItem('inventoryData', JSON.stringify(inventoryData));
                
                lastRegisteredRequest = null;
                
                renderInventoryTable();
                renderRequestTable();
                
                showStatus('âœ… ë³´ê´€í’ˆ ë°ì´í„°ê°€ ê¸°ë³¸ê°’ìœ¼ë¡œ ë¦¬ì…‹ë˜ê³  ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            }
        }
        
        async function clearAllData() {
            if (!requireOwnerPermission()) return;
            
            if (confirm('âš ï¸ ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”\n\në‹¤ìŒ ì‘ì—…ì´ ìˆ˜í–‰ë©ë‹ˆë‹¤:\nâ€¢ ëª¨ë“  ì…ê³  ì´ë ¥ ì‚­ì œ\nâ€¢ ë³´ê´€í’ˆ ìˆ˜ëŸ‰ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ë¦¬ì…‹\nâ€¢ ì €ì¥ëœ ëª¨ë“  ë°ì´í„° ì‚­ì œ\n\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                
                historyData = [];
                historyCounter = 1;
                inventoryData = getDefaultInventoryData();
                
                // Firebase ì´ˆê¸°í™”
                if (isFirebaseConnected) {
                    try {
                        // ëª¨ë“  ì´ë ¥ ë°ì´í„° ì‚­ì œ
                        const historySnapshot = await db.collection('history').get();
                        const batch = db.batch();
                        historySnapshot.docs.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                        await batch.commit();
                        
                        // ì¹´ìš´í„° ë¦¬ì…‹
                        await db.collection('settings').doc('counter').set({ value: 1 });
                        
                        // ë³´ê´€í’ˆ ë°ì´í„° ë¦¬ì…‹
                        await saveInventoryToFirebase();
                    } catch (error) {
                        console.error('Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                    }
                }
                
                // localStorage ì´ˆê¸°í™”
                localStorage.removeItem('requestHistory');
                localStorage.removeItem('historyCounter');
                localStorage.setItem('inventoryData', JSON.stringify(inventoryData));
                
                renderAllTables();
                
                showStatus('âœ… ëª¨ë“  ë°ì´í„°ê°€ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ê³  ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            }
        }
        
        function filterHistory() {
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            
            if (!startDate || !endDate) {
                showStatus('ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            let filteredData = historyData.filter(item => {
                const itemDate = item.ì…ê³ ì¼;
                return itemDate >= startDate && itemDate <= endDate;
            });

            if (currentFacilityFilter) {
                filteredData = filteredData.filter(item => item.ìƒì‚°ì‹œì„¤ === currentFacilityFilter);
            }

            renderHistoryTable(filteredData);
            showStatus(`${filteredData.length}ê±´ì˜ ì´ë ¥ì´ í•„í„°ë§ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        }
        
        function clearFilter() {
            document.getElementById('filterStartDate').value = '';
            document.getElementById('filterEndDate').value = '';
            renderHistoryTable();
            showStatus('í•„í„°ê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }
        
        function printCurrentSheet() {
            const activeSheet = document.querySelector('.sheet-content.active');
            if (!activeSheet) {
                showStatus('ì¸ì‡„í•  ì‹œíŠ¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            updatePrintInfo();
            document.querySelectorAll('.sheet-content').forEach(sheet => {
                sheet.classList.remove('print-target');
            });
            activeSheet.classList.add('print-target');
            window.print();
            showStatus('ì¸ì‡„ ë‹¤ì´ì–¼ë¡œê·¸ê°€ ì—´ë ¸ìŠµë‹ˆë‹¤.', 'success');
        }
        
        function printRequestForm() {
            if (!lastRegisteredRequest || lastRegisteredRequest.items.length === 0) {
                showStatus('ë“±ë¡ëœ ì…ê³  ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì…ê³  ìš”ì²­ì„ ë“±ë¡í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            const requestSheet = document.getElementById('sheet-ì…ê³ ìš”ì²­ì„œ');
            const originalTable = requestSheet.querySelector('.editable-table tbody');
            const originalContent = originalTable.innerHTML;
            
            originalTable.innerHTML = '';
            lastRegisteredRequest.items.forEach(item => {
                const row = document.createElement('tr');
                const remainingClass = item.ì”ëŸ‰ < 0 ? 'negative-value' : '';
                row.innerHTML = `
                    <td>${item.No}</td>
                    <td>${item.ìƒì‚°ì‹œì„¤}</td>
                    <td>${item.í’ˆëª©}</td>
                    <td>${item.ê·œê²©}</td>
                    <td>${item.ì´ˆê¸°ìˆ˜ëŸ‰.toLocaleString()}</td>
                    <td>${item.ì…ê³ ìˆ˜ëŸ‰.toLocaleString()}</td>
                    <td class="${remainingClass}">${item.ì”ëŸ‰.toLocaleString()}</td>
                    <td style="font-size: 10px;">${item.ë“±ë¡ì¼ì‹œ}</td>
                `;
                originalTable.appendChild(row);
            });

            updatePrintInfo();
            document.querySelectorAll('.sheet-content').forEach(sheet => {
                sheet.classList.remove('print-target');
            });
            requestSheet.classList.add('print-target');
            window.print();

            setTimeout(() => {
                originalTable.innerHTML = originalContent;
                requestSheet.classList.remove('print-target');
            }, 100);

            showStatus(`ë§ˆì§€ë§‰ ë“±ë¡ëœ ì…ê³ ìš”ì²­ì„œ ì¸ì‡„ (${lastRegisteredRequest.items.length}ê°œ í’ˆëª©)`, 'success');
        }
        
        function previewPrint() {
            if (!lastRegisteredRequest || lastRegisteredRequest.items.length === 0) {
                showStatus('ë“±ë¡ëœ ì…ê³  ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì…ê³  ìš”ì²­ì„ ë“±ë¡í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            const previewWindow = window.open('', '_blank', 'width=800,height=600');
            
            let previewHtml = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>ì…ê³ ìš”ì²­ì„œ ë¯¸ë¦¬ë³´ê¸°</title>
                    <style>
                        body { font-family: 'Malgun Gothic', Arial, sans-serif; padding: 20px; }
                        .header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 10px; }
                        .info { margin-bottom: 15px; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { border: 1px solid #333; padding: 8px; text-align: center; font-size: 12px; }
                        th { background-color: #f1f3f4; font-weight: bold; }
                        .negative-value { background-color: #fde8e8; color: #c53030; }
                        .footer { text-align: right; margin-top: 30px; }
                        .btn { padding: 10px 20px; margin: 5px; cursor: pointer; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h2>ì…ê³ ìš”ì²­ì„œ</h2>
                    </div>
                    <div class="info">
                        <div>ìƒì‚°ì‹œì„¤: ${lastRegisteredRequest.targetFacility || 'ì „ì²´ ìƒì‚°ì‹œì„¤'}</div>
                        <div>ì…ê³ ìš”ì²­ì¼: ${lastRegisteredRequest.requestDate}</div>
                        <div>ìš”ì²­ê¸°ê´€: ${lastRegisteredRequest.facilityName}</div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>ìƒì‚°ì‹œì„¤</th>
                                <th>í’ˆëª©</th>
                                <th>ê·œê²©</th>
                                <th>ì´ˆê¸°ìˆ˜ëŸ‰</th>
                                <th>ì…ê³ ìˆ˜ëŸ‰</th>
                                <th>ì”ëŸ‰</th>
                                <th>ë“±ë¡ì¼ì‹œ</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            lastRegisteredRequest.items.forEach(item => {
                const remainingClass = item.ì”ëŸ‰ < 0 ? 'negative-value' : '';
                previewHtml += `
                    <tr>
                        <td>${item.No}</td>
                        <td>${item.ìƒì‚°ì‹œì„¤}</td>
                        <td>${item.í’ˆëª©}</td>
                        <td>${item.ê·œê²©}</td>
                        <td>${item.ì´ˆê¸°ìˆ˜ëŸ‰.toLocaleString()}</td>
                        <td>${item.ì…ê³ ìˆ˜ëŸ‰.toLocaleString()}</td>
                        <td class="${remainingClass}">${item.ì”ëŸ‰.toLocaleString()}</td>
                        <td>${item.ë“±ë¡ì¼ì‹œ}</td>
                    </tr>
                `;
            });

            previewHtml += `
                        </tbody>
                    </table>
                    <div class="footer">
                        <div>ë‹´ë‹¹ì: _______________</div>
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn" onclick="window.print()">ì¸ì‡„í•˜ê¸°</button>
                        <button class="btn" onclick="window.close()">ë‹«ê¸°</button>
                    </div>
                </body>
                </html>
            `;

            previewWindow.document.write(previewHtml);
            previewWindow.document.close();
            showStatus('ì¸ì‡„ ë¯¸ë¦¬ë³´ê¸° ì°½ì´ ì—´ë ¸ìŠµë‹ˆë‹¤.', 'success');
        }
        
        function updatePrintInfo() {
            const currentDate = new Date().toLocaleDateString('ko-KR');
            const facilityName = document.getElementById('facilityName').value;
            const requestDate = document.getElementById('requestDate').value;
            const targetFacility = document.getElementById('targetFacility').value;

            document.getElementById('print-date-inventory').textContent = currentDate;
            document.getElementById('print-org-inventory').textContent = facilityName;
            document.getElementById('print-facility-request').textContent = targetFacility || 'ì „ì²´ ìƒì‚°ì‹œì„¤';
            document.getElementById('print-date-request').textContent = requestDate || currentDate;
            document.getElementById('print-org-request').textContent = facilityName;
            document.getElementById('print-date-history').textContent = currentDate;
            document.getElementById('print-org-history').textContent = facilityName;
        }
        
        function exportToExcel() {
            try {
                const wb = XLSX.utils.book_new();
                
                const inventoryWS = XLSX.utils.json_to_sheet(inventoryData);
                XLSX.utils.book_append_sheet(wb, inventoryWS, 'ë³´ê´€í’ˆ');
                
                if (historyData.length > 0) {
                    const historyWS = XLSX.utils.json_to_sheet(historyData);
                    XLSX.utils.book_append_sheet(wb, historyWS, 'ì…ê³ ì´ë ¥');
                }
                
                const fileName = `ì…ê³ ê´€ë¦¬_Auth_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showStatus('ì—‘ì…€ íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                
            } catch (error) {
                console.error('ì—‘ì…€ ë‚´ë³´ë‚´ê¸° ì˜¤ë¥˜:', error);
                showStatus('ì—‘ì…€ ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }
        
        // ========== ì´ˆê¸°í™” ==========
        
        document.addEventListener('DOMContentLoaded', function() {
            setCurrentDate();
            updateFacilityFilterDisplay();
            
            // Firebase ì—°ê²°ì´ ì•ˆ ëœ ê²½ìš° ë¡œì»¬ ë°ì´í„° ë¡œë“œ
            setTimeout(() => {
                if (!isFirebaseConnected && currentUser) {
                    loadDataFromLocalStorage();
                }
            }, 5000);
        });
        
    </script>
</body>
</html>();
                setFirebaseStatus('connected', 'Firebase ì—°ê²°ë¨ (ì‹¤ì‹œê°„ ë™ê¸°í™”)');
                
            } catch (error) {
                console.error('Firebase ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                setFirebaseStatus('error', 'Firebase ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
                loadDataFromLocalStorage();
            }
        }
        
        // Firebaseì— ë³´ê´€í’ˆ ë°ì´í„° ì €ì¥
        async function saveInventoryToFirebase() {
            if (!isFirebaseConnected || !isOwner) return;
            
            try {
                await db.collection('inventory').doc('current').set({
                    items: inventoryData,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                setFirebaseStatus('connected', 'Firebase ì—°ê²°ë¨ (ì €ì¥ë¨)');
                setTimeout(() => {
                    setFirebaseStatus('connected', 'Firebase ì—°ê²°ë¨ (ì‹¤ì‹œê°„ ë™ê¸°í™”)');
                }, 2000);
                
            } catch (error) {
                console.error('Firebase ì €ì¥ ì‹¤íŒ¨:', error);
                showStatus('Firebase ì €ì¥ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }
        
        // Firebaseì— ì…ê³ ì´ë ¥ ì¶”ê°€
        async function addHistoryToFirebase(historyItem) {
            if (!isFirebaseConnected || !isOwner) return;
            
            try {
                await db.collection('history').doc(historyItem.No.toString()).set(historyItem);
                await db.collection('settings').doc('counter').set({ value: historyCounter });
                
            } catch (error) {
                console.error('Firebase ì´ë ¥ ì €ì¥ ì‹¤íŒ¨:', error);
                showStatus('Firebase ì´ë ¥ ì €ì¥ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }
        
        // Firebaseì—ì„œ ì…ê³ ì´ë ¥ ì‚­ì œ
        async function deleteHistoryFromFirebase(no) {
            if (!isFirebaseConnected || !isOwner) return;
            
            try {
                await db.collection('history').doc(no.toString()).delete();
                
            } catch (error) {
                console.error('Firebase ì´ë ¥ ì‚­ì œ ì‹¤íŒ¨:', error);
                showStatus('Firebase ì´ë ¥ ì‚­ì œ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }
        
        // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupRealtimeListeners() {
            if (!isFirebaseConnected) return;
            
            // ë³´ê´€í’ˆ ë°ì´í„° ì‹¤ì‹œê°„ ê°ì§€
            db.collection('inventory').doc('current').onSnapshot((doc) => {
                if (doc.exists) {
                    const newData = doc.data().items || [];
                    if (JSON.stringify(newData) !== JSON.stringify(inventoryData)) {
                        inventoryData = newData;
                        renderInventoryTable();
                        renderRequestTable();
                        showStatus('ë³´ê´€í’ˆ ë°ì´í„°ê°€ ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    }
                }
            }, (error) => {
                console.error('ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì˜¤ë¥˜:', error);
            });
            
            // ì…ê³ ì´ë ¥ ì‹¤ì‹œê°„ ê°ì§€
            db.collection('history').onSnapshot((snapshot) => {
                const newHistoryData = [];
                snapshot.forEach(doc => {
                    newHistoryData.push(doc.data());
                });
                
                newHistoryData.sort((a, b) => a.No - b.No);
                
                if (JSON.stringify(newHistoryData) !== JSON.stringify(historyData)) {
                    historyData = newHistoryData;
                    renderHistoryTable();
                    showStatus('ì…ê³ ì´ë ¥ì´ ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                }
            }, (error) => {
                console.error('ì´ë ¥ ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì˜¤ë¥˜:', error);
            });
        }
        
        // localStorageì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (í´ë°±)
        function loadDataFromLocalStorage() {
            const savedInventory = localStorage.getItem('inventoryData');
            const savedHistory = localStorage.getItem('requestHistory');
            const savedCounter = localStorage.getItem('historyCounter');
            
            if (savedInventory) {
                inventoryData = JSON.parse(savedInventory);
            } else {
                inventoryData = getDefaultInventoryData();
            }
            
            if (savedHistory) {
                historyData = JSON.parse(savedHistory);
            }
            
            if (savedCounter) {
                historyCounter = parseInt(savedCounter);
            }
            
            showLoading(false);
            renderAllTables();
        }
        
        // ========== UI í•¨ìˆ˜ ==========
        
        function showLoading(show) {
            const loadingElements = document.querySelectorAll('.loading');
            const tables = document.querySelectorAll('.editable-table');
            
            loadingElements.forEach(el => {
                el.style.display = show ? 'block' : 'none';
            });
            
            tables.forEach(table => {
                table.style.display = show ? 'none' : 'table';
            });
        }
        
        function getCurrentDateTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            
            return `${year}-${month}-${day} ${hours}:${minutes}`;
        }
        
        function setCurrentDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            
            document.getElementById('requestDate').value = `${year}-${month}-${day}`;
            
            const koreanDate = `${year}ë…„ ${month}ì›” ${day}ì¼`;
            document.getElementById('current-date').textContent = koreanDate;
        }
        
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        }
        
        // Firebase ìƒíƒœ ì—…ë°ì´íŠ¸
        function setFirebaseStatus(status, message) {
            const statusContainer = document.getElementById('firebase-status');
            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');
            const syncInfo = document.getElementById('sync-info');
            
            statusContainer.className = `firebase-status ${status}`;
            statusDot.className = `status-dot ${status}`;
            statusText.textContent = message;
            
            if (status === 'connected') {
                syncInfo.textContent = `ë§ˆì§€ë§‰ ë™ê¸°í™”: ${new Date().toLocaleTimeString()}`;
            } else {
                syncInfo.textContent = 'ë™ê¸°í™” ë¶ˆê°€ (ë¡œì»¬ ëª¨ë“œ)';
            }
        }
        
        function showSheet(sheetName) {
            document.querySelectorAll('.sheet-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.sheet-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`sheet-${sheetName}`).classList.add('active');
        }
        
        function filterByFacility() {
            currentFacilityFilter = document.getElementById('targetFacility').value;
            renderInventoryTable();
            renderRequestTable();
            renderHistoryTable();
            updateFacilityFilterDisplay();
        }
        
        function updateFacilityFilterDisplay() {
            const filterText = currentFacilityFilter 
                ? `<span class="filter-highlight">${currentFacilityFilter}</span>`
                : `<strong>ì „ì²´ ìƒì‚°ì‹œì„¤</strong>`;
            
            ['facilityFilter', 'inventoryFilter', 'historyFilter'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.innerHTML = `í˜„ì¬ í‘œì‹œ: ${filterText}`;
                }
            });
        }
        
        function renderAllTables() {
            renderInventoryTable();
            renderRequestTable();
            renderHistoryTable();
            updateFacilityFilterDisplay();
        }
        
        // ========== í…Œì´ë¸” ë Œë”ë§ í•¨ìˆ˜ë“¤ ==========
        
        function renderInventoryTable() {
            const tbody = document.getElementById('inventory-tbody');
            tbody.innerHTML = '';
            
            const filteredData = currentFacilityFilter 
                ? inventoryData.filter(item => item.ìƒì‚°ì‹œì„¤ === currentFacilityFilter)
                : inventoryData;
            
            if (filteredData.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="5" style="text-align: center; color: #666;">ì„ íƒëœ ìƒì‚°ì‹œì„¤ì— í’ˆëª©ì´ ì—†ìŠµë‹ˆë‹¤.</td>';
                tbody.appendChild(row);
                return;
            }
            
            if (!currentFacilityFilter) {
                const groupedData = filteredData.reduce((groups, item) => {
                    const facility = item.ìƒì‚°ì‹œì„¤;
                    if (!groups[facility]) {
                        groups[facility] = [];
                    }
                    groups[facility].push(item);
                    return groups;
                }, {});

                Object.keys(groupedData).sort().forEach(facility => {
                    const headerRow = document.createElement('tr');
                    headerRow.classList.add('group-header');
                    headerRow.innerHTML = `
                        <td colspan="5" style="text-align: center; padding: 10px;">${facility}</td>
                    `;
                    tbody.appendChild(headerRow);

                    groupedData[facility].forEach((item) => {
                        const globalIndex = inventoryData.indexOf(item);
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${item.ìƒì‚°ì‹œì„¤}</td>
                            <td>${item.í’ˆëª©}</td>
                            <td>${item.ê·œê²©}</td>
                            <td>
                                <input type="number" class="editable-input" value="${item.ìˆ˜ëŸ‰}" 
                                       onchange="updateInventoryQuantity(${globalIndex}, this.value)" style="text-align: center;"
                                       ${!isOwner ? 'disabled' : ''}>
                            </td>
                            <td>${item.ë‹¨ìœ„}</td>
                        `;
                        tbody.appendChild(row);
                    });
                });
            } else {
                filteredData.forEach((item) => {
                    const globalIndex = inventoryData.indexOf(item);
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.ìƒì‚°ì‹œì„¤}</td>
                        <td>${item.í’ˆëª©}</td>
                        <td>${item.ê·œê²©}</td>
                        <td>
                            <input type="number" class="editable-input" value="${item.ìˆ˜ëŸ‰}" 
                                   onchange="updateInventoryQuantity(${globalIndex}, this.value)" style="text-align: center;"
                                   ${!isOwner ? 'disabled' : ''}>
                        </td>
                        <td>${item.ë‹¨ìœ„}</td>
                    `;
                    tbody.appendChild(row);
                });
            }
        }
        
        function renderRequestTable() {
            const tbody = document.getElementById('request-tbody');
            tbody.innerHTML = '';
            
            const filteredData = currentFacilityFilter 
                ? inventoryData.filter(item => item.ìƒì‚°ì‹œì„¤ === currentFacilityFilter)
                : inventoryData;

            if (filteredData.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="8" style="text-align: center; color: #666;">ì„ íƒëœ ìƒì‚°ì‹œì„¤ì— í’ˆëª©ì´ ì—†ìŠµë‹ˆë‹¤.</td>';
                tbody.appendChild(row);
                return;
            }

            if (!currentFacilityFilter) {
                const groupedData = filteredData.reduce((groups, item) => {
                    const facility = item.ìƒì‚°ì‹œì„¤;
                    if (!groups[facility]) {
                        groups[facility] = [];
                    }
                    groups[facility].push(item);
                    return groups;
                }, {});

                let rowCounter = 1;
                Object.keys(groupedData).sort().forEach(facility => {
                    const headerRow = document.createElement('tr');
                    headerRow.classList.add('group-header');
                    headerRow.innerHTML = `
                        <td colspan="8" style="text-align: center; padding: 8px;">${facility}</td>
                    `;
                    tbody.appendChild(headerRow);

                    groupedData[facility].forEach((item) => {
                        const globalIndex = inventoryData.indexOf(item);
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${rowCounter++}</td>
                            <td>${item.ìƒì‚°ì‹œì„¤}</td>
                            <td>${item.í’ˆëª©}</td>
                            <td>${item.ê·œê²©}</td>
                            <td class="calculated-cell">${item.ìˆ˜ëŸ‰.toLocaleString()}</td>
                            <td>
                                <input type="number" class="editable-input" placeholder="0" 
                                       id="request-${globalIndex}" onchange="calculateRemaining(${globalIndex})" style="text-align: center;"
                                       ${!isOwner ? 'disabled' : ''}>
                            </td>
                            <td id="remaining-${globalIndex}" class="calculated-cell">-</td>
                            <td style="font-size: 10px; color: #666;">${getCurrentDateTime()}</td>
                        `;
                        tbody.appendChild(row);
                    });
                });
            } else {
                filteredData.forEach((item, index) => {
                    const globalIndex = inventoryData.indexOf(item);
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${item.ìƒì‚°ì‹œì„¤}</td>
                        <td>${item.í’ˆëª©}</td>
                        <td>${item.ê·œê²©}</td>
                        <td class="calculated-cell">${item.ìˆ˜ëŸ‰.toLocaleString()}</td>
                        <td>
                            <input type="number" class="editable-input" placeholder="0" 
                                   id="request-${globalIndex}" onchange="calculateRemaining(${globalIndex})" style="text-align: center;"
                                   ${!isOwner ? 'disabled' : ''}>
                        </td>
                        <td id="remaining-${globalIndex}" class="calculated-cell">-</td>
                        <td style="font-size: 10px; color: #666;">${getCurrentDateTime()}</td>
                    `;
                    tbody.appendChild(row);
                });
            }
        }
        
        function renderHistoryTable(dataToRender = null) {
            const tbody = document.getElementById('history-tbody');
            tbody.innerHTML = '';
            
            let data = dataToRender || historyData;
            
            if (currentFacilityFilter) {
                data = data.filter(item => item.ìƒì‚°ì‹œì„¤ === currentFacilityFilter);
            }
            
            data.forEach((item, index) => {
                const row = document.createElement('tr');
                const remainingClass = item.ì”ëŸ‰ < 0 ? 'negative-value' : '';
                
                row.innerHTML = `
                    <td>${item.No}</td>
                    <td>${item.ì…ê³ ì¼}</td>
                    <td>${item.ìƒì‚°ì‹œì„¤}</td>
                    <td>${item.ìš”ì²­ê¸°ê´€ || '-'}</td>
                    <td>${item.í’ˆëª©}</td>
                    <td>${item.ì…ê³ ìˆ˜ëŸ‰.toLocaleString()}</td>
                    <td>${item.ì´ˆê¸°ìˆ˜ëŸ‰.toLocaleString()}</td>
                    <td class="${remainingClass}">${item.ì”ëŸ‰.toLocaleString()}</td>
                    <td style="font-size: 10px; color: #666;">${item.ë“±ë¡ì¼ì‹œ || '-'}</td>
                    <td>
                        ${isOwner ? `<button class="btn btn-danger" onclick="deleteHistory(${item.No})" style="padding: 4px 8px; font-size: 10px;">ì‚­ì œ</button>` : '-'}
                    </td>
                `;
                tbody.appendChild(row);
            });

            if (data.length === 0) {
                const emptyMessage = currentFacilityFilter 
                    ? `ì„ íƒëœ ìƒì‚°ì‹œì„¤(${currentFacilityFilter})ì˜ ì…ê³  ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.`
                    : 'ë“±ë¡ëœ ì…ê³  ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.';
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="10" style="text-align: center; color: #666;">${emptyMessage}</td>`;
                tbody.appendChild(row);
            }
        }
        
        // ========== ê¶Œí•œ í™•ì¸ í•¨ìˆ˜ ==========
        
        function requireOwnerPermission() {
            if (!isOwner) {
                showStatus('âš ï¸ ê´€ë¦¬ìë§Œ ì´ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'error');
                return false;
            }
            return true;
        }
        
        // ========== ë°ì´í„° ì¡°ì‘ í•¨ìˆ˜ë“¤ ==========
        
        async function updateInventoryQuantity(index, newValue) {
            if (!requireOwnerPermission()) return;
            
            const oldValue = inventoryData[index].ìˆ˜ëŸ‰;
            const newQuantity = parseInt(newValue) || 0;
            
            inventoryData[index].ìˆ˜ëŸ‰ = newQuantity;
            
            // Firebaseì— ì €ì¥
            await saveInventoryToFirebase();
            
            // localStorageì—ë„ ë°±ì—… ì €ì¥
            localStorage.setItem('inventoryData', JSON.stringify(inventoryData));
            
            renderRequestTable();
            
            const item = inventoryData[index];
            showStatus(`âœ… "${item.í’ˆëª©}" ìˆ˜ëŸ‰ì´ ${oldValue} â†’ ${newQuantity}ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        }
        
        function calculateRemaining(index) {
            const requestInput = document.getElementById(`request-${index}`);
            const remainingCell = document.getElementById(`remaining-${index}`);
            
            if (!requestInput || !remainingCell) return;
            
            const requestQuantity = parseInt(requestInput.value) || 0;
            const currentInventoryQuantity = inventoryData[index].ìˆ˜ëŸ‰;
            const remaining = currentInventoryQuantity - requestQuantity;
            
            remainingCell.textContent = remaining.toLocaleString();
            remainingCell.className = remaining < 0 ? 'calculated-cell negative-value' : 'calculated-cell';
            
            if (remaining < 0) {
                remainingCell.title = `âš ï¸ í˜„ì¬ ë³´ìœ ëŸ‰(${currentInventoryQuantity})ë³´ë‹¤ ${Math.abs(remaining)}ê°œ ë¶€ì¡±í•©ë‹ˆë‹¤.`;
            } else {
                remainingCell.title = `ì…ê³  í›„ ì˜ˆìƒ ì”ëŸ‰: ${remaining}`;
            }
        }
        
        async function addRequestHistory() {
            if (!requireOwnerPermission()) return;
            
            const facilityName = document.getElementById('facilityName').value;
            const requestDate = document.getElementById('requestDate').value;
            const targetFacility = document.getElementById('targetFacility').value;
            
            if (!facilityName || !requestDate) {
                showStatus('ìš”ì²­ ê¸°ê´€ëª…ê³¼ ì…ê³ ìš”ì²­ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            let hasRequests = false;
            let requestCount = 0;
            let updatedItems = [];
            let registeredItems = [];
            
            const dataToProcess = targetFacility 
                ? inventoryData.filter(item => item.ìƒì‚°ì‹œì„¤ === targetFacility)
                : inventoryData;

            // ë¨¼ì € ë¡œì»¬ì—ì„œ ì²˜ë¦¬
            dataToProcess.forEach((item) => {
                const globalIndex = inventoryData.indexOf(item);
                const requestInput = document.getElementById(`request-${globalIndex}`);
                const requestQuantity = parseInt(requestInput?.value) || 0;
                
                if (requestQuantity > 0) {
                    hasRequests = true;
                    requestCount++;
                    
                    const previousQuantity = item.ìˆ˜ëŸ‰;
                    const remaining = item.ìˆ˜ëŸ‰ - requestQuantity;
                    
                    const historyItem = {
                        No: historyCounter++,
                        ì…ê³ ì¼: requestDate,
                        ìƒì‚°ì‹œì„¤: item.ìƒì‚°ì‹œì„¤,
                        ìš”ì²­ê¸°ê´€: facilityName,
                        í’ˆëª©: item.í’ˆëª©,
                        ì…ê³ ìˆ˜ëŸ‰: requestQuantity,
                        ì´ˆê¸°ìˆ˜ëŸ‰: previousQuantity,
                        ì”ëŸ‰: remaining,
                        ë“±ë¡ì¼ì‹œ: getCurrentDateTime()
                    };
                    
                    historyData.push(historyItem);
                    inventoryData[globalIndex].ìˆ˜ëŸ‰ = remaining;
                    
                    // Firebaseì— ì €ì¥
                    addHistoryToFirebase(historyItem);
                    
                    updatedItems.push({
                        í’ˆëª©: item.í’ˆëª©,
                        ìƒì‚°ì‹œì„¤: item.ìƒì‚°ì‹œì„¤,
                        ì…ê³ ì „ìˆ˜ëŸ‰: previousQuantity,
                        ì…ê³ ìˆ˜ëŸ‰: requestQuantity,
                        ì…ê³ í›„ìˆ˜ëŸ‰: remaining
                    });

                    registeredItems.push({
                        No: registeredItems.length + 1,
                        ìƒì‚°ì‹œì„¤: item.ìƒì‚°ì‹œì„¤,
                        í’ˆëª©: item.í’ˆëª©,
                        ê·œê²©: item.ê·œê²©,
                        ì´ˆê¸°ìˆ˜ëŸ‰: previousQuantity,
                        ì…ê³ ìˆ˜ëŸ‰: requestQuantity,
                        ì”ëŸ‰: remaining,
                        ë“±ë¡ì¼ì‹œ: getCurrentDateTime()
                    });
                    
                    if (requestInput) {
                        requestInput.value = '';
                    }
                    const remainingCell = document.getElementById(`remaining-${globalIndex}`);
                    if (remainingCell) {
                        remainingCell.textContent = '-';
                        remainingCell.className = 'calculated-cell';
                    }
                }
            });

            if (!hasRequests) {
                showStatus('ì…ê³ ìˆ˜ëŸ‰ì„ 1ê°œ ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            lastRegisteredRequest = {
                facilityName: facilityName,
                requestDate: requestDate,
                targetFacility: targetFacility,
                items: registeredItems
            };

            // Firebaseì™€ localStorageì— ì €ì¥
            await saveInventoryToFirebase();
            localStorage.setItem('requestHistory', JSON.stringify(historyData));
            localStorage.setItem('historyCounter', historyCounter.toString());
            localStorage.setItem('inventoryData', JSON.stringify(inventoryData));
            
            renderAllTables